<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Schrödinger Equation: A PDE System with Resampling · Sophon.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://YichengDWu.github.io/Sophon.jl/tutorials/SchrödingerEquation/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/indigo.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Sophon.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../discontinuous/">Fitting a nonlinear discontinuous function</a></li><li><a class="tocitem" href="../poisson/">1D Multi-scale Poisson&#39;s Equation</a></li><li><a class="tocitem" href="../convection/">1D Convection Equation</a></li><li><a class="tocitem" href="../helmholtz/">2D Helmholtz Equation</a></li><li><a class="tocitem" href="../allen_cahn/">Allen-Cahn Equation with Sequential Training</a></li><li class="is-active"><a class="tocitem" href>Schrödinger Equation: A PDE System with Resampling</a><ul class="internal"><li><a class="tocitem" href="#Customize-Sampling"><span>Customize Sampling</span></a></li></ul></li><li><a class="tocitem" href="../L_shape/">Poisson equation over an L-shaped domain</a></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/YichengDWu/Sophon.jl/blob/main/docs/src/tutorials/SchrödingerEquation.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Schrödinger-equation"><a class="docs-heading-anchor" href="#Schrödinger-equation">Schrödinger equation</a><a id="Schrödinger-equation-1"></a><a class="docs-heading-anchor-permalink" href="#Schrödinger-equation" title="Permalink"></a></h1><p>The nonlinear Shrödinger equation is given by</p><p class="math-container">\[\mathrm{i} \partial_t \psi=-\frac{1}{2} \sigma \partial_{x x} \psi-\beta|\psi|^2 \psi\]</p><p>Let <span>$\sigma=\beta=1, \psi=u+v i$</span>, the equation can be transformed into a system of partial differential equations</p><pre><code class="language-julia hljs">using ModelingToolkit, IntervalSets, Sophon, CairoMakie
using Optimization, OptimizationOptimJL

@parameters x,t
@variables u(..), v(..)
Dₜ = Differential(t)
Dₓ² = Differential(x)^2

eqs=[Dₜ(u(x,t)) ~ -Dₓ²(v(x,t))/2 - (abs2(v(x,t)) + abs2(u(x,t))) * v(x,t),
     Dₜ(v(x,t)) ~  Dₓ²(u(x,t))/2 + (abs2(v(x,t)) + abs2(u(x,t))) * u(x,t)]

bcs = [u(x, 0.0) ~ 2sech(x),
       v(x, 0.0) ~ 0.0,
       u(-5.0, t) ~ u(5.0, t),
       v(-5.0, t) ~ v(5.0, t)]

domains = [x ∈ Interval(-5.0, 5.0),
           t ∈ Interval(0.0, π/2)]

@named pde_system = PDESystem(eqs, bcs, domains, [x,t], [u(x,t),v(x,t)])</code></pre><p class="math-container">\[ \begin{align}
\frac{\mathrm{d}}{\mathrm{d}t} u\left( x, t \right) =&amp;  - \frac{1}{2} \frac{\mathrm{d}^{2}}{\mathrm{d}x^{2}} v\left( x, t \right) - \left( \left|u\left( x, t \right)\right|^{2} + \left|v\left( x, t \right)\right|^{2} \right) v\left( x, t \right) \\
\frac{\mathrm{d}}{\mathrm{d}t} v\left( x, t \right) =&amp; \frac{1}{2} \frac{\mathrm{d}^{2}}{\mathrm{d}x^{2}} u\left( x, t \right) + \left( \left|u\left( x, t \right)\right|^{2} + \left|v\left( x, t \right)\right|^{2} \right) u\left( x, t \right)
\end{align}
 \]</p><pre><code class="language-julia hljs">pinn = PINN(u = Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0),
            v = Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0))

sampler = QuasiRandomSampler(500, (200,200,20,20))
strategy = NonAdaptiveTraining(1,(10,10,1,1))

prob = Sophon.discretize(pde_system, pinn, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [-0.41119295358657837 0.3334078788757324; 0.4400262236595154 -0.4928532838821411; … ; 0.02661120891571045 -0.4303809404373169; -0.42964816093444824 -0.026395320892333984], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [-0.47956663370132446 -0.34242022037506104 … 0.028541143983602524 0.1696980744600296; -0.20298446714878082 0.10714586824178696 … -0.42498579621315 0.5978664755821228; … ; 0.26784875988960266 -0.580569863319397 … 0.3880750834941864 0.10757452994585037; 0.4780590236186981 0.1976698935031891 … 0.32298046350479126 -0.17142798006534576], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [0.3879508376121521 0.37093842029571533 … 0.18991504609584808 0.3760821223258972; -0.20062977075576782 -0.502830445766449 … -0.06785248219966888 -0.32075396180152893; … ; 0.10878407210111618 -0.21227560937404633 … 0.4288040101528168 0.5097975730895996; 0.04717458784580231 0.4185711741447449 … 0.0676090270280838 0.29268673062324524], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [-0.3930535614490509 -0.2726021707057953 … -0.1066758930683136 0.08196968585252762; 0.5858554840087891 -0.06359787285327911 … 0.30254918336868286 -0.3995230793952942; … ; -0.032003629952669144 0.19512999057769775 … 0.23650096356868744 -0.32081088423728943; -0.4627825915813446 0.48183149099349976 … 0.3045949935913086 0.12911660969257355], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [-0.34569230675697327 0.11456680297851562 … -0.055725280195474625 0.4282490611076355], bias = [0.0;;])), v = (layer_1 = (weight = [0.49618786573410034 0.07803082466125488; -0.4203701615333557 -0.27862000465393066; … ; -0.1672896146774292 -0.23963993787765503; -0.3085273504257202 0.3909114599227905], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [0.24747015535831451 -0.3094872832298279 … 0.30782511830329895 0.39272236824035645; -0.5062481164932251 0.6037180423736572 … -0.3435882031917572 0.4582943022251129; … ; 0.3370600640773773 -0.5730921626091003 … -0.36590826511383057 0.4380926489830017; 0.2269708216190338 0.12707945704460144 … 0.07299339771270752 -0.5206232666969299], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [0.450499027967453 0.5400302410125732 … 0.13780854642391205 0.5170930624008179; -0.5898820161819458 -0.4967772960662842 … -0.6103392839431763 -0.45162710547447205; … ; 0.24601906538009644 -0.4695763885974884 … -0.21288268268108368 0.4955473244190216; -0.24013784527778625 0.15443207323551178 … -0.5072243213653564 0.37224215269088745], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [0.36824244260787964 0.2903324067592621 … 0.265162855386734 0.03569314628839493; -0.4073498249053955 0.18404217064380646 … -0.44621723890304565 -0.19219645857810974; … ; -0.2705388367176056 0.5169215202331543 … 0.5731022357940674 -0.032685235142707825; -0.10794778168201447 -0.28614625334739685 … -0.33443111181259155 -0.5207957029342651], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [0.5597959756851196 -0.5860251188278198 … 0.4350103735923767 -0.31624457240104675], bias = [0.0;;])))</code></pre><p>Now we train the neural nets and resample data while training.</p><pre><code class="language-julia hljs">function train(pde_system, prob, sampler, strategy, resample_period = 500, n=10)
     bfgs = BFGS()
     res = Optimization.solve(prob, bfgs; maxiters=2000)

     for i in 1:n
         data = Sophon.sample(pde_system, sampler, strategy)
         prob = remake(prob; u0=res.u, p=data)
         res = Optimization.solve(prob, bfgs; maxiters=resample_period)
     end
     return res
end

res = train(pde_system, prob, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">u: ComponentVector{Float64}(u = (layer_1 = (weight = [-0.39333182434957303 0.48058367207949626; 0.3883712139947016 -0.5808731627982006; … ; 0.4426231319563777 -0.067724867861379; -0.4553951092034918 -0.19684562326836585], bias = [-0.06925462115890109; 0.2817682218661961; … ; 0.14166277613737147; 0.15267890533223027;;]), layer_2 = (weight = [-0.4097272525652613 -0.1929951862200283 … -0.011913855916831481 0.1363433070421695; -0.17052544738745287 0.05093229853120833 … -0.5248985072656588 0.594076603631908; … ; 0.3991057364710776 -0.7861087561705113 … 0.03371169851116855 0.37016698936823533; 0.34438495627978694 0.3897198803053746 … 0.2963585804130474 -0.28089125215452065], bias = [0.15455146610796539; 0.005423916746409748; … ; 0.005061718371347833; 0.03779944507952208;;]), layer_3 = (weight = [0.31013682753573235 0.25855770346987644 … -0.0018471808176272093 0.15246524534721975; -0.007916241070870609 -0.6903329733131686 … 0.11758717976888394 -0.4825028772249103; … ; 0.01663202634899631 0.1932303480506565 … 0.379150263493232 0.21335140626255042; 0.23417105255110812 0.5295635370506305 … -0.0012473564180167133 0.1851514821709086], bias = [0.025329430031981397; -0.10157156638947068; … ; 0.07720647945292564; -0.28008683112357363;;]), layer_4 = (weight = [-0.5064803998583538 0.006266809173465107 … 0.05982768415881457 -0.4748145729605105; 0.45623193659837696 -0.2595480444549095 … 0.7743745054799825 0.35357465003263217; … ; 0.177379415069915 0.39904813907277137 … 0.21633373235648243 -0.5110793034291675; -0.5760680317163399 0.45317366863601816 … 0.08824235776413351 0.3796434606405858], bias = [-0.31357058003963934; -0.1332216502528297; … ; 0.42090230801443707; -0.199534753476935;;]), layer_5 = (weight = [-0.8166950709233874 0.0799285325689141 … -0.5904834950289504 0.5409334664639944], bias = [0.11072657171104425;;])), v = (layer_1 = (weight = [0.48664656564680936 0.25385554631484764; -1.1412164066134602 -0.15139528044858885; … ; -0.36326365278089817 -0.229161777692577; -0.3863606198408282 0.5823293371586554], bias = [-0.20007058068585978; 0.05836119302885386; … ; 0.40981667963976176; -0.06455451487773639;;]), layer_2 = (weight = [0.20452061683692227 -0.620771168251618 … 0.11596226172268563 0.8911997439734214; -0.3189670412411626 0.5031978778630157 … -0.459780917593 0.48579693349741837; … ; 0.23076991748661418 -0.5940637715195335 … -0.2042973861606994 0.6119746362605886; 0.22775406713399862 -0.23351052292753552 … 0.15725803061456609 -0.6335885409935681], bias = [0.3623489835237639; 0.07073660945895344; … ; -0.052258089619876456; -0.08882326510548118;;]), layer_3 = (weight = [0.26156902654901454 0.696656195310961 … -0.1468171608531688 0.31607459079991607; -0.21924950892238723 -0.5703627320435719 … -0.2305716061993955 -0.5918173953135463; … ; 0.8543142138682738 -0.5687191615491493 … -0.17331978422760083 -0.002867538433730266; -0.06978794772152996 -0.011181082613725263 … -0.36001884537628126 0.3339977419917298], bias = [-0.02880775048121613; 0.24448298990637599; … ; 0.07306532414706762; -0.22097077888658975;;]), layer_4 = (weight = [0.0376323111754925 0.5353540661642378 … 0.5485587891161435 0.12136917521891638; -0.6625453434525568 -0.03486451354476894 … -0.2862947870355609 0.10189687297041648; … ; -0.3926526801873389 0.31205178448017284 … 0.17335802603076242 -0.5138544932380436; -0.12412608835010716 -0.2935772037954958 … -0.2956958956989516 -0.2178912799672792], bias = [-0.27675833230089336; 0.1903460596017772; … ; 0.3361604954688481; 0.12391837533493942;;]), layer_5 = (weight = [0.5150292454122996 -0.599300207278992 … 0.7280910662121021 -0.9449673718376093], bias = [-0.06689951019179817;;])))</code></pre><pre><code class="language-julia hljs">phi = pinn.phi
ps = res.u

xs, ts= [infimum(d.domain):0.01:supremum(d.domain) for d in pde_system.domain]

u = [sum(phi.u(([x,t]), ps.u)) for x in xs, t in ts]
v = [sum(phi.v(([x,t]), ps.v)) for x in xs, t in ts]
ψ = @. sqrt(u^2+ v^2)

axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;u&quot;)
fig, ax1, hm1 = heatmap(ts, xs, u&#39;, axis=axis)
ax2, hm2= heatmap(fig[1, end+1], ts, xs, v&#39;, axis= merge(axis, (; title=&quot;v&quot;)))
display(fig)</code></pre><p><img src="../uv.png" alt/></p><pre><code class="language-julia hljs">axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;ψ&quot;)
fig, ax1, hm1 = heatmap(ts, xs, ψ&#39;, axis=axis, colormap=:jet)
Colorbar(fig[:, end+1], hm1)
display(fig)</code></pre><p><img src="../phi.png" alt/></p><h2 id="Customize-Sampling"><a class="docs-heading-anchor" href="#Customize-Sampling">Customize Sampling</a><a id="Customize-Sampling-1"></a><a class="docs-heading-anchor-permalink" href="#Customize-Sampling" title="Permalink"></a></h2><p>Bascially any sampling method is supportted.</p><pre><code class="language-julia hljs">using StatsBase

data = vec([[x, t] for x in xs, t in ts])
wv = vec(ψ)
new_data = wsample(data, wv, 500)
new_data = reduce(hcat, new_data)
fig, ax = scatter(new_data[2,:], new_data[1,:])</code></pre><p><img src="../data.png" alt/></p><pre><code class="language-julia hljs">prob.p[1] = new_data
prob.p[2] = new_data
prob = remake(prob; u0 = res.u)
# res = Optimization.solve(prob, bfgs; maxiters=1000)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [-0.39333182434957303 0.48058367207949626; 0.3883712139947016 -0.5808731627982006; … ; 0.4426231319563777 -0.067724867861379; -0.4553951092034918 -0.19684562326836585], bias = [-0.06925462115890109; 0.2817682218661961; … ; 0.14166277613737147; 0.15267890533223027;;]), layer_2 = (weight = [-0.4097272525652613 -0.1929951862200283 … -0.011913855916831481 0.1363433070421695; -0.17052544738745287 0.05093229853120833 … -0.5248985072656588 0.594076603631908; … ; 0.3991057364710776 -0.7861087561705113 … 0.03371169851116855 0.37016698936823533; 0.34438495627978694 0.3897198803053746 … 0.2963585804130474 -0.28089125215452065], bias = [0.15455146610796539; 0.005423916746409748; … ; 0.005061718371347833; 0.03779944507952208;;]), layer_3 = (weight = [0.31013682753573235 0.25855770346987644 … -0.0018471808176272093 0.15246524534721975; -0.007916241070870609 -0.6903329733131686 … 0.11758717976888394 -0.4825028772249103; … ; 0.01663202634899631 0.1932303480506565 … 0.379150263493232 0.21335140626255042; 0.23417105255110812 0.5295635370506305 … -0.0012473564180167133 0.1851514821709086], bias = [0.025329430031981397; -0.10157156638947068; … ; 0.07720647945292564; -0.28008683112357363;;]), layer_4 = (weight = [-0.5064803998583538 0.006266809173465107 … 0.05982768415881457 -0.4748145729605105; 0.45623193659837696 -0.2595480444549095 … 0.7743745054799825 0.35357465003263217; … ; 0.177379415069915 0.39904813907277137 … 0.21633373235648243 -0.5110793034291675; -0.5760680317163399 0.45317366863601816 … 0.08824235776413351 0.3796434606405858], bias = [-0.31357058003963934; -0.1332216502528297; … ; 0.42090230801443707; -0.199534753476935;;]), layer_5 = (weight = [-0.8166950709233874 0.0799285325689141 … -0.5904834950289504 0.5409334664639944], bias = [0.11072657171104425;;])), v = (layer_1 = (weight = [0.48664656564680936 0.25385554631484764; -1.1412164066134602 -0.15139528044858885; … ; -0.36326365278089817 -0.229161777692577; -0.3863606198408282 0.5823293371586554], bias = [-0.20007058068585978; 0.05836119302885386; … ; 0.40981667963976176; -0.06455451487773639;;]), layer_2 = (weight = [0.20452061683692227 -0.620771168251618 … 0.11596226172268563 0.8911997439734214; -0.3189670412411626 0.5031978778630157 … -0.459780917593 0.48579693349741837; … ; 0.23076991748661418 -0.5940637715195335 … -0.2042973861606994 0.6119746362605886; 0.22775406713399862 -0.23351052292753552 … 0.15725803061456609 -0.6335885409935681], bias = [0.3623489835237639; 0.07073660945895344; … ; -0.052258089619876456; -0.08882326510548118;;]), layer_3 = (weight = [0.26156902654901454 0.696656195310961 … -0.1468171608531688 0.31607459079991607; -0.21924950892238723 -0.5703627320435719 … -0.2305716061993955 -0.5918173953135463; … ; 0.8543142138682738 -0.5687191615491493 … -0.17331978422760083 -0.002867538433730266; -0.06978794772152996 -0.011181082613725263 … -0.36001884537628126 0.3339977419917298], bias = [-0.02880775048121613; 0.24448298990637599; … ; 0.07306532414706762; -0.22097077888658975;;]), layer_4 = (weight = [0.0376323111754925 0.5353540661642378 … 0.5485587891161435 0.12136917521891638; -0.6625453434525568 -0.03486451354476894 … -0.2862947870355609 0.10189687297041648; … ; -0.3926526801873389 0.31205178448017284 … 0.17335802603076242 -0.5138544932380436; -0.12412608835010716 -0.2935772037954958 … -0.2956958956989516 -0.2178912799672792], bias = [-0.27675833230089336; 0.1903460596017772; … ; 0.3361604954688481; 0.12391837533493942;;]), layer_5 = (weight = [0.5150292454122996 -0.599300207278992 … 0.7280910662121021 -0.9449673718376093], bias = [-0.06689951019179817;;])))</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../allen_cahn/">« Allen-Cahn Equation with Sequential Training</a><a class="docs-footer-nextpage" href="../L_shape/">Poisson equation over an L-shaped domain »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Wednesday 19 October 2022 09:22">Wednesday 19 October 2022</span>. Using Julia version 1.8.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
