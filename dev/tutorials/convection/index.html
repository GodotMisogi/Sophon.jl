<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>1D Convection Equation · Sophon.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://YichengDWu.github.io/Sophon.jl/tutorials/convection/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/indigo.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Sophon.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../discontinuous/">Fitting a nonlinear discontinuous function</a></li><li><a class="tocitem" href="../poisson/">1D Poisson&#39;s Equation</a></li><li class="is-active"><a class="tocitem" href>1D Convection Equation</a><ul class="internal"><li><a class="tocitem" href="#Imposing-periodic-boundary-conditions"><span>Imposing periodic boundary conditions</span></a></li><li><a class="tocitem" href="#Respecting-Causality-is-all-you-need"><span>Respecting Causality is all you need</span></a></li></ul></li><li><a class="tocitem" href="../helmholtz/">2D Helmholtz Equation</a></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>1D Convection Equation</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>1D Convection Equation</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/YichengDWu/Sophon.jl/blob/main/docs/src/tutorials/convection.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="D-Convection-Equation"><a class="docs-heading-anchor" href="#D-Convection-Equation">1D Convection Equation</a><a id="D-Convection-Equation-1"></a><a class="docs-heading-anchor-permalink" href="#D-Convection-Equation" title="Permalink"></a></h1><p>Consider the following 1D-convection equation with periodic boundary conditions.</p><p class="math-container">\[\begin{aligned}
&amp;\frac{\partial u}{\partial t}+c \frac{\partial u}{\partial x}=0, x \in[0,1], t \in[0,1] \\
&amp;u(x, 0)=sin(2\pi x) \\
\end{aligned}\]</p><p>First we define the PDE.</p><pre><code class="language-julia hljs">using NeuralPDE, Lux, Random, Sophon, IntervalSets, CairoMakie
using Optimization, OptimizationOptimJL, OptimizationOptimisers
using CUDA
CUDA.allowscalar(false)

@parameters x, t
@variables u(..)
Dₜ = Differential(t)
Dₓ = Differential(x)

c = 4
eq = Dₜ(u(x,t)) + c * Dₓ(u(x,t)) ~ 0
u_analytic(x,t) = sin(2π*(x-c*t))

domains = [x ∈ 0..1, t ∈ 0..1]

bcs = [u(x,0) ~ u_analytic(x,0)]

@named convection = PDESystem(eq, bcs, domains, [x,t], [u(x,t)])</code></pre><p class="math-container">\[ \begin{align}
4 \mathrm{\frac{d}{d x}}\left( u\left( x, t \right) \right) + \mathrm{\frac{d}{d t}}\left( u\left( x, t \right) \right) =&amp; 0
\end{align}
 \]</p><h2 id="Imposing-periodic-boundary-conditions"><a class="docs-heading-anchor" href="#Imposing-periodic-boundary-conditions">Imposing periodic boundary conditions</a><a id="Imposing-periodic-boundary-conditions-1"></a><a class="docs-heading-anchor-permalink" href="#Imposing-periodic-boundary-conditions" title="Permalink"></a></h2><p>We will use <a href="tutorials/@ref"><code>BACON</code></a> to impose the boundary conditions. To this end, we simply set <code>period</code> to be one.</p><pre><code class="language-julia hljs">chain = BACON(2,1; hidden_dims = 32, num_layers=5, period = 1, N = 5)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">MultiplicativeFilterNet(
    filters = BranchLayer(
        filter_1 = DiscreteFourierFeature(2 =&gt; 32),  # 32 parameters, plus 64
        filter_2 = DiscreteFourierFeature(2 =&gt; 32),  # 32 parameters, plus 64
        filter_3 = DiscreteFourierFeature(2 =&gt; 32),  # 32 parameters, plus 64
        filter_4 = DiscreteFourierFeature(2 =&gt; 32),  # 32 parameters, plus 64
        filter_5 = DiscreteFourierFeature(2 =&gt; 32),  # 32 parameters, plus 64
    ),
    linear_layers = PairwiseFusion(
        Base.Broadcast.BroadcastFunction{typeof(*)}(*)
        layer_1 = Dense(32 =&gt; 32),      # 1_056 parameters
        layer_2 = Dense(32 =&gt; 32),      # 1_056 parameters
        layer_3 = Dense(32 =&gt; 32),      # 1_056 parameters
        layer_4 = Dense(32 =&gt; 32),      # 1_056 parameters
    ),
    output_layer = Dense(32 =&gt; 1),      # 33 parameters
)         # Total: 4_417 parameters,
          #        plus 320 states, summarysize 240 bytes.</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>For demonstration purposes, the model is also periodic in time</p></div></div><pre><code class="language-julia hljs">discretization = PhysicsInformedNN(chain, QuasiRandomTraining(300); adaptive_loss = NonAdaptiveLoss(; bc_loss_weights = [100]))
prob = discretize(convection, discretization)

@time res = Optimization.solve(prob, Adam(); maxiters = 2000)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">u: ComponentVector{Float64}(filters = (filter_1 = (bias = [0.8035657892681157; 1.300262646696077; … ; 0.0910532458514286; 0.616977474190577;;]), filter_2 = (bias = [-2.493891357107652; 1.9567856237272532; … ; 1.1684702187388518; 2.559739181291995;;]), filter_3 = (bias = [0.29955500133069274; 1.1413450153276374; … ; 0.5172592509238018; 1.457228699095939;;]), filter_4 = (bias = [1.9050253115816416; 0.28472528457665036; … ; 1.0807869561342869; 2.863961622395612;;]), filter_5 = (bias = [-1.2415685842860174; -3.0410621094016568; … ; 0.10847446216248288; 1.006668604465764;;])), linear_layers = (layer_1 = (weight = [-0.2877726787585314 -0.20519492008746718 … -0.2873496593126123 -0.17719407915991622; -0.14803786041112307 0.12345501421671488 … -0.15931575456198654 -0.04931819439431268; … ; -0.22177245004734933 -0.08080222546315463 … 0.20914244305029087 0.34375780410041185; 0.08868915060615144 0.1394452870934326 … 0.24739502229086824 0.2811320401284167], bias = [-0.0013541130430154576; -0.0031215043720930094; … ; 0.02028182205300151; -0.010863989601037037;;]), layer_2 = (weight = [-0.3341825960329082 0.028880457852261544 … 0.00628702329954503 0.28730012851112086; 0.07115121639114223 -0.34477599167131906 … 0.16678412833537207 0.1455039674492193; … ; 0.20711272834839278 -0.149411011154617 … 0.1558546973752799 -0.20410251506808266; 0.025841020120047 -0.13050939999257366 … 0.45373969073310255 0.2557424940734389], bias = [0.012906708261967765; -0.027578177405065282; … ; -0.07305823769508189; -0.00047027959502142085;;]), layer_3 = (weight = [0.1646241819822291 0.19053250627518978 … 0.054790974043196446 0.23255940219500995; -0.1316600678340584 0.26692855005029864 … -0.22952158934929542 0.31740317651701727; … ; -0.02039081600628707 -0.42215340502460946 … -0.1500300222469631 0.21897964973014653; -0.36223327763330626 0.1765797692883148 … -0.041335969842003606 -0.33498642183446314], bias = [-0.017022930934422486; -0.012673673797074163; … ; 0.054120002101591784; -0.024381824033357286;;]), layer_4 = (weight = [-0.2901988907429139 0.37791758649601387 … -0.025855147970656824 -0.016744310217785743; -0.15419845369277113 0.0678431755505946 … 0.3927234192722115 0.22697229434747138; … ; -0.043071932057465866 0.17373029860853695 … 0.05540196542275505 -0.20986607482193798; 0.18625325323583714 -0.0007771289948729973 … -0.30278079081292236 0.1759271618527752], bias = [0.07263009740465437; -0.007500837866139244; … ; -0.06520192712682672; -0.002501527868416395;;])), output_layer = (weight = [-0.11002099154635021 -0.02892334415305781 … -0.17465908089399465 0.19746718390910273], bias = [0.07856631431348896;;]))</code></pre><p>Let&#39;s visualize the result.</p><pre><code class="language-julia hljs">phi = discretization.phi

xs, ts= [infimum(d.domain):0.01:supremum(d.domain) for d in domains]
u_pred = [sum(phi([x,t],res.u)) for x in xs, t in ts]
u_real = u_analytic.(xs,ts&#39;)

fig, ax, hm = CairoMakie.heatmap(ts, xs, u_pred&#39;, axis=(xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;c = $c&quot;))</code></pre><p><img src="../convection.png" alt/></p><p>This may not look so accurate, which is fine. What we want to show is that our model is indeed, periodic.</p><pre><code class="language-julia hljs">xs, ts= [infimum(d.domain):0.01:supremum(d.domain)*2 for d in domains]
u_pred = [sum(phi([x,t],res.u)) for x in xs, t in ts]
fig, ax, hm = CairoMakie.heatmap(ts, xs, u_pred&#39;, axis=(xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;c = $c&quot;))</code></pre><p><img src="../convection2.png" alt/></p><h2 id="Respecting-Causality-is-all-you-need"><a class="docs-heading-anchor" href="#Respecting-Causality-is-all-you-need">Respecting Causality is all you need</a><a id="Respecting-Causality-is-all-you-need-1"></a><a class="docs-heading-anchor-permalink" href="#Respecting-Causality-is-all-you-need" title="Permalink"></a></h2><p>This is a time-dependent PDE, and our training process actually violates causality. Therefore we use <a href="../../#Sophon.CausalTraining"><code>CausalTraining</code></a>.</p><pre><code class="language-julia hljs">discretization = PhysicsInformedNN(chain, CausalTraining(300; epsilon = 0.1); adaptive_loss = NonAdaptiveLoss(; bc_loss_weights = [100]))
prob = discretize(convection, discretization)

@time res = Optimization.solve(prob, Adam(); maxiters = 2000)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">u: ComponentVector{Float64}(filters = (filter_1 = (bias = [0.7220750607056243; 0.9942208526811273; … ; 1.909404424429583; 0.7389942674770589;;]), filter_2 = (bias = [-2.8993313400529397; -2.517185286570121; … ; 0.9122983318505752; 1.199241898747926;;]), filter_3 = (bias = [-1.0334583777917572; -2.925347800631059; … ; 0.8912100185003269; -0.41488724542905286;;]), filter_4 = (bias = [0.5132376690048789; -1.7476959981851772; … ; 2.9522835138841987; -1.202363076073179;;]), filter_5 = (bias = [1.4253481165827921; 2.5098652974777904; … ; -1.7817186364935709; 1.825304342498598;;])), linear_layers = (layer_1 = (weight = [0.3513746428174099 0.30177564392566153 … 0.4001304676149877 0.1851109433820866; 0.05123414017089089 0.27255055531712297 … 0.01903066332091655 -0.03398699074321506; … ; -0.0882414122614754 -0.09445825880758466 … -0.0375732187356975 -0.1561459020632189; -0.10239312969354376 0.3486926972262106 … 0.2721291345843658 0.24238398812972517], bias = [-0.027473297419814528; -0.00523236278262772; … ; 0.030769537089143515; 0.01610716221734702;;]), layer_2 = (weight = [0.3117943360864245 -0.07130378547989626 … -0.23641706912582272 0.2362704601517446; -0.33564190023761536 -0.46654522844055957 … -0.0816342907605751 -0.23103687439605955; … ; 0.26043942410651016 -0.34664469660649716 … -0.104773229076421 0.14122274486050548; -0.3737268959182481 0.003549781928548009 … 0.053301121681040065 -0.20950176632442308], bias = [-0.06254462027544254; -0.007936324312201235; … ; 0.0054437206701489806; 0.016140255655073037;;]), layer_3 = (weight = [0.3596493760789158 -0.4175575354416602 … 0.33535945334858924 0.23624694586627046; 0.23375480505420274 -0.35991284174271715 … -0.27308875170578917 -0.1296663358465264; … ; -0.009854362049201433 0.13362854757732145 … 0.028589778673148825 -0.3628737296832183; -0.30363182979344755 0.18383077626488972 … 0.3460326675416875 -0.19945505945231595], bias = [-0.016471120011339043; -0.006903398013897487; … ; 0.011771288373278902; -0.005506077303366807;;]), layer_4 = (weight = [0.16586419032899574 -0.2865775977129887 … -0.08741847418069311 0.2327798959932999; -0.20463348107529067 -0.006241321607711225 … 0.3086348441100537 -0.1628421800211936; … ; -0.016321924197598748 -0.22708795254985767 … 0.13069702524549334 -0.30614396644026387; -0.24950238825284757 0.2690993782146406 … -0.3622319860209389 -0.2235142465433134], bias = [-0.004627955983705629; -5.038849205029692e-5; … ; 0.027935223802483054; 0.0104470736496715;;])), output_layer = (weight = [-0.22108308752142225 -0.05267271305219525 … 0.009393869331443691 -0.18270923049459462], bias = [0.006178733790920515;;]))</code></pre><p>And now you have an astonishingly good result.</p><pre><code class="language-julia hljs">phi = discretization.phi

xs, ts= [infimum(d.domain):0.01:supremum(d.domain) for d in domains]
u_pred = [sum(phi([x,t],res.u)) for x in xs, t in ts]
u_real = u_analytic.(xs,ts&#39;)

fig, ax, hm = CairoMakie.heatmap(ts, xs, u_pred&#39;, axis=(xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;c = $c&quot;))
ax2, hm2 = heatmap(fig[1,end+1], ts,xs, abs.(u_pred&#39; .- u_real&#39;), axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;error&quot;))
Colorbar(fig[:, end+1], hm2)</code></pre><p><img src="../convection3.png" alt/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../poisson/">« 1D Poisson&#39;s Equation</a><a class="docs-footer-nextpage" href="../helmholtz/">2D Helmholtz Equation »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Wednesday 7 September 2022 07:13">Wednesday 7 September 2022</span>. Using Julia version 1.8.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
