<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>1D Convection Equation · Sophon.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://YichengDWu.github.io/Sophon.jl/tutorials/convection/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/indigo.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Sophon.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../discontinuous/">Fitting a nonlinear discontinuous function</a></li><li><a class="tocitem" href="../poisson/">1D Poisson&#39;s Equation</a></li><li class="is-active"><a class="tocitem" href>1D Convection Equation</a><ul class="internal"><li><a class="tocitem" href="#Imposing-periodic-boundary-conditions"><span>Imposing periodic boundary conditions</span></a></li><li><a class="tocitem" href="#Respecting-Causality-is-all-you-need"><span>Respecting Causality is all you need</span></a></li></ul></li><li><a class="tocitem" href="../helmholtz/">2D Helmholtz Equation</a></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>1D Convection Equation</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>1D Convection Equation</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/YichengDWu/Sophon.jl/blob/main/docs/src/tutorials/convection.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="D-Convection-Equation"><a class="docs-heading-anchor" href="#D-Convection-Equation">1D Convection Equation</a><a id="D-Convection-Equation-1"></a><a class="docs-heading-anchor-permalink" href="#D-Convection-Equation" title="Permalink"></a></h1><p>Consider the following 1D-convection equation with periodic boundary conditions.</p><p class="math-container">\[\begin{aligned}
&amp;\frac{\partial u}{\partial t}+c \frac{\partial u}{\partial x}=0, x \in[0,1], t \in[0,1] \\
&amp;u(x, 0)=sin(2\pi x) \\
\end{aligned}\]</p><p>First we define the PDE.</p><pre><code class="language-julia hljs">using NeuralPDE, Lux, Random, Sophon, IntervalSets, CairoMakie
using Optimization, OptimizationOptimJL, OptimizationOptimisers
using CUDA
CUDA.allowscalar(false)

@parameters x, t
@variables u(..)
Dₜ = Differential(t)
Dₓ = Differential(x)

c = 4
eq = Dₜ(u(x,t)) + c * Dₓ(u(x,t)) ~ 0
u_analytic(x,t) = sin(2π*(x-c*t))

domains = [x ∈ 0..1, t ∈ 0..1]

bcs = [u(x,0) ~ u_analytic(x,0)]

@named convection = PDESystem(eq, bcs, domains, [x,t], [u(x,t)])</code></pre><p class="math-container">\[ \begin{align}
4 \mathrm{\frac{d}{d x}}\left( u\left( x, t \right) \right) + \mathrm{\frac{d}{d t}}\left( u\left( x, t \right) \right) =&amp; 0
\end{align}
 \]</p><h2 id="Imposing-periodic-boundary-conditions"><a class="docs-heading-anchor" href="#Imposing-periodic-boundary-conditions">Imposing periodic boundary conditions</a><a id="Imposing-periodic-boundary-conditions-1"></a><a class="docs-heading-anchor-permalink" href="#Imposing-periodic-boundary-conditions" title="Permalink"></a></h2><p>We will use <a href="tutorials/@ref"><code>BACON</code></a> to impose the boundary conditions. To this end, we simply set <code>period</code> to be one.</p><pre><code class="language-julia hljs">chain = BACON(2,1; hidden_dims = 32, num_layers=5, period = 1, N = 5)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">MultiplicativeFilterNet(
    filters = BranchLayer(
        filter_1 = DiscreteFourierFeature(2 =&gt; 32),  # 32 parameters, plus 64
        filter_2 = DiscreteFourierFeature(2 =&gt; 32),  # 32 parameters, plus 64
        filter_3 = DiscreteFourierFeature(2 =&gt; 32),  # 32 parameters, plus 64
        filter_4 = DiscreteFourierFeature(2 =&gt; 32),  # 32 parameters, plus 64
        filter_5 = DiscreteFourierFeature(2 =&gt; 32),  # 32 parameters, plus 64
    ),
    linear_layers = PairwiseFusion(
        Base.Broadcast.BroadcastFunction{typeof(*)}(*)
        layer_1 = Dense(32 =&gt; 32),      # 1_056 parameters
        layer_2 = Dense(32 =&gt; 32),      # 1_056 parameters
        layer_3 = Dense(32 =&gt; 32),      # 1_056 parameters
        layer_4 = Dense(32 =&gt; 32),      # 1_056 parameters
    ),
    output_layer = Dense(32 =&gt; 1),      # 33 parameters
)         # Total: 4_417 parameters,
          #        plus 320 states, summarysize 240 bytes.</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>For demonstration purposes, the model is also periodic in time</p></div></div><pre><code class="language-julia hljs">discretization = PhysicsInformedNN(chain, QuasiRandomTraining(300); adaptive_loss = NonAdaptiveLoss(; bc_loss_weights = [100]))
prob = discretize(convection, discretization)

@time res = Optimization.solve(prob, Adam(); maxiters = 2000)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">u: ComponentVector{Float64}(filters = (filter_1 = (bias = [0.736851988223436; 0.7457228350745202; … ; 2.90448211074814; -2.7911554929289917;;]), filter_2 = (bias = [2.9416334732143516; -0.6989956710256924; … ; -0.0032432969597332565; -0.7502761940371198;;]), filter_3 = (bias = [-2.9549404483639403; -2.1246386373858863; … ; 1.7453326971910619; 2.17758465766565;;]), filter_4 = (bias = [2.2757408605305836; -1.1666516329818246; … ; -2.6213014114504056; -2.5829208776233195;;]), filter_5 = (bias = [0.32363174863468175; 0.5796572233864861; … ; -2.1952316276185693; -0.08924352602453911;;])), linear_layers = (layer_1 = (weight = [0.2754356105902741 0.3317573263024368 … -0.021950320848232573 0.14563298395390067; -0.1332550193480417 0.02577863920705847 … -0.15146386654878916 0.03540389624849035; … ; 0.3143487446152223 0.3513067883177369 … -0.3869369181334804 0.12445115505121875; -0.3898609869628383 0.25861326276320984 … 0.271850623617303 0.3991065889028789], bias = [-0.013535974089390012; -0.01254337434769364; … ; 0.023182947924597855; -0.02205146991015122;;]), layer_2 = (weight = [0.4063862660714621 0.1450561778804308 … 0.5295782443447469 -0.3096562553294728; 0.14072938419060765 -0.20767678152423 … 0.291102695156058 0.38873344588869113; … ; -0.2714725435558645 0.27718745269148276 … 0.2485859335985518 -0.3749195782832886; 0.008149965047911599 0.019304446729811044 … 0.2820394474945959 -0.3529455771941605], bias = [0.039892757478336476; 0.006255464668155924; … ; 0.014156294375944248; -0.02047268935330137;;]), layer_3 = (weight = [-0.25882450200924256 -0.2586491733712323 … -0.17826817529434 -0.3562106014230057; -0.11438607722228435 0.3687588101733098 … -0.1712607802324994 0.31013970921236883; … ; -0.18719274220039805 -0.07493114472313994 … -0.012282718461411862 -0.12061038042932354; 0.16329719639753162 -0.4259499752495888 … 0.2967225357237787 0.3162280623695561], bias = [-0.01035111940135198; 0.02430178902578375; … ; -0.007302806628756525; 0.008148745506712499;;]), layer_4 = (weight = [0.057065108325303524 -0.31653021926364133 … -0.12138099293482404 0.4416759795931796; 0.35670136253503937 -0.02286186165085756 … -0.09189774628103041 0.29507431529210465; … ; -0.14261358830034582 -0.33393372275502803 … 0.23572470664179188 -0.4306578835701561; -0.33603901410550807 -0.02718843480944595 … 0.034181195431327215 0.42067757983310694], bias = [-0.055456471267223896; 0.039024751399051705; … ; -0.12635750117733843; -0.0053956648712152975;;])), output_layer = (weight = [0.44955978252561024 -0.11944209636576691 … 0.14604219986387268 0.21220774922471097], bias = [-0.05061709126902951;;]))</code></pre><p>Let&#39;s visualize the result.</p><pre><code class="language-julia hljs">phi = discretization.phi

xs, ts= [infimum(d.domain):0.01:supremum(d.domain) for d in domains]
u_pred = [sum(phi(gpu([x,t]),res.u)) for x in xs, t in ts]
u_real = u_analytic.(xs,ts&#39;)

fig, ax, hm = CairoMakie.heatmap(ts, xs, u_pred&#39;, axis=(xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;c = $c&quot;))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">┌ Info: The GPU function is being called but the GPU is not accessible.
│ Defaulting back to the CPU. (No action is required if you want
└ to run on the CPU).</code></pre><p><img src="../convection.png" alt/></p><p>This may not look so accurate, which is fine. What we want to show is that our model is indeed, periodic.</p><pre><code class="language-julia hljs">phi = discretization.phi

xs, ts= [infimum(d.domain):0.01:supremum(d.domain)*2 for d in domains]
u_pred = [sum(phi(gpu([x,t]),res.u)) for x in xs, t in ts]
u_real = u_analytic.(xs,ts&#39;)

fig, ax, hm = CairoMakie.heatmap(ts, xs, u_pred&#39;, axis=(xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;c = $c&quot;))</code></pre><p><img src="../convection2.png" alt/></p><h2 id="Respecting-Causality-is-all-you-need"><a class="docs-heading-anchor" href="#Respecting-Causality-is-all-you-need">Respecting Causality is all you need</a><a id="Respecting-Causality-is-all-you-need-1"></a><a class="docs-heading-anchor-permalink" href="#Respecting-Causality-is-all-you-need" title="Permalink"></a></h2><p>This is a time-dependent PDE, and our training process actually violates causality. Therefore we use <a href="../../#Sophon.CausalTraining"><code>CausalTraining</code></a>.</p><pre><code class="language-julia hljs">discretization = PhysicsInformedNN(chain, CausalTraining(300; epsilon = 0.1); adaptive_loss = NonAdaptiveLoss(; bc_loss_weights = [100]))
prob = discretize(convection, discretization)

@time res = Optimization.solve(prob, Adam(); maxiters = 2000)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">u: ComponentVector{Float64}(filters = (filter_1 = (bias = [1.6881390041844866; 2.3373521131827935; … ; -1.756262476438062; 0.43612048089623917;;]), filter_2 = (bias = [2.4153256901806053; -0.8457980769190662; … ; -2.38860170176768; 2.6247045232940205;;]), filter_3 = (bias = [-1.1148798265301714; -2.3474494199687976; … ; -1.1560308032865871; -1.2992733324156822;;]), filter_4 = (bias = [-0.3970919832666894; 2.7852606329790324; … ; 0.9932008735863783; -2.793877053448144;;]), filter_5 = (bias = [2.4026150812369953; 2.7752637190822433; … ; 0.3498841538356859; -2.5704257357526337;;])), linear_layers = (layer_1 = (weight = [0.05757300048648693 0.23648176814933386 … 0.0701229154019892 -0.09403891216828147; 0.344082885950029 0.31265490337397167 … 0.20254544928019216 0.009765283462413007; … ; -0.1277956261325305 0.3489030900700548 … 0.02372895573513364 -0.4251752747909397; -0.2890377308574109 0.27052361671737185 … 0.28247689508096124 0.035927516098373836], bias = [0.02058129044331334; -0.006712673009663629; … ; -0.05388219056759507; -0.013927991559507481;;]), layer_2 = (weight = [0.5975525198589867 -0.08799235074762825 … -0.7492998591317025 -0.12698542619213127; -0.30639729739627025 -0.0741910967192863 … 0.04835172891102411 -0.2964934060794422; … ; -0.04775724762959084 0.0488232560894102 … -0.4340879678102804 0.015887084330349823; 0.11243231405227733 0.14938908170371376 … 0.05085783921526602 0.22548532481707015], bias = [0.051989182422359184; -0.017119253131906088; … ; 0.005785311094816211; 0.013082322488705455;;]), layer_3 = (weight = [-0.7648282247561675 0.6570090819185214 … -0.706164950185343 0.2993505102302099; -0.017800978127779945 -0.2564339133238391 … 0.11383066349030505 0.09762863874258754; … ; 0.28538480276890155 0.19045670236588372 … 0.0892933439906061 0.42031676837826065; -0.6160206626816116 0.19778436065345387 … -0.2784407807900406 0.2200555945440601], bias = [-0.035331048203188116; -0.011204751696838773; … ; 0.00043401477745552903; -0.02988251612454933;;]), layer_4 = (weight = [-0.17594218059237296 0.10740798353724965 … -0.39038904621135523 -0.017224017835805232; -0.3311494688804135 0.427890565272797 … -0.4066277904003783 -0.345942458273169; … ; 0.16643958516581867 -0.39646499994924617 … 0.2993780562947718 -0.1421892333272841; 0.4068737605403084 0.09317815229975913 … -0.41887676470047414 0.03505956727817559], bias = [-0.022178808056711012; 0.0023532240273665787; … ; -0.006985398897665104; -0.0034493521076920312;;])), output_layer = (weight = [-0.15903407804611858 0.1654912665025821 … 0.24296411984482863 0.002540785514589164], bias = [0.00822589096746047;;]))</code></pre><p>And now you have an astonishingly good result.</p><pre><code class="language-julia hljs">phi = discretization.phi

xs, ts= [infimum(d.domain):0.01:supremum(d.domain) for d in domains]
u_pred = [sum(phi(gpu([x,t]),res.u)) for x in xs, t in ts]
u_real = u_analytic.(xs,ts&#39;)

fig, ax, hm = CairoMakie.heatmap(ts, xs, u_pred&#39;, axis=(xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;c = $c&quot;))
ax2, hm2 = heatmap(fig[1,end+1], ts,xs, abs.(u_pred&#39; .- u_real&#39;), axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;error&quot;))
Colorbar(fig[:, end+1], hm2)</code></pre><p><img src="../convection3.png" alt/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../poisson/">« 1D Poisson&#39;s Equation</a><a class="docs-footer-nextpage" href="../helmholtz/">2D Helmholtz Equation »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Wednesday 7 September 2022 04:58">Wednesday 7 September 2022</span>. Using Julia version 1.8.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
