<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Schrödinger Equation: A PDE System with Resampling · Sophon.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://YichengDWu.github.io/Sophon.jl/tutorials/SchrödingerEquation/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/indigo.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Sophon.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../ode/">Introduction with Lotka-Volterra System</a></li><li><a class="tocitem" href="../discontinuous/">Fitting a nonlinear discontinuous function</a></li><li><a class="tocitem" href="../poisson/">1D Multi-scale Poisson&#39;s Equation</a></li><li><a class="tocitem" href="../convection/">1D Convection Equation</a></li><li><a class="tocitem" href="../helmholtz/">2D Helmholtz Equation</a></li><li><a class="tocitem" href="../allen_cahn/">Allen-Cahn Equation with Sequential Training</a></li><li class="is-active"><a class="tocitem" href>Schrödinger Equation: A PDE System with Resampling</a><ul class="internal"><li><a class="tocitem" href="#Customize-Sampling"><span>Customize Sampling</span></a></li></ul></li><li><a class="tocitem" href="../L_shape/">Poisson equation over an L-shaped domain</a></li><li><a class="tocitem" href="../waveinverse2/">Inverse problem for the wave equation with unknown velocity field</a></li><li><a class="tocitem" href="../sod/">SOD Shock Tube Problem</a></li></ul></li><li><a class="tocitem" href="../../qa/">FAQ</a></li><li><a class="tocitem" href="../../api/">API Reference</a></li><li><a class="tocitem" href="../../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/YichengDWu/Sophon.jl/blob/main/docs/src/tutorials/SchrödingerEquation.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Schrödinger-equation"><a class="docs-heading-anchor" href="#Schrödinger-equation">Schrödinger equation</a><a id="Schrödinger-equation-1"></a><a class="docs-heading-anchor-permalink" href="#Schrödinger-equation" title="Permalink"></a></h1><p>The nonlinear Shrödinger equation is given by</p><p class="math-container">\[\mathrm{i} \partial_t \psi=-\frac{1}{2} \sigma \partial_{x x} \psi-\beta|\psi|^2 \psi\]</p><p>Let <span>$\sigma=\beta=1, \psi=u+v i$</span>, the equation can be transformed into a system of partial differential equations</p><pre><code class="language-julia hljs">using ModelingToolkit, IntervalSets, Sophon, CairoMakie
using Optimization, OptimizationOptimJL

@parameters x,t
@variables u(..), v(..)
Dₜ = Differential(t)
Dₓ² = Differential(x)^2

eqs=[Dₜ(u(x,t)) ~ -Dₓ²(v(x,t))/2 - (abs2(v(x,t)) + abs2(u(x,t))) * v(x,t),
     Dₜ(v(x,t)) ~  Dₓ²(u(x,t))/2 + (abs2(v(x,t)) + abs2(u(x,t))) * u(x,t)]

bcs = [u(x, 0.0) ~ 2sech(x),
       v(x, 0.0) ~ 0.0,
       u(-5.0, t) ~ u(5.0, t),
       v(-5.0, t) ~ v(5.0, t)]

domains = [x ∈ Interval(-5.0, 5.0),
           t ∈ Interval(0.0, π/2)]

@named pde_system = PDESystem(eqs, bcs, domains, [x,t], [u(x,t),v(x,t)])</code></pre><p class="math-container">\[ \begin{align}
\frac{\mathrm{d}}{\mathrm{d}t} u\left( x, t \right) =&amp;  - \frac{1}{2} \frac{\mathrm{d}}{\mathrm{d}x} \frac{\mathrm{d}}{\mathrm{d}x} v\left( x, t \right) - \left( \left|u\left( x, t \right)\right|^{2} + \left|v\left( x, t \right)\right|^{2} \right) v\left( x, t \right) \\
\frac{\mathrm{d}}{\mathrm{d}t} v\left( x, t \right) =&amp; \frac{1}{2} \frac{\mathrm{d}}{\mathrm{d}x} \frac{\mathrm{d}}{\mathrm{d}x} u\left( x, t \right) + \left( \left|u\left( x, t \right)\right|^{2} + \left|v\left( x, t \right)\right|^{2} \right) u\left( x, t \right)
\end{align}
 \]</p><pre><code class="language-julia hljs">pinn = PINN(u = Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0),
            v = Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0))

sampler = QuasiRandomSampler(500, (200,200,20,20))
strategy = NonAdaptiveTraining(1,(10,10,1,1))

prob = Sophon.discretize(pde_system, pinn, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [-0.12291574478149414 -0.12464702129364014; 0.3836502432823181 -0.11886638402938843; … ; 0.2518065571784973 0.40489131212234497; -0.2167367935180664 -0.2978200912475586], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [0.11205310374498367 -0.003758064704015851 … -0.2539999186992645 0.2855716049671173; 0.3846043348312378 0.4917639195919037 … 0.27758315205574036 0.2596214711666107; … ; -0.011615033261477947 -0.05121005326509476 … 0.30075985193252563 0.6084437966346741; 0.3981129229068756 -0.17374449968338013 … 0.09160341322422028 0.07891534268856049], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [0.3520132005214691 0.5596522688865662 … 0.12816256284713745 -0.17498032748699188; 0.5903180837631226 0.1640300303697586 … -0.43609026074409485 -0.24417360126972198; … ; -0.22262080013751984 -0.5160459280014038 … -0.1956872045993805 -0.4069391191005707; -0.43832093477249146 0.608635663986206 … -0.3245712220668793 0.5078030228614807], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [0.0021673112642019987 0.48088911175727844 … 0.469234436750412 0.5768527984619141; -0.6079419255256653 -0.5781834125518799 … 0.05687211826443672 0.03263135999441147; … ; -0.27259159088134766 -0.08858520537614822 … 0.2886181175708771 -0.5515020489692688; 0.06534265726804733 0.21467988193035126 … -0.024338943883776665 0.3635164797306061], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [-0.09280703961849213 0.6089051961898804 … -0.3578330874443054 -0.010799179784953594], bias = [0.0;;])), v = (layer_1 = (weight = [0.4492725729942322 0.3267853260040283; 0.28234773874282837 -0.31388843059539795; … ; -0.028051793575286865 -0.37843650579452515; 0.0754883885383606 -0.18814390897750854], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [-0.19302648305892944 -0.22640813887119293 … 0.5155541300773621 -0.08461689949035645; -0.3593686521053314 0.5064343810081482 … 0.3085234463214874 0.013180236332118511; … ; 0.32862764596939087 0.06166985630989075 … 0.16327914595603943 0.492331862449646; -0.3214705288410187 0.4955543279647827 … -0.25970563292503357 0.09305575489997864], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [-0.012765374965965748 0.14477169513702393 … -0.19686156511306763 -0.18035972118377686; 0.29436931014060974 0.17400409281253815 … 0.26555049419403076 -0.46632903814315796; … ; 0.24314166605472565 0.5449864864349365 … -0.5862638354301453 0.30005648732185364; 0.5026769042015076 -0.3168102502822876 … 0.13794001936912537 -0.3472278118133545], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [0.3028232753276825 -0.5698603987693787 … -0.07716858386993408 0.3317614197731018; 0.44915786385536194 0.26454177498817444 … -0.24953389167785645 0.46686068177223206; … ; -0.29751163721084595 0.5302975177764893 … 0.21221451461315155 0.5376720428466797; -0.4732632637023926 0.4618891477584839 … 0.23505839705467224 0.287813663482666], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [0.3223215639591217 0.2848588228225708 … -0.5617179274559021 -0.30911096930503845], bias = [0.0;;])))</code></pre><p>Now we train the neural nets and resample data while training.</p><pre><code class="language-julia hljs">function train(pde_system, prob, sampler, strategy, resample_period = 500, n=10)
     bfgs = BFGS()
     res = Optimization.solve(prob, bfgs; maxiters=2000)

     for i in 1:n
         data = Sophon.sample(pde_system, sampler)
         prob = remake(prob; u0=res.u, p=data)
         res = Optimization.solve(prob, bfgs; maxiters=resample_period)
     end
     return res
end

res = train(pde_system, prob, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">u: ComponentVector{Float64}(u = (layer_1 = (weight = [-0.23954053845323783 -0.23877911306345587; 0.3635581111820713 0.3537189611296746; … ; 0.3110739654958869 0.11373920230133076; -0.773371443844858 0.5475260515541536], bias = [0.16243675560682627; -0.257742039203254; … ; 0.18845151680656108; -0.865293916563675;;]), layer_2 = (weight = [0.11849989565884786 0.17406461252802743 … -0.19363263319936846 0.11779433414125064; 0.5158349708030389 0.49613958671489333 … 0.4986569772089296 0.3577599993813959; … ; -0.05924641991738791 0.18422704876742363 … 0.2111982945317931 0.5835801892287666; 0.826599540275265 -0.4611321516782477 … -0.23681756231930698 0.6423536933356762], bias = [-0.3427354797086906; -0.006056765303182396; … ; -0.05876633425777346; -0.04705736405128135;;]), layer_3 = (weight = [0.2742417380179594 0.23522100971313295 … -0.07667824602112448 -0.33325637441816053; 0.6481228552042473 0.013203832932375191 … -0.32231723077116603 -0.004300255840167477; … ; -0.212310233693829 -0.6977661254440388 … -0.24132284280055238 -0.22511811085092978; -0.5694599876298506 0.6169625488838238 … -0.3600106564658324 0.5676857342528898], bias = [0.05024259010321822; -0.09241874698098607; … ; 0.177122347392723; 0.2889917265735932;;]), layer_4 = (weight = [0.20108378999224014 0.5699618628992918 … 0.6514784898833722 0.9090193627145329; -0.28553622241898585 -0.3953256982487129 … -0.11530007691543648 0.28107276897639527; … ; 0.014907587575946483 0.22894874710679086 … 0.7879507520926353 -0.39996212198166675; 0.051556170700807945 0.2304317407397666 … 0.08523539943765022 0.07903658019941624], bias = [-0.35280036813705845; 0.007248844428689403; … ; 0.16549757245908212; -0.03726160537666967;;]), layer_5 = (weight = [-0.616481578381838 0.7210069956863936 … -0.5590296354180289 -0.6389925514067367], bias = [0.016921833095906034;;])), v = (layer_1 = (weight = [0.6568131033258408 0.09596534592872831; 0.5241649159117033 -0.5811802391294356; … ; 0.2517033337477387 -0.3168099516947426; 0.3402685638938267 0.03774712296022874], bias = [-0.10392290131126501; 0.2660974311880628; … ; 0.27293520437614893; 0.01322854796146636;;]), layer_2 = (weight = [-0.2531566711725826 -0.24626859045672111 … 0.5049679527939294 -0.17207055729828605; -0.158360531625746 0.4219332380728112 … 0.1799020081354897 -0.1316128375769843; … ; 0.4516257642774267 -0.12160370015049124 … 0.2428675429160355 0.8373917808105288; -0.1768291749036437 0.2915952581139923 … -0.47023639167143527 -0.011521921337662132], bias = [-0.16984167113844692; -0.052223080081594785; … ; 0.3499990628896959; -0.16616124408850705;;]), layer_3 = (weight = [-0.2402994486897549 -0.029288231730816936 … -0.36936401080317227 -0.28140617426790376; 0.3361935375177108 0.1545398162003581 … 0.15183935665035378 -0.31659516087700024; … ; 0.4247205514148389 0.6117449772144603 … -0.23101088684574675 0.39298575895879406; 0.35896936731064055 -0.48006770549782884 … 0.12685235860356384 -0.1931099012457194], bias = [0.12345598479462731; -0.2098985167916963; … ; -0.7686046297423005; 0.018540200699019363;;]), layer_4 = (weight = [0.3255167312635736 -0.6469357950665642 … -0.2759065021031093 0.2134875266857282; 0.20010482954518632 0.12012739254364142 … -0.41850310713258665 0.42971835271762304; … ; -0.18331208107799113 0.3429441162812839 … 0.6092768501397606 0.2435717482164137; -0.80076990920986 0.42449879825611264 … 0.4802761419503667 0.4043471679664974], bias = [0.0071278721609008885; -0.3331801373613025; … ; -0.015520574073911652; 0.08208360142091645;;]), layer_5 = (weight = [-0.12425597448647761 0.5702507869988992 … -0.5822850770036142 -0.47358064995811505], bias = [-0.02503987276283277;;])))</code></pre><pre><code class="language-julia hljs">phi = pinn.phi
ps = res.u

xs, ts= [infimum(d.domain):0.01:supremum(d.domain) for d in pde_system.domain]

u = [sum(phi.u(([x,t]), ps.u)) for x in xs, t in ts]
v = [sum(phi.v(([x,t]), ps.v)) for x in xs, t in ts]
ψ = @. sqrt(u^2+ v^2)

axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;u&quot;)
fig, ax1, hm1 = heatmap(ts, xs, u&#39;, axis=axis)
ax2, hm2= heatmap(fig[1, end+1], ts, xs, v&#39;, axis= merge(axis, (; title=&quot;v&quot;)))
display(fig)</code></pre><p><img src="../uv.png" alt/></p><pre><code class="language-julia hljs">axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;ψ&quot;)
fig, ax1, hm1 = heatmap(ts, xs, ψ&#39;, axis=axis, colormap=:jet)
Colorbar(fig[:, end+1], hm1)
display(fig)</code></pre><p><img src="../phi.png" alt/></p><h2 id="Customize-Sampling"><a class="docs-heading-anchor" href="#Customize-Sampling">Customize Sampling</a><a id="Customize-Sampling-1"></a><a class="docs-heading-anchor-permalink" href="#Customize-Sampling" title="Permalink"></a></h2><p>Bascially any sampling method is supportted. For example we can sample data according to the predicted solution.</p><pre><code class="language-julia hljs">using StatsBase

data = vec([[x, t] for x in xs, t in ts])
wv = vec(ψ)
new_data = wsample(data, wv, 500)
new_data = reduce(hcat, new_data)
fig, ax = scatter(new_data[2,:], new_data[1,:])</code></pre><p><img src="../data.png" alt/></p><pre><code class="language-julia hljs">prob.p[1] = new_data
prob.p[2] = new_data
prob = remake(prob; u0 = res.u)
# res = Optimization.solve(prob, bfgs; maxiters=1000)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [-0.23954053845323783 -0.23877911306345587; 0.3635581111820713 0.3537189611296746; … ; 0.3110739654958869 0.11373920230133076; -0.773371443844858 0.5475260515541536], bias = [0.16243675560682627; -0.257742039203254; … ; 0.18845151680656108; -0.865293916563675;;]), layer_2 = (weight = [0.11849989565884786 0.17406461252802743 … -0.19363263319936846 0.11779433414125064; 0.5158349708030389 0.49613958671489333 … 0.4986569772089296 0.3577599993813959; … ; -0.05924641991738791 0.18422704876742363 … 0.2111982945317931 0.5835801892287666; 0.826599540275265 -0.4611321516782477 … -0.23681756231930698 0.6423536933356762], bias = [-0.3427354797086906; -0.006056765303182396; … ; -0.05876633425777346; -0.04705736405128135;;]), layer_3 = (weight = [0.2742417380179594 0.23522100971313295 … -0.07667824602112448 -0.33325637441816053; 0.6481228552042473 0.013203832932375191 … -0.32231723077116603 -0.004300255840167477; … ; -0.212310233693829 -0.6977661254440388 … -0.24132284280055238 -0.22511811085092978; -0.5694599876298506 0.6169625488838238 … -0.3600106564658324 0.5676857342528898], bias = [0.05024259010321822; -0.09241874698098607; … ; 0.177122347392723; 0.2889917265735932;;]), layer_4 = (weight = [0.20108378999224014 0.5699618628992918 … 0.6514784898833722 0.9090193627145329; -0.28553622241898585 -0.3953256982487129 … -0.11530007691543648 0.28107276897639527; … ; 0.014907587575946483 0.22894874710679086 … 0.7879507520926353 -0.39996212198166675; 0.051556170700807945 0.2304317407397666 … 0.08523539943765022 0.07903658019941624], bias = [-0.35280036813705845; 0.007248844428689403; … ; 0.16549757245908212; -0.03726160537666967;;]), layer_5 = (weight = [-0.616481578381838 0.7210069956863936 … -0.5590296354180289 -0.6389925514067367], bias = [0.016921833095906034;;])), v = (layer_1 = (weight = [0.6568131033258408 0.09596534592872831; 0.5241649159117033 -0.5811802391294356; … ; 0.2517033337477387 -0.3168099516947426; 0.3402685638938267 0.03774712296022874], bias = [-0.10392290131126501; 0.2660974311880628; … ; 0.27293520437614893; 0.01322854796146636;;]), layer_2 = (weight = [-0.2531566711725826 -0.24626859045672111 … 0.5049679527939294 -0.17207055729828605; -0.158360531625746 0.4219332380728112 … 0.1799020081354897 -0.1316128375769843; … ; 0.4516257642774267 -0.12160370015049124 … 0.2428675429160355 0.8373917808105288; -0.1768291749036437 0.2915952581139923 … -0.47023639167143527 -0.011521921337662132], bias = [-0.16984167113844692; -0.052223080081594785; … ; 0.3499990628896959; -0.16616124408850705;;]), layer_3 = (weight = [-0.2402994486897549 -0.029288231730816936 … -0.36936401080317227 -0.28140617426790376; 0.3361935375177108 0.1545398162003581 … 0.15183935665035378 -0.31659516087700024; … ; 0.4247205514148389 0.6117449772144603 … -0.23101088684574675 0.39298575895879406; 0.35896936731064055 -0.48006770549782884 … 0.12685235860356384 -0.1931099012457194], bias = [0.12345598479462731; -0.2098985167916963; … ; -0.7686046297423005; 0.018540200699019363;;]), layer_4 = (weight = [0.3255167312635736 -0.6469357950665642 … -0.2759065021031093 0.2134875266857282; 0.20010482954518632 0.12012739254364142 … -0.41850310713258665 0.42971835271762304; … ; -0.18331208107799113 0.3429441162812839 … 0.6092768501397606 0.2435717482164137; -0.80076990920986 0.42449879825611264 … 0.4802761419503667 0.4043471679664974], bias = [0.0071278721609008885; -0.3331801373613025; … ; -0.015520574073911652; 0.08208360142091645;;]), layer_5 = (weight = [-0.12425597448647761 0.5702507869988992 … -0.5822850770036142 -0.47358064995811505], bias = [-0.02503987276283277;;])))</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../allen_cahn/">« Allen-Cahn Equation with Sequential Training</a><a class="docs-footer-nextpage" href="../L_shape/">Poisson equation over an L-shaped domain »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Thursday 10 August 2023 06:42">Thursday 10 August 2023</span>. Using Julia version 1.9.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
