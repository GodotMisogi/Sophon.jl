<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Schrödinger Equation: A PDE System with Resampling · Sophon.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://YichengDWu.github.io/Sophon.jl/tutorials/SchrödingerEquation/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/indigo.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Sophon.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../discontinuous/">Fitting a nonlinear discontinuous function</a></li><li><a class="tocitem" href="../poisson/">1D Multi-scale Poisson&#39;s Equation</a></li><li><a class="tocitem" href="../convection/">1D Convection Equation</a></li><li><a class="tocitem" href="../helmholtz/">2D Helmholtz Equation</a></li><li><a class="tocitem" href="../allen_cahn/">Allen-Cahn Equation with Sequential Training</a></li><li class="is-active"><a class="tocitem" href>Schrödinger Equation: A PDE System with Resampling</a><ul class="internal"><li><a class="tocitem" href="#Customize-Sampling"><span>Customize Sampling</span></a></li></ul></li><li><a class="tocitem" href="../L_shape/">Poisson equation over an L-shaped domain</a></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/YichengDWu/Sophon.jl/blob/main/docs/src/tutorials/SchrödingerEquation.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Schrödinger-equation"><a class="docs-heading-anchor" href="#Schrödinger-equation">Schrödinger equation</a><a id="Schrödinger-equation-1"></a><a class="docs-heading-anchor-permalink" href="#Schrödinger-equation" title="Permalink"></a></h1><p>The nonlinear Shrödinger equation is given by</p><p class="math-container">\[\mathrm{i} \partial_t \psi=-\frac{1}{2} \sigma \partial_{x x} \psi-\beta|\psi|^2 \psi\]</p><p>Let <span>$\sigma=\beta=1, \psi=u+v i$</span>, the equation can be transformed into a system of partial differential equations</p><pre><code class="language-julia hljs">using ModelingToolkit, IntervalSets, Sophon, CairoMakie
using Optimization, OptimizationOptimJL

@parameters x,t
@variables u(..), v(..)
Dₜ = Differential(t)
Dₓ² = Differential(x)^2

eqs=[Dₜ(u(x,t)) ~ -Dₓ²(v(x,t))/2 - (abs2(v(x,t)) + abs2(u(x,t))) * v(x,t),
     Dₜ(v(x,t)) ~  Dₓ²(u(x,t))/2 + (abs2(v(x,t)) + abs2(u(x,t))) * u(x,t)]

bcs = [u(x, 0.0) ~ 2sech(x),
       v(x, 0.0) ~ 0.0,
       u(-5.0, t) ~ u(5.0, t),
       v(-5.0, t) ~ v(5.0, t)]

domains = [x ∈ Interval(-5.0, 5.0),
           t ∈ Interval(0.0, π/2)]

@named pde_system = PDESystem(eqs, bcs, domains, [x,t], [u(x,t),v(x,t)])</code></pre><p class="math-container">\[ \begin{align}
\frac{\mathrm{d}}{\mathrm{d}t} u\left( x, t \right) =&amp;  - \frac{1}{2} \frac{\mathrm{d}^{2}}{\mathrm{d}x^{2}} v\left( x, t \right) - \left( \left|u\left( x, t \right)\right|^{2} + \left|v\left( x, t \right)\right|^{2} \right) v\left( x, t \right) \\
\frac{\mathrm{d}}{\mathrm{d}t} v\left( x, t \right) =&amp; \frac{1}{2} \frac{\mathrm{d}^{2}}{\mathrm{d}x^{2}} u\left( x, t \right) + \left( \left|u\left( x, t \right)\right|^{2} + \left|v\left( x, t \right)\right|^{2} \right) u\left( x, t \right)
\end{align}
 \]</p><pre><code class="language-julia hljs">pinn = PINN(u = Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0),
            v = Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0))

sampler = QuasiRandomSampler(500, (200,200,20,20))
strategy = NonAdaptiveTraining(1,(10,10,1,1))

prob = Sophon.discretize(pde_system, pinn, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [0.4166792631149292 0.3441751003265381; 0.05972445011138916 0.3656582832336426; … ; 0.023971915245056152 0.2174009084701538; -0.10348737239837646 -0.45265519618988037], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [0.5624376535415649 -0.3958687484264374 … 0.15690438449382782 -0.1730550080537796; 0.3319469690322876 -0.15043865144252777 … -0.07606861740350723 -0.051971010863780975; … ; 0.36077800393104553 0.37187525629997253 … -0.5204867124557495 -0.0584757924079895; 0.14379633963108063 0.5688731670379639 … 0.030114304274320602 -0.04501121863722801], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [-0.35384485125541687 -0.42365652322769165 … 0.012029384262859821 0.5885543823242188; -0.11206799745559692 -0.15739676356315613 … -0.2408536970615387 0.2480420470237732; … ; -0.1537582129240036 -0.5593938827514648 … -0.43851467967033386 0.22716091573238373; 0.45331451296806335 -0.1145462915301323 … -0.16782532632350922 0.15925265848636627], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [0.17704156041145325 -0.5058894753456116 … -0.18557605147361755 0.2142917364835739; -0.39759841561317444 0.5662034749984741 … 0.43448659777641296 0.34444260597229004; … ; 0.5656659603118896 -0.11336295306682587 … 0.41078251600265503 0.44594335556030273; -0.3289492130279541 -0.2812150716781616 … 0.45751357078552246 0.4897623360157013], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [-0.4333353042602539 -0.2763154208660126 … 0.29203665256500244 -0.1919807493686676], bias = [0.0;;])), v = (layer_1 = (weight = [-0.42389237880706787 0.1328858733177185; -0.16497159004211426 0.40839165449142456; … ; -0.38588547706604004 0.21539044380187988; 0.24497699737548828 0.42671680450439453], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [-0.40885400772094727 -0.2179803103208542 … 0.3688504695892334 -0.45070114731788635; 0.005654033273458481 -0.2496444135904312 … -0.33165016770362854 -0.24027566611766815; … ; -0.13359767198562622 0.48877835273742676 … 0.14731912314891815 0.013860819861292839; 0.0665818378329277 -0.07005096971988678 … 0.2237364649772644 0.2789049744606018], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [0.022113816812634468 -0.4851003587245941 … -0.5124421715736389 -0.17784544825553894; 0.3760620355606079 0.22845032811164856 … -0.1314922571182251 -0.5495150685310364; … ; -0.21695661544799805 -0.5060091018676758 … 0.3130897879600525 -0.04642720893025398; 0.029921364039182663 -0.5362809300422668 … 0.4814096987247467 0.56596440076828], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [-0.22059372067451477 0.010592004284262657 … -0.5273383259773254 -0.5722568035125732; 0.5426962971687317 0.17612963914871216 … 0.448845773935318 -0.18024642765522003; … ; 0.43315404653549194 0.35648709535598755 … -0.11083808541297913 -0.3097720444202423; 0.486346572637558 -0.16237978637218475 … 0.16723023355007172 0.5632246136665344], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [-0.14962805807590485 -0.5134726762771606 … -0.48824283480644226 -0.32596510648727417], bias = [0.0;;])))</code></pre><p>Now we train the neural nets and resample data while training.</p><pre><code class="language-julia hljs">function train(pde_system, prob, sampler, strategy, resample_period = 500, n=10)
     bfgs = BFGS()
     res = Optimization.solve(prob, bfgs; maxiters=2000)

     for i in 1:n
         data = Sophon.sample(pde_system, sampler, strategy)
         prob = remake(prob; u0=res.u, p=data)
         res = Optimization.solve(prob, bfgs; maxiters=resample_period)
     end
     return res
end

res = train(pde_system, prob, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">u: ComponentVector{Float64}(u = (layer_1 = (weight = [1.2950749060116933 0.7335916466138979; -0.050816568216772294 0.16784478672023015; … ; 0.27096456999459156 -0.33731943551429033; -0.3783468329161431 -0.564998068845246], bias = [-0.555638975097605; 0.14890309260036655; … ; 0.19764076047476345; 0.37186943959777813;;]), layer_2 = (weight = [0.6014210083584478 -0.19491345440548885 … -0.059086853446566535 -0.6733949566388601; -0.14055913675458426 -0.1980827145164255 … 0.0607105037134309 0.2643065891867978; … ; 0.2942945355002019 0.400147914885519 … -0.45057730880079916 -0.09187332886620547; 0.3763570583428245 0.5776925134665678 … 0.2758620201862074 -0.29822264209545246], bias = [-0.0013723660807153542; 0.5116314216696126; … ; -0.036739935253675145; 0.08034143294148186;;]), layer_3 = (weight = [-0.78003151411833 -0.47422728937215647 … -0.037670779711593265 0.2248654675844729; -0.16158000054295676 -0.054006662818503554 … -0.40838317148624315 0.43012505727302014; … ; -0.026968558446150294 -0.4429614079753517 … -0.7328846458581515 0.37655389774674153; 0.5672029159053961 0.0064209667103961735 … -0.03882809689604025 0.3387754585926021], bias = [-0.6415840843714711; 0.02631081870179486; … ; 0.24956225508496716; 0.2676191793472602;;]), layer_4 = (weight = [0.08679728790854446 -0.4755245710078657 … 0.05941187118406835 0.530668652366543; -0.9385328263776064 0.8256825741001409 … 0.8164599164212613 0.5966794479606939; … ; 1.0800661463203354 0.21066111006738625 … 0.36865202441192463 0.4417878166816712; -0.9114429331639481 0.07171559607006267 … 0.140781290970165 0.4633197856593939], bias = [-0.0999440595387639; -0.08178366675255425; … ; -0.6086453207543351; -0.18685292025134598;;]), layer_5 = (weight = [-0.41675067647254177 -0.22013163710930617 … 1.0327113751049797 -0.5939964700185822], bias = [0.3252804811205285;;])), v = (layer_1 = (weight = [-0.4483906687021848 -0.09273792762380477; -0.30600397491602144 0.31063057987734577; … ; -0.013270119224194904 0.25584307020906905; 0.9871718301241552 0.8294766540062425], bias = [-0.027757000559398625; -0.012252536341017112; … ; -0.33620625063434484; -0.3363885515282659;;]), layer_2 = (weight = [-0.39617851367087636 -0.28167252023313033 … 0.29019139878999123 -0.30050751093599515; 0.22347373029565154 0.05874371635291255 … -0.21867680475078832 0.09132457671113611; … ; -0.35236039133859065 0.5313147126603143 … 0.27361441639460715 0.25138203999174996; -0.14915282077227798 -0.11854858808834041 … 0.028359082437442514 -0.19680124952585654], bias = [-0.09829413602730777; -0.12937668752839473; … ; -0.06990382031675432; -0.07243822911294354;;]), layer_3 = (weight = [-0.0019435356028343225 -0.540550425200454 … -0.2698336016639271 0.05063139511593462; 0.27774089414788233 0.35498800050009516 … -0.2999069421774286 -0.12029612736197273; … ; -0.00019222998797073428 -0.47835037511051953 … 0.21362729875971737 0.20059891051795836; -0.02835933262625326 -0.42288570386266405 … 0.24859734400287536 0.6111387617740888], bias = [0.18439212423966947; 0.06406022241946631; … ; -0.4425074737967408; 0.06699618844951612;;]), layer_4 = (weight = [-0.408515495589385 0.14252237351883962 … -0.4890450878029103 -0.4456358237819436; 0.6960533096185048 0.19284564396788853 … -0.12108887455045497 -0.0010040293232103556; … ; 0.38447576637194436 0.37005969821320894 … -0.8008157496667178 -0.09842371426613565; 0.5079440329365821 -0.3090955392940469 … 0.022907794943616368 0.32804187294088816], bias = [-0.1273029631504913; -0.04916468577106584; … ; 0.10779107571031511; 0.07792192412791048;;]), layer_5 = (weight = [0.24615469201877566 -1.3582776603325277 … -1.3597782471056048 -0.719424430672108], bias = [0.053457939783605156;;])))</code></pre><pre><code class="language-julia hljs">phi = pinn.phi
ps = res.u

xs, ts= [infimum(d.domain):0.01:supremum(d.domain) for d in pde_system.domain]

u = [sum(phi.u(([x,t]), ps.u)) for x in xs, t in ts]
v = [sum(phi.v(([x,t]), ps.v)) for x in xs, t in ts]
ψ = @. sqrt(u^2+ v^2)

axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;u&quot;)
fig, ax1, hm1 = heatmap(ts, xs, u&#39;, axis=axis)
ax2, hm2= heatmap(fig[1, end+1], ts, xs, v&#39;, axis= merge(axis, (; title=&quot;v&quot;)))
display(fig)</code></pre><p><img src="../uv.png" alt/></p><pre><code class="language-julia hljs">axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;ψ&quot;)
fig, ax1, hm1 = heatmap(ts, xs, ψ&#39;, axis=axis, colormap=:jet)
Colorbar(fig[:, end+1], hm1)
display(fig)</code></pre><p><img src="../phi.png" alt/></p><h2 id="Customize-Sampling"><a class="docs-heading-anchor" href="#Customize-Sampling">Customize Sampling</a><a id="Customize-Sampling-1"></a><a class="docs-heading-anchor-permalink" href="#Customize-Sampling" title="Permalink"></a></h2><p>Bascially any sampling method is supportted.</p><pre><code class="language-julia hljs">using StatsBase

data = vec([[x, t] for x in xs, t in ts])
wv = vec(ψ)
new_data = wsample(data, wv, 500)
new_data = reduce(hcat, new_data)
fig, ax = scatter(new_data[2,:], new_data[1,:])</code></pre><p><img src="../data.png" alt/></p><pre><code class="language-julia hljs">prob.p[1] = new_data
prob.p[2] = new_data
prob = remake(prob; u0 = res.u)
# res = Optimization.solve(prob, bfgs; maxiters=1000)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [1.2950749060116933 0.7335916466138979; -0.050816568216772294 0.16784478672023015; … ; 0.27096456999459156 -0.33731943551429033; -0.3783468329161431 -0.564998068845246], bias = [-0.555638975097605; 0.14890309260036655; … ; 0.19764076047476345; 0.37186943959777813;;]), layer_2 = (weight = [0.6014210083584478 -0.19491345440548885 … -0.059086853446566535 -0.6733949566388601; -0.14055913675458426 -0.1980827145164255 … 0.0607105037134309 0.2643065891867978; … ; 0.2942945355002019 0.400147914885519 … -0.45057730880079916 -0.09187332886620547; 0.3763570583428245 0.5776925134665678 … 0.2758620201862074 -0.29822264209545246], bias = [-0.0013723660807153542; 0.5116314216696126; … ; -0.036739935253675145; 0.08034143294148186;;]), layer_3 = (weight = [-0.78003151411833 -0.47422728937215647 … -0.037670779711593265 0.2248654675844729; -0.16158000054295676 -0.054006662818503554 … -0.40838317148624315 0.43012505727302014; … ; -0.026968558446150294 -0.4429614079753517 … -0.7328846458581515 0.37655389774674153; 0.5672029159053961 0.0064209667103961735 … -0.03882809689604025 0.3387754585926021], bias = [-0.6415840843714711; 0.02631081870179486; … ; 0.24956225508496716; 0.2676191793472602;;]), layer_4 = (weight = [0.08679728790854446 -0.4755245710078657 … 0.05941187118406835 0.530668652366543; -0.9385328263776064 0.8256825741001409 … 0.8164599164212613 0.5966794479606939; … ; 1.0800661463203354 0.21066111006738625 … 0.36865202441192463 0.4417878166816712; -0.9114429331639481 0.07171559607006267 … 0.140781290970165 0.4633197856593939], bias = [-0.0999440595387639; -0.08178366675255425; … ; -0.6086453207543351; -0.18685292025134598;;]), layer_5 = (weight = [-0.41675067647254177 -0.22013163710930617 … 1.0327113751049797 -0.5939964700185822], bias = [0.3252804811205285;;])), v = (layer_1 = (weight = [-0.4483906687021848 -0.09273792762380477; -0.30600397491602144 0.31063057987734577; … ; -0.013270119224194904 0.25584307020906905; 0.9871718301241552 0.8294766540062425], bias = [-0.027757000559398625; -0.012252536341017112; … ; -0.33620625063434484; -0.3363885515282659;;]), layer_2 = (weight = [-0.39617851367087636 -0.28167252023313033 … 0.29019139878999123 -0.30050751093599515; 0.22347373029565154 0.05874371635291255 … -0.21867680475078832 0.09132457671113611; … ; -0.35236039133859065 0.5313147126603143 … 0.27361441639460715 0.25138203999174996; -0.14915282077227798 -0.11854858808834041 … 0.028359082437442514 -0.19680124952585654], bias = [-0.09829413602730777; -0.12937668752839473; … ; -0.06990382031675432; -0.07243822911294354;;]), layer_3 = (weight = [-0.0019435356028343225 -0.540550425200454 … -0.2698336016639271 0.05063139511593462; 0.27774089414788233 0.35498800050009516 … -0.2999069421774286 -0.12029612736197273; … ; -0.00019222998797073428 -0.47835037511051953 … 0.21362729875971737 0.20059891051795836; -0.02835933262625326 -0.42288570386266405 … 0.24859734400287536 0.6111387617740888], bias = [0.18439212423966947; 0.06406022241946631; … ; -0.4425074737967408; 0.06699618844951612;;]), layer_4 = (weight = [-0.408515495589385 0.14252237351883962 … -0.4890450878029103 -0.4456358237819436; 0.6960533096185048 0.19284564396788853 … -0.12108887455045497 -0.0010040293232103556; … ; 0.38447576637194436 0.37005969821320894 … -0.8008157496667178 -0.09842371426613565; 0.5079440329365821 -0.3090955392940469 … 0.022907794943616368 0.32804187294088816], bias = [-0.1273029631504913; -0.04916468577106584; … ; 0.10779107571031511; 0.07792192412791048;;]), layer_5 = (weight = [0.24615469201877566 -1.3582776603325277 … -1.3597782471056048 -0.719424430672108], bias = [0.053457939783605156;;])))</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../allen_cahn/">« Allen-Cahn Equation with Sequential Training</a><a class="docs-footer-nextpage" href="../L_shape/">Poisson equation over an L-shaped domain »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Tuesday 18 October 2022 22:42">Tuesday 18 October 2022</span>. Using Julia version 1.8.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
