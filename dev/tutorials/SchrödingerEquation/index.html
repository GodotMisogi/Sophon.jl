<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Schrödinger Equation: A PDE System with Resampling · Sophon.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://YichengDWu.github.io/Sophon.jl/tutorials/SchrödingerEquation/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/indigo.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Sophon.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../discontinuous/">Fitting a nonlinear discontinuous function</a></li><li><a class="tocitem" href="../poisson/">1D Multi-scale Poisson&#39;s Equation</a></li><li><a class="tocitem" href="../convection/">1D Convection Equation</a></li><li><a class="tocitem" href="../helmholtz/">2D Helmholtz Equation</a></li><li><a class="tocitem" href="../allen_cahn/">Allen-Cahn Equation with Sequential Training</a></li><li class="is-active"><a class="tocitem" href>Schrödinger Equation: A PDE System with Resampling</a><ul class="internal"><li><a class="tocitem" href="#Customize-Sampling"><span>Customize Sampling</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/YichengDWu/Sophon.jl/blob/main/docs/src/tutorials/SchrödingerEquation.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Schrödinger-equation"><a class="docs-heading-anchor" href="#Schrödinger-equation">Schrödinger equation</a><a id="Schrödinger-equation-1"></a><a class="docs-heading-anchor-permalink" href="#Schrödinger-equation" title="Permalink"></a></h1><p>The nonlinear Shrödinger equation is given by</p><p class="math-container">\[\mathrm{i} \partial_t \psi=-\frac{1}{2} \sigma \partial_{x x} \psi-\beta|\psi|^2 \psi\]</p><p>Let <span>$\sigma=\beta=1, \psi=u+v i$</span>, the equation can be transformed into a system of partial differential equations</p><pre><code class="language-julia hljs">using ModelingToolkit, IntervalSets, Sophon, CairoMakie
using Optimization, OptimizationOptimJL

@parameters x,t
@variables u(..), v(..)
Dₜ = Differential(t)
Dₓ² = Differential(x)^2

eqs=[Dₜ(u(x,t)) ~ -Dₓ²(v(x,t))/2 - (abs2(v(x,t)) + abs2(u(x,t))) * v(x,t),
     Dₜ(v(x,t)) ~  Dₓ²(u(x,t))/2 + (abs2(v(x,t)) + abs2(u(x,t))) * u(x,t)]

bcs = [u(x, 0.0) ~ 2sech(x),
       v(x, 0.0) ~ 0.0,
       u(-5.0, t) ~ u(5.0, t),
       v(-5.0, t) ~ v(5.0, t)]

domains = [x ∈ Interval(-5.0, 5.0),
           t ∈ Interval(0.0, π/2)]

@named pde_system = PDESystem(eqs, bcs, domains, [x,t], [u(x,t),v(x,t)])</code></pre><p class="math-container">\[ \begin{align}
\mathrm{\frac{d}{d t}}\left( u\left( x, t \right) \right) =&amp;  - \frac{1}{2} \frac{d(d / (d * x))(v(x, t))}{dx} - \left( \left|u\left( x, t \right)\right|^{2} + \left|v\left( x, t \right)\right|^{2} \right) v\left( x, t \right) \\
\mathrm{\frac{d}{d t}}\left( v\left( x, t \right) \right) =&amp; \frac{1}{2} \frac{d(d / (d * x))(u(x, t))}{dx} + \left( \left|u\left( x, t \right)\right|^{2} + \left|v\left( x, t \right)\right|^{2} \right) u\left( x, t \right)
\end{align}
 \]</p><pre><code class="language-julia hljs">pinn = PINN(u= Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0),
            v= Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0))

sampler = QuasiRandomSampler(2000, (500,500,20,20))
strategy = NonAdaptiveTraining(1,(10,10,1,1))

prob = Sophon.discretize(pde_system, pinn, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [0.42728346586227417 -0.1327851414680481; -0.4684029221534729 -0.14241516590118408; … ; 0.003534972667694092 -0.4943236708641052; 0.34025031328201294 -0.24406027793884277], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [-0.46340009570121765 0.297405481338501 … 0.42733246088027954 -0.2772058844566345; -0.3057611882686615 0.49849069118499756 … -0.049987442791461945 -0.40859559178352356; … ; 0.27506959438323975 0.6023591160774231 … 0.5780893564224243 0.2681575417518616; -0.48086342215538025 -0.14033670723438263 … 0.0067726923152804375 -0.25762686133384705], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [-0.21988984942436218 0.298500120639801 … 0.3151273727416992 -0.2519955337047577; -0.2024763971567154 -0.5366206765174866 … 0.31107088923454285 -0.4191961884498596; … ; -0.09753163158893585 0.4352128803730011 … -0.15128758549690247 -0.2319406270980835; 0.43752580881118774 0.31005552411079407 … 0.3877907991409302 0.5113892555236816], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [0.2646927237510681 0.01235051266849041 … -0.47926515340805054 -0.5034282207489014; -0.5415496230125427 0.09407783299684525 … 0.4509643316268921 -0.05882619321346283; … ; 0.028637869283556938 -0.4568899869918823 … -0.20149832963943481 0.10795588046312332; -0.02693389169871807 -0.3942115008831024 … 0.48606958985328674 0.2989552915096283], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [-0.3239469826221466 0.41890740394592285 … -0.5229502320289612 -0.007261722814291716], bias = [0.0;;])), v = (layer_1 = (weight = [0.32291728258132935 -0.1765328049659729; -0.12232851982116699 -0.29459500312805176; … ; -0.011238634586334229 -0.14210355281829834; 0.09265273809432983 -0.13849586248397827], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [0.38508182764053345 0.13138020038604736 … 0.5055306553840637 0.5865230560302734; 0.13289737701416016 0.36315593123435974 … 0.13845935463905334 -0.1121862605214119; … ; -0.3516481816768646 -0.5245376229286194 … -0.4293724596500397 -0.032029688358306885; 0.21032766997814178 0.15930800139904022 … -0.08926783502101898 0.563927173614502], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [0.40220022201538086 0.01709350012242794 … -0.4335878789424896 0.09507057070732117; -0.4948742687702179 0.07379253208637238 … -0.12152338773012161 0.16315658390522003; … ; 0.5513491630554199 -0.4137018918991089 … 0.13773423433303833 -0.143366739153862; 0.057614751160144806 -0.24311794340610504 … 0.5900682210922241 0.3679569363594055], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [0.0618288516998291 0.3494175970554352 … 0.052961189299821854 0.372038334608078; -0.3130166232585907 0.09909070283174515 … -0.12440340220928192 -0.045598506927490234; … ; 0.16415318846702576 -0.04015420377254486 … 0.5940622687339783 -0.11107657849788666; -0.506714403629303 -0.1516980677843094 … -0.14486302435398102 -0.5395788550376892], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [-0.10189129412174225 -0.1344207525253296 … 0.5033119320869446 0.18430890142917633], bias = [0.0;;])))</code></pre><p>Now we train the neural nets and resample data while training.</p><pre><code class="language-julia hljs">function train(pde_system, prob, sampler, strategy, resample_period = 500, n=10)
     bfgs = BFGS()
     res = Optimization.solve(prob, bfgs; maxiters=2000)

     for i in 1:n
         data = Sophon.sample(pde_system, sampler, strategy)
         prob = remake(prob; u0=res.u, p=data)
         res = Optimization.solve(prob, bfgs; maxiters=resample_period)
     end
     return res
end

res = train(pde_system, prob, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">u: ComponentVector{Float64}(u = (layer_1 = (weight = [0.8940720296811512 -0.28322833026478345; -0.7496771396547344 -0.2202428719643464; … ; 0.0026774907553603544 -0.6974461348174779; 0.5837645393451091 -0.24107503776582856], bias = [0.5270668794301013; 0.03143174202121802; … ; 0.19350446988519251; -0.2460805385620244;;]), layer_2 = (weight = [-0.33943136184049316 0.0804202155940775 … 0.24386613495695447 0.07325417414106652; -0.17458734675367957 0.4664200855118976 … -0.11523153257314485 -0.46761542996970495; … ; 0.34817017004181794 0.5137158697666522 … 0.6522025218892056 0.5084717901508868; -0.14394189564883936 -0.3304666146491 … 0.07558512663915791 -0.1832138304008408], bias = [-0.18327742583858977; 0.2910678554633676; … ; 0.23824096647900309; 0.13046430270594175;;]), layer_3 = (weight = [-0.20171291454628829 0.25592952678674274 … 0.15360162677056388 -0.12232213958814568; 0.2665066819246877 -0.41574518039738056 … 0.4245328463275962 -0.3402733488023564; … ; -0.26372070413143617 0.5049191318420433 … -0.40409858469539944 0.029052771433385888; 0.41049189233912303 0.6415050324090038 … 0.6740106730747382 0.7864221241717897], bias = [-0.04135742441420207; -0.005090077540988985; … ; -0.20229621201620804; -0.23356203735456982;;]), layer_4 = (weight = [0.42798839864085675 -0.9244309771287584 … -0.7590326615899502 -0.7898888108704942; -0.3006058708301254 -0.44966248770750117 … 0.4204635200856864 -0.30486834553781045; … ; -0.3254031306604972 0.13870167107774978 … -0.5515133601230133 0.08522325728118157; -0.12574782092614345 -0.5768647240984864 … 0.43946093688758303 0.652797240034507], bias = [0.6748853614816662; 0.3781248411144671; … ; -0.06065876150706471; -0.2684107099619762;;]), layer_5 = (weight = [-0.14097588052928792 0.541616750940518 … -1.060097063585471 0.41045813785465746], bias = [0.09259858355441256;;])), v = (layer_1 = (weight = [1.1257426595764366 -1.0216442692602543; -0.667352754407631 -0.16701357619281454; … ; 0.04262180405043304 0.13312656731127606; 0.5544104364237511 0.08578084151972451], bias = [0.7137269864789213; 0.018621411852348994; … ; -0.17805683903118003; -0.13861071364460859;;]), layer_2 = (weight = [-0.2540790823306417 0.20003447734443958 … 0.40420345726211165 0.5801515867909444; 0.14076603159045267 0.15002367658567242 … -0.059780788114444504 0.01962396785797627; … ; -0.15898309605344593 -0.34121228380897367 … -0.4746338462409937 -0.007012958112956679; 0.2625812547219181 0.004317480482319282 … 0.10338332587125895 0.498333316724648], bias = [-0.21599521783067033; 0.20567656286882927; … ; 0.248590934329758; -0.36528731964165334;;]), layer_3 = (weight = [0.507770356823646 -0.0354510114843421 … -0.6263628155033467 0.13615411296323265; -0.7644542153789857 -0.08444962356975791 … -0.2713485902891541 0.6234257710037233; … ; 0.5220485170593653 -0.5084759458185176 … 0.10873952688055677 -0.1535334406340726; -0.3160181970921389 -0.23244663030328622 … 0.32029467443778226 0.25943986305737216], bias = [0.05571270685416842; -0.384261760427402; … ; 0.3054855651690723; -0.04781611983280788;;]), layer_4 = (weight = [-0.13938649962359392 0.3287768135373691 … -0.05748056514333685 0.5138121504976764; -0.21468370195312828 0.2514077560284737 … -0.2568855078514788 0.007436825137593408; … ; 0.2975762146880499 0.2801782947860907 … 0.6821507570102695 -0.19034306918217941; -0.4670319057174582 -0.8076989462907854 … -0.23645187928969513 -0.6521671139795027], bias = [0.1098570567722745; -0.15889553578261084; … ; 0.4014970048716537; -0.1926524076178524;;]), layer_5 = (weight = [-0.46670543187709707 -0.022661873133712006 … 1.1398432970389527 0.03269262366836516], bias = [-0.12143554112420075;;])))</code></pre><pre><code class="language-julia hljs">phi = pinn.phi
ps = res.u

xs, ts= [infimum(d.domain):0.01:supremum(d.domain) for d in pde_system.domain]

u = [sum(phi.u(([x,t]), ps.u)) for x in xs, t in ts]
v = [sum(phi.v(([x,t]), ps.v)) for x in xs, t in ts]
ψ = @. sqrt(u^2+ v^2)

axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;u&quot;)
fig, ax1, hm1 = CairoMakie.heatmap(ts, xs, u&#39;, axis=axis)
ax2, hm2= CairoMakie.heatmap(fig[1, end+1], ts, xs, v&#39;, axis= merge(axis, (; title=&quot;v&quot;)))
display(fig)</code></pre><p><img src="../uv.png" alt/></p><pre><code class="language-julia hljs">axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;ψ&quot;)
fig, ax1, hm1 = CairoMakie.heatmap(ts, xs, ψ&#39;, axis=axis)
Colorbar(fig[:, end+1], hm1)
display(fig)</code></pre><p><img src="../phi.png" alt/></p><h2 id="Customize-Sampling"><a class="docs-heading-anchor" href="#Customize-Sampling">Customize Sampling</a><a id="Customize-Sampling-1"></a><a class="docs-heading-anchor-permalink" href="#Customize-Sampling" title="Permalink"></a></h2><p>Bascially any sampling method is supportted.</p><pre><code class="language-julia hljs">using StatsBase

data = vec([[x, t] for x in xs, t in ts])
wv = vec(ψ)
new_data = wsample(data, wv, 2000)
new_data = reduce(hcat, new_data)
fig, ax = scatter(new_data[2,:], new_data[1,:])</code></pre><p><img src="../data.png" alt/></p><pre><code class="language-julia hljs">prob.p[1] = new_data
prob.p[2] = new_data
prob = remake(prob; u0 = res.u)
# res = Optimization.solve(prob, bfgs; maxiters=1000)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [0.8940720296811512 -0.28322833026478345; -0.7496771396547344 -0.2202428719643464; … ; 0.0026774907553603544 -0.6974461348174779; 0.5837645393451091 -0.24107503776582856], bias = [0.5270668794301013; 0.03143174202121802; … ; 0.19350446988519251; -0.2460805385620244;;]), layer_2 = (weight = [-0.33943136184049316 0.0804202155940775 … 0.24386613495695447 0.07325417414106652; -0.17458734675367957 0.4664200855118976 … -0.11523153257314485 -0.46761542996970495; … ; 0.34817017004181794 0.5137158697666522 … 0.6522025218892056 0.5084717901508868; -0.14394189564883936 -0.3304666146491 … 0.07558512663915791 -0.1832138304008408], bias = [-0.18327742583858977; 0.2910678554633676; … ; 0.23824096647900309; 0.13046430270594175;;]), layer_3 = (weight = [-0.20171291454628829 0.25592952678674274 … 0.15360162677056388 -0.12232213958814568; 0.2665066819246877 -0.41574518039738056 … 0.4245328463275962 -0.3402733488023564; … ; -0.26372070413143617 0.5049191318420433 … -0.40409858469539944 0.029052771433385888; 0.41049189233912303 0.6415050324090038 … 0.6740106730747382 0.7864221241717897], bias = [-0.04135742441420207; -0.005090077540988985; … ; -0.20229621201620804; -0.23356203735456982;;]), layer_4 = (weight = [0.42798839864085675 -0.9244309771287584 … -0.7590326615899502 -0.7898888108704942; -0.3006058708301254 -0.44966248770750117 … 0.4204635200856864 -0.30486834553781045; … ; -0.3254031306604972 0.13870167107774978 … -0.5515133601230133 0.08522325728118157; -0.12574782092614345 -0.5768647240984864 … 0.43946093688758303 0.652797240034507], bias = [0.6748853614816662; 0.3781248411144671; … ; -0.06065876150706471; -0.2684107099619762;;]), layer_5 = (weight = [-0.14097588052928792 0.541616750940518 … -1.060097063585471 0.41045813785465746], bias = [0.09259858355441256;;])), v = (layer_1 = (weight = [1.1257426595764366 -1.0216442692602543; -0.667352754407631 -0.16701357619281454; … ; 0.04262180405043304 0.13312656731127606; 0.5544104364237511 0.08578084151972451], bias = [0.7137269864789213; 0.018621411852348994; … ; -0.17805683903118003; -0.13861071364460859;;]), layer_2 = (weight = [-0.2540790823306417 0.20003447734443958 … 0.40420345726211165 0.5801515867909444; 0.14076603159045267 0.15002367658567242 … -0.059780788114444504 0.01962396785797627; … ; -0.15898309605344593 -0.34121228380897367 … -0.4746338462409937 -0.007012958112956679; 0.2625812547219181 0.004317480482319282 … 0.10338332587125895 0.498333316724648], bias = [-0.21599521783067033; 0.20567656286882927; … ; 0.248590934329758; -0.36528731964165334;;]), layer_3 = (weight = [0.507770356823646 -0.0354510114843421 … -0.6263628155033467 0.13615411296323265; -0.7644542153789857 -0.08444962356975791 … -0.2713485902891541 0.6234257710037233; … ; 0.5220485170593653 -0.5084759458185176 … 0.10873952688055677 -0.1535334406340726; -0.3160181970921389 -0.23244663030328622 … 0.32029467443778226 0.25943986305737216], bias = [0.05571270685416842; -0.384261760427402; … ; 0.3054855651690723; -0.04781611983280788;;]), layer_4 = (weight = [-0.13938649962359392 0.3287768135373691 … -0.05748056514333685 0.5138121504976764; -0.21468370195312828 0.2514077560284737 … -0.2568855078514788 0.007436825137593408; … ; 0.2975762146880499 0.2801782947860907 … 0.6821507570102695 -0.19034306918217941; -0.4670319057174582 -0.8076989462907854 … -0.23645187928969513 -0.6521671139795027], bias = [0.1098570567722745; -0.15889553578261084; … ; 0.4014970048716537; -0.1926524076178524;;]), layer_5 = (weight = [-0.46670543187709707 -0.022661873133712006 … 1.1398432970389527 0.03269262366836516], bias = [-0.12143554112420075;;])))</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../allen_cahn/">« Allen-Cahn Equation with Sequential Training</a><a class="docs-footer-nextpage" href="../../references/">References »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Friday 7 October 2022 19:54">Friday 7 October 2022</span>. Using Julia version 1.8.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
