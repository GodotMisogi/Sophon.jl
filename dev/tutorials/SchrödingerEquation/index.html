<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Schrödinger Equation: A PDE System with Resampling · Sophon.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://YichengDWu.github.io/Sophon.jl/tutorials/SchrödingerEquation/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/indigo.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Sophon.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../discontinuous/">Fitting a nonlinear discontinuous function</a></li><li><a class="tocitem" href="../poisson/">1D Multi-scale Poisson&#39;s Equation</a></li><li><a class="tocitem" href="../convection/">1D Convection Equation</a></li><li><a class="tocitem" href="../helmholtz/">2D Helmholtz Equation</a></li><li><a class="tocitem" href="../allen_cahn/">Allen-Cahn Equation with Sequential Training</a></li><li class="is-active"><a class="tocitem" href>Schrödinger Equation: A PDE System with Resampling</a><ul class="internal"><li><a class="tocitem" href="#Customize-Sampling"><span>Customize Sampling</span></a></li></ul></li><li><a class="tocitem" href="../L_shape/">Poisson equation over an L-shaped domain</a></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/YichengDWu/Sophon.jl/blob/main/docs/src/tutorials/SchrödingerEquation.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Schrödinger-equation"><a class="docs-heading-anchor" href="#Schrödinger-equation">Schrödinger equation</a><a id="Schrödinger-equation-1"></a><a class="docs-heading-anchor-permalink" href="#Schrödinger-equation" title="Permalink"></a></h1><p>The nonlinear Shrödinger equation is given by</p><p class="math-container">\[\mathrm{i} \partial_t \psi=-\frac{1}{2} \sigma \partial_{x x} \psi-\beta|\psi|^2 \psi\]</p><p>Let <span>$\sigma=\beta=1, \psi=u+v i$</span>, the equation can be transformed into a system of partial differential equations</p><pre><code class="language-julia hljs">using ModelingToolkit, IntervalSets, Sophon, CairoMakie
using Optimization, OptimizationOptimJL

@parameters x,t
@variables u(..), v(..)
Dₜ = Differential(t)
Dₓ² = Differential(x)^2

eqs=[Dₜ(u(x,t)) ~ -Dₓ²(v(x,t))/2 - (abs2(v(x,t)) + abs2(u(x,t))) * v(x,t),
     Dₜ(v(x,t)) ~  Dₓ²(u(x,t))/2 + (abs2(v(x,t)) + abs2(u(x,t))) * u(x,t)]

bcs = [u(x, 0.0) ~ 2sech(x),
       v(x, 0.0) ~ 0.0,
       u(-5.0, t) ~ u(5.0, t),
       v(-5.0, t) ~ v(5.0, t)]

domains = [x ∈ Interval(-5.0, 5.0),
           t ∈ Interval(0.0, π/2)]

@named pde_system = PDESystem(eqs, bcs, domains, [x,t], [u(x,t),v(x,t)])</code></pre><p class="math-container">\[ \begin{align}
\frac{\mathrm{d}}{\mathrm{d}t} u\left( x, t \right) =&amp;  - \frac{1}{2} \frac{\mathrm{d}^{2}}{\mathrm{d}x^{2}} v\left( x, t \right) - \left( \left|u\left( x, t \right)\right|^{2} + \left|v\left( x, t \right)\right|^{2} \right) v\left( x, t \right) \\
\frac{\mathrm{d}}{\mathrm{d}t} v\left( x, t \right) =&amp; \frac{1}{2} \frac{\mathrm{d}^{2}}{\mathrm{d}x^{2}} u\left( x, t \right) + \left( \left|u\left( x, t \right)\right|^{2} + \left|v\left( x, t \right)\right|^{2} \right) u\left( x, t \right)
\end{align}
 \]</p><pre><code class="language-julia hljs">pinn = PINN(u = Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0),
            v = Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0))

sampler = QuasiRandomSampler(500, (200,200,20,20))
strategy = NonAdaptiveTraining(1,(10,10,1,1))

prob = Sophon.discretize(pde_system, pinn, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [0.13239949941635132 -0.11569368839263916; 0.016242504119873047 0.16965597867965698; … ; 0.01141899824142456 -0.19388431310653687; -0.39429646730422974 -0.08619248867034912], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [-0.45890721678733826 0.3498145639896393 … 0.14227041602134705 -0.3979487419128418; -0.40630388259887695 -0.3550855815410614 … 0.4811094403266907 0.4007440209388733; … ; 0.1397782564163208 0.04213375970721245 … -0.22574551403522491 0.03268231451511383; -0.07618936151266098 0.30303484201431274 … 0.5186065435409546 0.33943748474121094], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [-0.39235690236091614 -0.179341658949852 … 0.51703941822052 -0.21860015392303467; -0.4871424734592438 -0.330032616853714 … 0.2223626673221588 -0.10054925084114075; … ; -0.1784725934267044 -0.16784043610095978 … -0.08618991076946259 0.6098586320877075; 0.5900102853775024 0.5180321335792542 … -0.31032276153564453 0.38519221544265747], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [-0.1985250860452652 0.3887560963630676 … -0.01751588098704815 0.06293429434299469; 0.49095574021339417 0.39155441522598267 … 0.43918219208717346 -0.19466562569141388; … ; -0.13350450992584229 0.320620596408844 … 0.3813755214214325 0.38015326857566833; -0.262117862701416 0.20687970519065857 … 0.3189503252506256 0.39432185888290405], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [-0.3401663303375244 0.10608531534671783 … 0.17626453936100006 0.3228627145290375], bias = [0.0;;])), v = (layer_1 = (weight = [0.36633002758026123 0.306968629360199; -0.06499016284942627 0.39312291145324707; … ; 0.09971225261688232 0.40318602323532104; 0.13849347829818726 -0.44069457054138184], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [-0.5227208137512207 -0.3471564054489136 … 0.361698180437088 0.09534789621829987; -0.5474551916122437 -0.37991711497306824 … 0.07933823764324188 -0.44301626086235046; … ; -0.11272558569908142 -0.36530008912086487 … 0.6097482442855835 -0.40356117486953735; 0.2239963412284851 -0.3334202766418457 … -0.4872857928276062 -0.06403478235006332], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [-0.49721136689186096 -0.18716716766357422 … -0.20854492485523224 0.14952075481414795; -0.0655040591955185 -0.5273680090904236 … 0.3815164864063263 -0.5690386295318604; … ; 0.5454001426696777 0.3202531039714813 … -0.21636663377285004 -0.4516260027885437; -0.553777277469635 -0.04074952378869057 … -0.43519848585128784 -0.5968796610832214], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [-0.5596123933792114 0.20394107699394226 … -0.20667004585266113 -0.20469509065151215; 0.0861278623342514 0.1535598635673523 … 0.34174275398254395 -0.30394405126571655; … ; -0.47293293476104736 -0.4682917892932892 … -0.20895838737487793 -0.5564195513725281; -0.20972095429897308 0.6072039604187012 … -0.5431708097457886 -0.23960508406162262], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [0.07723348587751389 0.40997016429901123 … 0.12291856855154037 -0.2352716326713562], bias = [0.0;;])))</code></pre><p>Now we train the neural nets and resample data while training.</p><pre><code class="language-julia hljs">function train(pde_system, prob, sampler, strategy, resample_period = 500, n=10)
     bfgs = BFGS()
     res = Optimization.solve(prob, bfgs; maxiters=2000)

     for i in 1:n
         data = Sophon.sample(pde_system, sampler)
         prob = remake(prob; u0=res.u, p=data)
         res = Optimization.solve(prob, bfgs; maxiters=resample_period)
     end
     return res
end

res = train(pde_system, prob, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">u: ComponentVector{Float64}(u = (layer_1 = (weight = [0.2562963107779163 -0.9071029997269319; 0.46358239842282023 -0.3599491050552239; … ; 0.3810208716395275 0.36666299035097993; -1.1886699342389098 0.6567542754921203], bias = [0.4222086167806161; 0.11183751139707637; … ; -0.19553120463985393; -0.42872112842891974;;]), layer_2 = (weight = [-0.4707716507899031 0.1523274120934733 … 0.2770158876484003 -0.3399305847868161; -0.7456582943260259 -0.8058154463780538 … 0.5468592443844085 0.47860767704223117; … ; 0.16275357502385387 0.0737687338960566 … -0.17067286853340866 -0.0021787718547530825; -0.5741651760949478 0.23103641265458813 … 0.729345272287918 0.28606134260206845], bias = [0.33486411170400066; -0.21085299566123342; … ; 0.0702620140071788; -0.4727869492195958;;]), layer_3 = (weight = [-0.4028329899945101 -0.4526226345620886 … 0.49734804077170314 -0.048580444968372175; -0.3714647129601927 -0.2227108092923081 … 0.2115000866908028 0.14000170481178184; … ; -0.21129047746122628 -0.14563449590931107 … 0.5307916233609559 0.375862985470321; 0.32232252341550194 0.25995301790087866 … 0.1318452927436277 0.28485108265846387], bias = [0.07252698931527202; -0.0737186303532677; … ; 0.564403757097514; 0.11338664278506194;;]), layer_4 = (weight = [0.024245818528394636 0.17759672542971633 … -0.37890174262387655 -0.019657400487165258; 0.37780462240124035 0.5129534504471214 … 0.6685246873562225 -0.3591767582775725; … ; -0.13258961626000487 0.39983607539505667 … 0.5008257728244183 0.4544908537058077; -0.2947647399665352 0.25320049996464716 … 0.6474812434720411 0.2284234718697055], bias = [-0.3111162246907132; 0.27995934148819956; … ; 0.2168353863710621; 0.12450489959737715;;]), layer_5 = (weight = [-0.379766857334633 0.4445114831267004 … 0.6383149950695535 0.32142751533421277], bias = [-0.015315838388682317;;])), v = (layer_1 = (weight = [0.5836426665179948 0.20359540225839667; 0.28509707566982917 0.25369162749516483; … ; 0.23853370422557196 0.6215322480461145; 0.3183666554747332 -0.22021424401652565], bias = [0.4679842058483372; -0.17045593184308858; … ; -0.3971054228535196; -0.2173158871319133;;]), layer_2 = (weight = [-0.2902305888996479 -0.7858868369721455 … -0.0768603767834839 0.2721978818294402; -0.5079311436993844 -0.22313247540713432 … 0.32826539609130817 -0.3705096522986598; … ; -0.25159752122048384 -0.3700476889863834 … 0.7606203492950502 -0.47310319549894897; 0.024118001571863296 -0.5374226295201521 … -0.5796759306515088 0.02462169796784802], bias = [-0.11591251358479297; -0.3103236818635095; … ; 0.5571098793135976; 0.2792013730805088;;]), layer_3 = (weight = [-0.4069295003620682 -0.39924000232508616 … 0.1048806797976415 -0.06336915885161122; -0.33589538040265876 -0.8624404751391956 … 0.2085113587014106 -0.3677535904671766; … ; 0.7561073696671159 0.22871066609949575 … -0.4362998625776673 0.6302690248347859; -0.5445359752679609 0.2494090068420753 … -0.03325019192403905 -0.5797295273694101], bias = [0.20279421384968116; -0.12715059086742111; … ; -0.4422447939716798; -0.2983745037720211;;]), layer_4 = (weight = [-0.5114851894638648 0.28816403019189796 … -0.13680925979529585 0.054030615924100626; -0.17676650347147013 0.14461671821638278 … 0.2582604015570773 -0.3895923247261905; … ; -0.5453393390799287 -0.4544054229066075 … -0.11840174154275641 -1.1161153056425708; -0.15384730530176616 0.838449903507299 … -0.6084918747100138 0.07168673396690345], bias = [0.06604866363557142; -0.4538108928911021; … ; 0.020849402721891955; 0.14233064660908212;;]), layer_5 = (weight = [0.31734780660344836 0.7225399958061776 … 0.2591592198802424 -0.9828915679959727], bias = [0.5695851512337388;;])))</code></pre><pre><code class="language-julia hljs">phi = pinn.phi
ps = res.u

xs, ts= [infimum(d.domain):0.01:supremum(d.domain) for d in pde_system.domain]

u = [sum(phi.u(([x,t]), ps.u)) for x in xs, t in ts]
v = [sum(phi.v(([x,t]), ps.v)) for x in xs, t in ts]
ψ = @. sqrt(u^2+ v^2)

axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;u&quot;)
fig, ax1, hm1 = heatmap(ts, xs, u&#39;, axis=axis)
ax2, hm2= heatmap(fig[1, end+1], ts, xs, v&#39;, axis= merge(axis, (; title=&quot;v&quot;)))
display(fig)</code></pre><p><img src="../uv.png" alt/></p><pre><code class="language-julia hljs">axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;ψ&quot;)
fig, ax1, hm1 = heatmap(ts, xs, ψ&#39;, axis=axis, colormap=:jet)
Colorbar(fig[:, end+1], hm1)
display(fig)</code></pre><p><img src="../phi.png" alt/></p><h2 id="Customize-Sampling"><a class="docs-heading-anchor" href="#Customize-Sampling">Customize Sampling</a><a id="Customize-Sampling-1"></a><a class="docs-heading-anchor-permalink" href="#Customize-Sampling" title="Permalink"></a></h2><p>Bascially any sampling method is supportted. For example we can sample data according to the predicted solution.</p><pre><code class="language-julia hljs">using StatsBase

data = vec([[x, t] for x in xs, t in ts])
wv = vec(ψ)
new_data = wsample(data, wv, 500)
new_data = reduce(hcat, new_data)
fig, ax = scatter(new_data[2,:], new_data[1,:])</code></pre><p><img src="../data.png" alt/></p><pre><code class="language-julia hljs">prob.p[1] = new_data
prob.p[2] = new_data
prob = remake(prob; u0 = res.u)
# res = Optimization.solve(prob, bfgs; maxiters=1000)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [0.2562963107779163 -0.9071029997269319; 0.46358239842282023 -0.3599491050552239; … ; 0.3810208716395275 0.36666299035097993; -1.1886699342389098 0.6567542754921203], bias = [0.4222086167806161; 0.11183751139707637; … ; -0.19553120463985393; -0.42872112842891974;;]), layer_2 = (weight = [-0.4707716507899031 0.1523274120934733 … 0.2770158876484003 -0.3399305847868161; -0.7456582943260259 -0.8058154463780538 … 0.5468592443844085 0.47860767704223117; … ; 0.16275357502385387 0.0737687338960566 … -0.17067286853340866 -0.0021787718547530825; -0.5741651760949478 0.23103641265458813 … 0.729345272287918 0.28606134260206845], bias = [0.33486411170400066; -0.21085299566123342; … ; 0.0702620140071788; -0.4727869492195958;;]), layer_3 = (weight = [-0.4028329899945101 -0.4526226345620886 … 0.49734804077170314 -0.048580444968372175; -0.3714647129601927 -0.2227108092923081 … 0.2115000866908028 0.14000170481178184; … ; -0.21129047746122628 -0.14563449590931107 … 0.5307916233609559 0.375862985470321; 0.32232252341550194 0.25995301790087866 … 0.1318452927436277 0.28485108265846387], bias = [0.07252698931527202; -0.0737186303532677; … ; 0.564403757097514; 0.11338664278506194;;]), layer_4 = (weight = [0.024245818528394636 0.17759672542971633 … -0.37890174262387655 -0.019657400487165258; 0.37780462240124035 0.5129534504471214 … 0.6685246873562225 -0.3591767582775725; … ; -0.13258961626000487 0.39983607539505667 … 0.5008257728244183 0.4544908537058077; -0.2947647399665352 0.25320049996464716 … 0.6474812434720411 0.2284234718697055], bias = [-0.3111162246907132; 0.27995934148819956; … ; 0.2168353863710621; 0.12450489959737715;;]), layer_5 = (weight = [-0.379766857334633 0.4445114831267004 … 0.6383149950695535 0.32142751533421277], bias = [-0.015315838388682317;;])), v = (layer_1 = (weight = [0.5836426665179948 0.20359540225839667; 0.28509707566982917 0.25369162749516483; … ; 0.23853370422557196 0.6215322480461145; 0.3183666554747332 -0.22021424401652565], bias = [0.4679842058483372; -0.17045593184308858; … ; -0.3971054228535196; -0.2173158871319133;;]), layer_2 = (weight = [-0.2902305888996479 -0.7858868369721455 … -0.0768603767834839 0.2721978818294402; -0.5079311436993844 -0.22313247540713432 … 0.32826539609130817 -0.3705096522986598; … ; -0.25159752122048384 -0.3700476889863834 … 0.7606203492950502 -0.47310319549894897; 0.024118001571863296 -0.5374226295201521 … -0.5796759306515088 0.02462169796784802], bias = [-0.11591251358479297; -0.3103236818635095; … ; 0.5571098793135976; 0.2792013730805088;;]), layer_3 = (weight = [-0.4069295003620682 -0.39924000232508616 … 0.1048806797976415 -0.06336915885161122; -0.33589538040265876 -0.8624404751391956 … 0.2085113587014106 -0.3677535904671766; … ; 0.7561073696671159 0.22871066609949575 … -0.4362998625776673 0.6302690248347859; -0.5445359752679609 0.2494090068420753 … -0.03325019192403905 -0.5797295273694101], bias = [0.20279421384968116; -0.12715059086742111; … ; -0.4422447939716798; -0.2983745037720211;;]), layer_4 = (weight = [-0.5114851894638648 0.28816403019189796 … -0.13680925979529585 0.054030615924100626; -0.17676650347147013 0.14461671821638278 … 0.2582604015570773 -0.3895923247261905; … ; -0.5453393390799287 -0.4544054229066075 … -0.11840174154275641 -1.1161153056425708; -0.15384730530176616 0.838449903507299 … -0.6084918747100138 0.07168673396690345], bias = [0.06604866363557142; -0.4538108928911021; … ; 0.020849402721891955; 0.14233064660908212;;]), layer_5 = (weight = [0.31734780660344836 0.7225399958061776 … 0.2591592198802424 -0.9828915679959727], bias = [0.5695851512337388;;])))</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../allen_cahn/">« Allen-Cahn Equation with Sequential Training</a><a class="docs-footer-nextpage" href="../L_shape/">Poisson equation over an L-shaped domain »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Friday 21 October 2022 20:52">Friday 21 October 2022</span>. Using Julia version 1.8.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
