<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Schrödinger Equation: A PDE System with Resampling · Sophon.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://YichengDWu.github.io/Sophon.jl/tutorials/SchrödingerEquation/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/indigo.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Sophon.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../discontinuous/">Fitting a nonlinear discontinuous function</a></li><li><a class="tocitem" href="../poisson/">1D Multi-scale Poisson&#39;s Equation</a></li><li><a class="tocitem" href="../convection/">1D Convection Equation</a></li><li><a class="tocitem" href="../helmholtz/">2D Helmholtz Equation</a></li><li><a class="tocitem" href="../allen_cahn/">Allen-Cahn Equation with Sequential Training</a></li><li class="is-active"><a class="tocitem" href>Schrödinger Equation: A PDE System with Resampling</a><ul class="internal"><li><a class="tocitem" href="#Customize-Sampling"><span>Customize Sampling</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/YichengDWu/Sophon.jl/blob/main/docs/src/tutorials/SchrödingerEquation.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Schrödinger-equation"><a class="docs-heading-anchor" href="#Schrödinger-equation">Schrödinger equation</a><a id="Schrödinger-equation-1"></a><a class="docs-heading-anchor-permalink" href="#Schrödinger-equation" title="Permalink"></a></h1><p>The nonlinear Shrödinger equation is given by</p><p class="math-container">\[\mathrm{i} \partial_t \psi=-\frac{1}{2} \sigma \partial_{x x} \psi-\beta|\psi|^2 \psi\]</p><p>Let <span>$\sigma=\beta=1, \psi=u+v i$</span>, the equation can be transformed into a system of partial differential equations</p><p class="math-container">\[u_t+\frac{1}{2} v_{x x}+\left(u^2+v^2\right) v=0\]</p><p class="math-container">\[v_t-\frac{1}{2} u_{x x}-\left(u^2+v^2\right) u=0\]</p><pre><code class="language-julia hljs">using ModelingToolkit, IntervalSets, Sophon, CairoMakie
using Optimization, OptimizationOptimJL

@parameters x,t
@variables u(..), v(..)
Dₜ = Differential(t)
Dₓ² = Differential(x)^2

eqs=[Dₜ(u(x,t)) ~ -Dₓ²(v(x,t))/2 - ((v(x,t))^2 + (u(x,t))^2) * v(x,t),
     Dₜ(v(x,t)) ~  Dₓ²(u(x,t))/2 + ((v(x,t))^2 + (u(x,t))^2) * u(x,t)]

bcs = [u(x, 0.0) ~ 2sech(x),
       v(x, 0.0) ~ 0.0,
       u(-5.0, t) ~ u(5.0, t),
       v(-5.0, t) ~ v(5.0, t)]

domains = [x ∈ Interval(-5.0, 5.0),
           t ∈ Interval(0.0, π/2)]

@named pde_system = PDESystem(eqs, bcs, domains, [x,t], [u(x,t),v(x,t)])</code></pre><p class="math-container">\[ \begin{align}
\mathrm{\frac{d}{d t}}\left( u\left( x, t \right) \right) =&amp;  - \frac{1}{2} \frac{d(d / (d * x))(v(x, t))}{dx} - \left( \left( u\left( x, t \right) \right)^{2} + \left( v\left( x, t \right) \right)^{2} \right) v\left( x, t \right) \\
\mathrm{\frac{d}{d t}}\left( v\left( x, t \right) \right) =&amp; \frac{1}{2} \frac{d(d / (d * x))(u(x, t))}{dx} + \left( \left( u\left( x, t \right) \right)^{2} + \left( v\left( x, t \right) \right)^{2} \right) u\left( x, t \right)
\end{align}
 \]</p><pre><code class="language-julia hljs">pinn = PINN(u= Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0),
            v= Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0))

sampler = QuasiRandomSampler(2000, (500,500,20,20))
strategy = NonAdaptiveTraining(1,(10,10,1,1))

prob = Sophon.discretize(pde_system, pinn, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [-0.4179150462150574 0.2636811137199402; 0.02826094627380371 0.44124507904052734; … ; -0.4975891709327698 0.2247096300125122; -0.3592725992202759 0.35641396045684814], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [0.5741332769393921 -0.32744789123535156 … -0.05187574774026871 0.5644803643226624; -0.5974627733230591 0.4217303395271301 … -0.12245742976665497 0.01061675138771534; … ; -0.08742310851812363 0.5012434124946594 … -0.056994903832674026 0.047066621482372284; 0.027677547186613083 -0.3470286428928375 … -0.2488076090812683 0.2878611087799072], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [0.5075899362564087 0.4723852276802063 … 0.3146309554576874 0.2563956379890442; -0.02473657764494419 0.417345255613327 … -0.14954374730587006 0.5384799838066101; … ; 0.40195974707603455 0.5467296838760376 … 0.587877094745636 -0.06301328539848328; -0.4555997848510742 -0.29602935910224915 … 0.43953055143356323 -0.27260932326316833], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [-0.0366412028670311 -0.16920430958271027 … 0.51924729347229 0.10935062915086746; -0.4661964476108551 -0.019201243296265602 … -0.0177921149879694 0.018240921199321747; … ; -0.07079090178012848 -0.5454520583152771 … 0.42413562536239624 -0.07775565981864929; 0.09717575460672379 -0.2943935692310333 … -0.26312562823295593 0.473766028881073], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [0.21843086183071136 0.5647084712982178 … 0.1041443794965744 0.03654257953166962], bias = [0.0;;])), v = (layer_1 = (weight = [0.3956557512283325 0.20519763231277466; 0.1759137511253357 0.3152456283569336; … ; -0.43647879362106323 0.03819119930267334; 0.13962185382843018 -0.05353522300720215], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [-0.03358219191431999 0.44748440384864807 … 0.44828054308891296 0.32899051904678345; -0.39070942997932434 -0.11210165172815323 … 0.5937212109565735 -0.22456501424312592; … ; 0.23805579543113708 -0.23021744191646576 … 0.15420496463775635 0.3119660019874573; -0.4104331433773041 -0.3110480308532715 … 0.4053996801376343 0.19973157346248627], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [-0.49609869718551636 0.20396998524665833 … 0.01156677957624197 0.5842673778533936; -0.19351769983768463 -0.1608899086713791 … 0.10451412945985794 -0.19987289607524872; … ; 0.21042943000793457 0.1867266148328781 … -0.3661879897117615 0.06151151657104492; 0.2074192464351654 -0.29173633456230164 … -0.30369776487350464 -0.47654661536216736], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [-0.3297288417816162 -0.4310257136821747 … 0.5773992538452148 0.19921495020389557; 0.29812899231910706 0.47605422139167786 … -0.17654918134212494 0.3410261273384094; … ; -0.3741524815559387 -0.22840958833694458 … -0.14297305047512054 -0.060603756457567215; 0.41569626331329346 -0.5723713040351868 … 0.3854110538959503 -0.06979721784591675], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [-0.5814869403839111 -0.5133957862854004 … -0.5314137935638428 -0.18690480291843414], bias = [0.0;;])))</code></pre><p>Now we train the neural nets and resample data while training.</p><pre><code class="language-julia hljs">function train(pde_system, prob, sampler, strategy, resample_period = 500, n=10)
     bfgs = BFGS()
     res = Optimization.solve(prob, bfgs; maxiters=2000)

     for i in 1:n
         data = Sophon.sample(pde_system, sampler, strategy)
         prob = remake(prob; u0=res.u, p=data)
         res = Optimization.solve(prob, bfgs; maxiters=resample_period)
     end
     return res
end

res = train(pde_system, prob, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">u: ComponentVector{Float64}(u = (layer_1 = (weight = [-1.233293602000686 -0.7381522646299729; 0.31247530498838466 0.5283923283898748; … ; -0.7569599495341527 0.967609882420981; -0.5082681129463401 0.21923486694990907], bias = [0.49476788824647433; -0.3432466456274916; … ; 0.04542691923771714; -0.0025189776085570246;;]), layer_2 = (weight = [0.7993531723190335 -0.6160279600269064 … -0.20275144399381567 0.45186919903223705; -0.400817959038953 0.3455924337391833 … 0.10500557795105807 -0.1656904797441039; … ; -0.20750970027350993 0.4847914312432956 … 0.5030536252032729 -0.0794400227603384; 0.18931605171147045 -0.5625884776173145 … 0.03561987102295797 0.3844089481224741], bias = [0.15950837057330425; 0.04667458159955566; … ; -0.1911306626649277; 0.48562139580353114;;]), layer_3 = (weight = [0.1624439224642693 0.2639169462212841 … 0.41788396331120436 0.41207954408870934; 0.05622231979496527 0.5903048936755986 … -0.1437480864720081 0.3517972026479224; … ; -0.12611043884880502 0.4277276687830143 … 0.5504096636173273 -0.049110586436139914; -0.7218682347696416 -0.059975108448601724 … 0.5787686343716373 -0.09182240155234307], bias = [-0.4387538082034567; 0.36048863388868374; … ; -0.03300898469922635; 0.2112824218505473;;]), layer_4 = (weight = [-0.31659866862667113 -0.033147754639920445 … 0.31167192797944915 0.050257528197269814; -0.3306649471321677 -0.07911045269568104 … 0.21617240885695294 0.6545186993398922; … ; -0.17138033023830115 -0.44617143372006074 … 0.3776850449226009 0.007980762183041602; 0.3155588602775655 -0.22755863549683736 … -0.4313251449064492 0.6838116389353722], bias = [-0.04733582063810104; -0.18211158382522766; … ; -0.1440924106608571; 0.35859152072684003;;]), layer_5 = (weight = [0.3859464169061348 0.16936750055890956 … 0.3615725488264577 -0.37281671587714516], bias = [0.026608203599209006;;])), v = (layer_1 = (weight = [0.28760052003417574 0.8221527468393434; 0.7708535682928738 0.9919442529333226; … ; -1.1326522792663019 -0.503852817134603; 0.38149585805788655 -0.6380562405623792], bias = [-0.6153698667871205; -0.904285234872641; … ; 0.16860306462529256; 0.6081756961979794;;]), layer_2 = (weight = [-0.114005018404276 0.18026091783267773 … 0.34702353879722225 0.11757937341661276; -1.0694580081111609 -0.3840301454945791 … 0.27441267696501676 0.0008949773364494698; … ; 0.4388037989854545 -0.09059989727496764 … 0.15815901801263943 0.11635108747081778; -0.6954002072534673 -0.2034569915339792 … 0.42158860700625017 0.2650469770114682], bias = [-0.053137699280260714; -0.03939149634399873; … ; 0.17596248631507538; -0.13812211757360027;;]), layer_3 = (weight = [-0.23893306017027016 0.042878479147676854 … -0.08637114498196595 0.22579149694111136; 0.058311460041932696 0.4766215529935505 … 0.22125722087334146 -0.3798348239005269; … ; 0.354840128494369 -0.02135614742954777 … -0.27157778704015234 -0.0735979334100259; 0.22888974912600793 -0.2146628122911662 … -0.18666910874191323 -0.35064067233499735], bias = [0.30878906665441574; -0.043543640474284176; … ; 0.04412670363851768; 0.48838950641702306;;]), layer_4 = (weight = [-0.9491977817006326 -0.5577422867740637 … 0.2319682049727741 0.2721828958615326; 0.004988328188742442 0.12426783986771939 … -0.1749000744111249 0.278407240369831; … ; -0.37785820580483015 -0.3080279809805699 … 0.004798309460499087 -0.15764866418593146; 0.3398866033699194 -0.5605892982251381 … 0.5037472469052746 -0.08145387233544739], bias = [0.5314951068408844; 0.01777307210209193; … ; -0.05227111852218349; -0.14846987920652388;;]), layer_5 = (weight = [-0.5988353299053165 -0.6219241207168182 … -0.454220733893617 -0.40338507901255855], bias = [0.399444037278867;;])))</code></pre><pre><code class="language-julia hljs">phi = pinn.phi
ps = res.u

xs, ts= [infimum(d.domain):0.01:supremum(d.domain) for d in pde_system.domain]

u = [sum(phi.u(([x,t]), ps.u)) for x in xs, t in ts]
v = [sum(phi.v(([x,t]), ps.v)) for x in xs, t in ts]
ψ = @. sqrt(u^2+ v^2)

axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;u&quot;)
fig, ax1, hm1 = CairoMakie.heatmap(ts, xs, u&#39;, axis=axis)
ax2, hm2= CairoMakie.heatmap(fig[1, end+1], ts, xs, v&#39;, axis= merge(axis, (; title=&quot;v&quot;)))
display(fig)</code></pre><p><img src="../uv.png" alt/></p><pre><code class="language-julia hljs">axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;ψ&quot;)
fig, ax1, hm1 = CairoMakie.heatmap(ts, xs, ψ&#39;, axis=axis)
Colorbar(fig[:, end+1], hm1)
display(fig)</code></pre><p><img src="../phi.png" alt/></p><h2 id="Customize-Sampling"><a class="docs-heading-anchor" href="#Customize-Sampling">Customize Sampling</a><a id="Customize-Sampling-1"></a><a class="docs-heading-anchor-permalink" href="#Customize-Sampling" title="Permalink"></a></h2><p>Bascially any sampling method is supportted.</p><pre><code class="language-julia hljs">using StatsBase

data = vec([[x, t] for x in xs, t in ts])
wv = vec(ψ)
new_data = wsample(data, wv, 2000)
new_data = reduce(hcat, new_data)
fig, ax = scatter(new_data[2,:], new_data[1,:])</code></pre><p><img src="../data.png" alt/></p><pre><code class="language-julia hljs">prob.p[1] = new_data
prob.p[2] = new_data
prob = remake(prob; u0 = res.u)
# res = Optimization.solve(prob, bfgs; maxiters=1000)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [-1.233293602000686 -0.7381522646299729; 0.31247530498838466 0.5283923283898748; … ; -0.7569599495341527 0.967609882420981; -0.5082681129463401 0.21923486694990907], bias = [0.49476788824647433; -0.3432466456274916; … ; 0.04542691923771714; -0.0025189776085570246;;]), layer_2 = (weight = [0.7993531723190335 -0.6160279600269064 … -0.20275144399381567 0.45186919903223705; -0.400817959038953 0.3455924337391833 … 0.10500557795105807 -0.1656904797441039; … ; -0.20750970027350993 0.4847914312432956 … 0.5030536252032729 -0.0794400227603384; 0.18931605171147045 -0.5625884776173145 … 0.03561987102295797 0.3844089481224741], bias = [0.15950837057330425; 0.04667458159955566; … ; -0.1911306626649277; 0.48562139580353114;;]), layer_3 = (weight = [0.1624439224642693 0.2639169462212841 … 0.41788396331120436 0.41207954408870934; 0.05622231979496527 0.5903048936755986 … -0.1437480864720081 0.3517972026479224; … ; -0.12611043884880502 0.4277276687830143 … 0.5504096636173273 -0.049110586436139914; -0.7218682347696416 -0.059975108448601724 … 0.5787686343716373 -0.09182240155234307], bias = [-0.4387538082034567; 0.36048863388868374; … ; -0.03300898469922635; 0.2112824218505473;;]), layer_4 = (weight = [-0.31659866862667113 -0.033147754639920445 … 0.31167192797944915 0.050257528197269814; -0.3306649471321677 -0.07911045269568104 … 0.21617240885695294 0.6545186993398922; … ; -0.17138033023830115 -0.44617143372006074 … 0.3776850449226009 0.007980762183041602; 0.3155588602775655 -0.22755863549683736 … -0.4313251449064492 0.6838116389353722], bias = [-0.04733582063810104; -0.18211158382522766; … ; -0.1440924106608571; 0.35859152072684003;;]), layer_5 = (weight = [0.3859464169061348 0.16936750055890956 … 0.3615725488264577 -0.37281671587714516], bias = [0.026608203599209006;;])), v = (layer_1 = (weight = [0.28760052003417574 0.8221527468393434; 0.7708535682928738 0.9919442529333226; … ; -1.1326522792663019 -0.503852817134603; 0.38149585805788655 -0.6380562405623792], bias = [-0.6153698667871205; -0.904285234872641; … ; 0.16860306462529256; 0.6081756961979794;;]), layer_2 = (weight = [-0.114005018404276 0.18026091783267773 … 0.34702353879722225 0.11757937341661276; -1.0694580081111609 -0.3840301454945791 … 0.27441267696501676 0.0008949773364494698; … ; 0.4388037989854545 -0.09059989727496764 … 0.15815901801263943 0.11635108747081778; -0.6954002072534673 -0.2034569915339792 … 0.42158860700625017 0.2650469770114682], bias = [-0.053137699280260714; -0.03939149634399873; … ; 0.17596248631507538; -0.13812211757360027;;]), layer_3 = (weight = [-0.23893306017027016 0.042878479147676854 … -0.08637114498196595 0.22579149694111136; 0.058311460041932696 0.4766215529935505 … 0.22125722087334146 -0.3798348239005269; … ; 0.354840128494369 -0.02135614742954777 … -0.27157778704015234 -0.0735979334100259; 0.22888974912600793 -0.2146628122911662 … -0.18666910874191323 -0.35064067233499735], bias = [0.30878906665441574; -0.043543640474284176; … ; 0.04412670363851768; 0.48838950641702306;;]), layer_4 = (weight = [-0.9491977817006326 -0.5577422867740637 … 0.2319682049727741 0.2721828958615326; 0.004988328188742442 0.12426783986771939 … -0.1749000744111249 0.278407240369831; … ; -0.37785820580483015 -0.3080279809805699 … 0.004798309460499087 -0.15764866418593146; 0.3398866033699194 -0.5605892982251381 … 0.5037472469052746 -0.08145387233544739], bias = [0.5314951068408844; 0.01777307210209193; … ; -0.05227111852218349; -0.14846987920652388;;]), layer_5 = (weight = [-0.5988353299053165 -0.6219241207168182 … -0.454220733893617 -0.40338507901255855], bias = [0.399444037278867;;])))</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../allen_cahn/">« Allen-Cahn Equation with Sequential Training</a><a class="docs-footer-nextpage" href="../../references/">References »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Tuesday 4 October 2022 23:40">Tuesday 4 October 2022</span>. Using Julia version 1.8.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
