<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Schrödinger Equation: A PDE System with Resampling · Sophon.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://YichengDWu.github.io/Sophon.jl/tutorials/SchrödingerEquation/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/indigo.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Sophon.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../discontinuous/">Fitting a nonlinear discontinuous function</a></li><li><a class="tocitem" href="../poisson/">1D Multi-scale Poisson&#39;s Equation</a></li><li><a class="tocitem" href="../convection/">1D Convection Equation</a></li><li><a class="tocitem" href="../helmholtz/">2D Helmholtz Equation</a></li><li><a class="tocitem" href="../allen_cahn/">Allen-Cahn Equation with Sequential Training</a></li><li class="is-active"><a class="tocitem" href>Schrödinger Equation: A PDE System with Resampling</a><ul class="internal"><li><a class="tocitem" href="#Customize-Sampling"><span>Customize Sampling</span></a></li></ul></li><li><a class="tocitem" href="../L_shape/">Poisson equation over an L-shaped domain</a></li><li><a class="tocitem" href="../waveinverse2/">Inverse problem for the wave equation with unknown velocity field</a></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/YichengDWu/Sophon.jl/blob/main/docs/src/tutorials/SchrödingerEquation.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Schrödinger-equation"><a class="docs-heading-anchor" href="#Schrödinger-equation">Schrödinger equation</a><a id="Schrödinger-equation-1"></a><a class="docs-heading-anchor-permalink" href="#Schrödinger-equation" title="Permalink"></a></h1><p>The nonlinear Shrödinger equation is given by</p><p class="math-container">\[\mathrm{i} \partial_t \psi=-\frac{1}{2} \sigma \partial_{x x} \psi-\beta|\psi|^2 \psi\]</p><p>Let <span>$\sigma=\beta=1, \psi=u+v i$</span>, the equation can be transformed into a system of partial differential equations</p><pre><code class="language-julia hljs">using ModelingToolkit, IntervalSets, Sophon, CairoMakie
using Optimization, OptimizationOptimJL

@parameters x,t
@variables u(..), v(..)
Dₜ = Differential(t)
Dₓ² = Differential(x)^2

eqs=[Dₜ(u(x,t)) ~ -Dₓ²(v(x,t))/2 - (abs2(v(x,t)) + abs2(u(x,t))) * v(x,t),
     Dₜ(v(x,t)) ~  Dₓ²(u(x,t))/2 + (abs2(v(x,t)) + abs2(u(x,t))) * u(x,t)]

bcs = [u(x, 0.0) ~ 2sech(x),
       v(x, 0.0) ~ 0.0,
       u(-5.0, t) ~ u(5.0, t),
       v(-5.0, t) ~ v(5.0, t)]

domains = [x ∈ Interval(-5.0, 5.0),
           t ∈ Interval(0.0, π/2)]

@named pde_system = PDESystem(eqs, bcs, domains, [x,t], [u(x,t),v(x,t)])</code></pre><p class="math-container">\[ \begin{align}
\frac{\mathrm{d}}{\mathrm{d}t} u\left( x, t \right) =&amp;  - \frac{1}{2} \frac{\mathrm{d}^{2}}{\mathrm{d}x^{2}} v\left( x, t \right) - \left( \left|u\left( x, t \right)\right|^{2} + \left|v\left( x, t \right)\right|^{2} \right) v\left( x, t \right) \\
\frac{\mathrm{d}}{\mathrm{d}t} v\left( x, t \right) =&amp; \frac{1}{2} \frac{\mathrm{d}^{2}}{\mathrm{d}x^{2}} u\left( x, t \right) + \left( \left|u\left( x, t \right)\right|^{2} + \left|v\left( x, t \right)\right|^{2} \right) u\left( x, t \right)
\end{align}
 \]</p><pre><code class="language-julia hljs">pinn = PINN(u = Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0),
            v = Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0))

sampler = QuasiRandomSampler(500, (200,200,20,20))
strategy = NonAdaptiveTraining(1,(10,10,1,1))

prob = Sophon.discretize(pde_system, pinn, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [-0.01461029052734375 -0.01244419813156128; 0.2612857222557068 -0.489482581615448; … ; 0.4678800702095032 -0.32192617654800415; 0.07658571004867554 -0.17502480745315552], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [0.1832290142774582 0.5601006150245667 … 0.3299812972545624 0.39355236291885376; 0.41626280546188354 0.14211565256118774 … 0.31334835290908813 -0.3477731943130493; … ; -0.5195891261100769 -0.2268667221069336 … 0.021594563499093056 0.20219723880290985; 0.14447525143623352 -0.3435930907726288 … 0.294620156288147 0.382294237613678], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [-0.2039162516593933 -0.032861821353435516 … 0.10614079982042313 -0.0815790593624115; -0.42511850595474243 -0.5369994044303894 … -0.011837538331747055 -0.60978764295578; … ; 0.5119479894638062 -0.023728149011731148 … 0.07166770845651627 -0.4204559028148651; -0.16174715757369995 0.23117229342460632 … 0.5868380069732666 -0.2819861173629761], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [0.33216166496276855 0.012623096816241741 … -0.14344850182533264 0.0070296539925038815; -0.2266353815793991 -0.407682329416275 … 0.5594808459281921 0.5268903970718384; … ; -0.4522860050201416 -0.3271799087524414 … 0.285548597574234 -0.2125607430934906; -0.08097096532583237 -0.47391918301582336 … -0.30190137028694153 -0.5413323640823364], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [0.14558185636997223 0.5500543713569641 … 0.3842625617980957 0.16168569028377533], bias = [0.0;;])), v = (layer_1 = (weight = [-0.1539686918258667 -0.4226272702217102; 0.06655794382095337 -0.09955191612243652; … ; -0.08732867240905762 0.13300031423568726; 0.3073422312736511 0.27101659774780273], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [-0.04690704122185707 0.5145252346992493 … -0.5933866500854492 0.2671588957309723; 0.18155649304389954 0.3552320897579193 … 0.0579887330532074 0.07400138676166534; … ; -0.07717537879943848 -0.13498036563396454 … -0.3864358365535736 -0.1375582367181778; 0.38532477617263794 -0.3741627037525177 … -0.20997463166713715 0.5884568691253662], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [0.4435521364212036 0.09166684746742249 … 0.3346620202064514 0.03608734905719757; -0.4532139003276825 -0.5600623488426208 … 0.0899716317653656 0.11696640402078629; … ; -0.20650207996368408 -0.45929083228111267 … -0.19345951080322266 0.5046706795692444; 0.2958683967590332 -0.2626035213470459 … 0.5723817944526672 0.08073261380195618], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [0.5175315141677856 -0.5606153607368469 … 0.22545547783374786 0.4897264838218689; 0.02657976560294628 -0.19053810834884644 … 0.5292086005210876 0.25483131408691406; … ; 0.21329498291015625 -0.05537334457039833 … 0.3422217071056366 -0.4725649356842041; -0.08757910877466202 -0.3320082128047943 … -0.4446184039115906 -0.6078461408615112], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [0.13921286165714264 0.4673035144805908 … -0.526497483253479 0.22381865978240967], bias = [0.0;;])))</code></pre><p>Now we train the neural nets and resample data while training.</p><pre><code class="language-julia hljs">function train(pde_system, prob, sampler, strategy, resample_period = 500, n=10)
     bfgs = BFGS()
     res = Optimization.solve(prob, bfgs; maxiters=2000)

     for i in 1:n
         data = Sophon.sample(pde_system, sampler)
         prob = remake(prob; u0=res.u, p=data)
         res = Optimization.solve(prob, bfgs; maxiters=resample_period)
     end
     return res
end

res = train(pde_system, prob, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">u: ComponentVector{Float64}(u = (layer_1 = (weight = [0.20832068310551208 0.4084011388955837; 0.18499036375086403 -0.2038784142675596; … ; 1.196627851105344 -0.5818384594692606; -0.6003322952895811 -0.20997144492199168], bias = [-0.20114587230377032; -0.31381171028450133; … ; 0.26131346175068776; -0.3145900638365702;;]), layer_2 = (weight = [0.17647973530306824 0.40131594453859554 … -0.16539071268337052 0.6005748287701493; 0.4186307170354226 0.345050728827921 … 0.693676667966669 -0.5606550327542723; … ; -0.48317398412041274 -0.042116929882447376 … 0.18144936150785274 0.050742043686752336; 0.024931428831775168 -0.46775111586647716 … 0.2668382278052203 0.2525243677766588], bias = [0.26060237238458306; -0.27565684243240085; … ; -0.07631756833882439; -0.6037861016300924;;]), layer_3 = (weight = [-0.4992751570904659 0.0689665492911107 … -0.04455866166574168 0.015362561815004595; -0.11313879000677206 -0.49048915800403325 … 0.3977219305916919 -0.5281815029203625; … ; 0.800449943198105 0.04546923443836972 … 0.1908861729139943 -0.42766056205051256; -0.04573565534818073 -0.11413666903846718 … 0.753571675681566 -0.3440388816170933], bias = [-0.38558456966603166; -0.09938091814605979; … ; 0.06358101666706002; -0.08689937354767863;;]), layer_4 = (weight = [0.6767455270577739 0.07578400766614343 … -0.4639208465092932 0.4061940039408186; 0.054640772984281646 -0.29390589472452894 … 0.0777492631188192 1.284935769220664; … ; -0.3759500888391139 -0.36027237563972475 … 0.46307294932396076 -0.3194805530845767; -0.0680786655576011 -0.5431995014594851 … -0.35299114192471737 -0.49162018753661146], bias = [-0.6277653627406872; -0.782799111162752; … ; 0.010828258024623614; -0.134990330838224;;]), layer_5 = (weight = [1.570053490622228 0.3284453742387657 … 0.8266821083879121 -0.03766735955018353], bias = [0.0729473023884862;;])), v = (layer_1 = (weight = [-0.32245517778710386 -0.6137338231852837; -0.41063584852998636 -0.26135796881546236; … ; -0.06205113498636727 0.17538410028066986; 0.2755700444971295 0.2901909979184055], bias = [0.08567235404715683; -0.08037442930435096; … ; 0.02674857422205064; 0.10438470924609056;;]), layer_2 = (weight = [0.1901849439166189 0.5295852298954922 … -0.34084102116529935 0.2075236292568117; 0.5225485081766673 0.48222600983574115 … 0.10288120845435805 -0.22459794193322416; … ; -0.12159197122069453 -0.13592923557043518 … -0.2953788818251911 -0.14252057076269836; 0.32491543777517407 -0.23464763489207624 … -0.03059645863925049 0.5808178917337566], bias = [0.24501377930188173; 0.06878604519148206; … ; 0.28153974937078535; -0.025622122035669395;;]), layer_3 = (weight = [0.39465325930454437 -0.12366007623221265 … 0.7825743509810498 0.308675240828972; -0.5083027877085675 -0.21983767233979215 … 0.05913052383487444 0.056824533070850856; … ; -0.1710851671613303 -0.5501671386698295 … -0.1630297216682723 0.7318572207115712; 0.14430553086747497 -0.18996295776703487 … 0.5265198989206802 -0.010009761346211106], bias = [0.037649613677494115; 0.334636099644688; … ; 0.11802835039563137; 0.00044652741278332624;;]), layer_4 = (weight = [0.3874523253089414 -0.535739121242523 … 0.16622038046536342 0.47140362970221217; 0.05419368680188166 -0.4595634709459233 … 0.0829071194987611 0.21688575942731936; … ; 0.37256978022777293 0.35094471026745105 … 0.7093533588253128 0.00574574606812969; -0.029819469996465474 -0.16113853188598165 … -0.2767163857476622 -0.26345179533768665], bias = [-0.20640462854048588; -0.12141376879421245; … ; 0.28198755839543327; 0.08608078157918872;;]), layer_5 = (weight = [-0.46640629710548426 0.7467297659781043 … -0.8066746467046746 0.9812858040397514], bias = [0.12753108790449855;;])))</code></pre><pre><code class="language-julia hljs">phi = pinn.phi
ps = res.u

xs, ts= [infimum(d.domain):0.01:supremum(d.domain) for d in pde_system.domain]

u = [sum(phi.u(([x,t]), ps.u)) for x in xs, t in ts]
v = [sum(phi.v(([x,t]), ps.v)) for x in xs, t in ts]
ψ = @. sqrt(u^2+ v^2)

axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;u&quot;)
fig, ax1, hm1 = heatmap(ts, xs, u&#39;, axis=axis)
ax2, hm2= heatmap(fig[1, end+1], ts, xs, v&#39;, axis= merge(axis, (; title=&quot;v&quot;)))
display(fig)</code></pre><p><img src="../uv.png" alt/></p><pre><code class="language-julia hljs">axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;ψ&quot;)
fig, ax1, hm1 = heatmap(ts, xs, ψ&#39;, axis=axis, colormap=:jet)
Colorbar(fig[:, end+1], hm1)
display(fig)</code></pre><p><img src="../phi.png" alt/></p><h2 id="Customize-Sampling"><a class="docs-heading-anchor" href="#Customize-Sampling">Customize Sampling</a><a id="Customize-Sampling-1"></a><a class="docs-heading-anchor-permalink" href="#Customize-Sampling" title="Permalink"></a></h2><p>Bascially any sampling method is supportted. For example we can sample data according to the predicted solution.</p><pre><code class="language-julia hljs">using StatsBase

data = vec([[x, t] for x in xs, t in ts])
wv = vec(ψ)
new_data = wsample(data, wv, 500)
new_data = reduce(hcat, new_data)
fig, ax = scatter(new_data[2,:], new_data[1,:])</code></pre><p><img src="../data.png" alt/></p><pre><code class="language-julia hljs">prob.p[1] = new_data
prob.p[2] = new_data
prob = remake(prob; u0 = res.u)
# res = Optimization.solve(prob, bfgs; maxiters=1000)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [0.20832068310551208 0.4084011388955837; 0.18499036375086403 -0.2038784142675596; … ; 1.196627851105344 -0.5818384594692606; -0.6003322952895811 -0.20997144492199168], bias = [-0.20114587230377032; -0.31381171028450133; … ; 0.26131346175068776; -0.3145900638365702;;]), layer_2 = (weight = [0.17647973530306824 0.40131594453859554 … -0.16539071268337052 0.6005748287701493; 0.4186307170354226 0.345050728827921 … 0.693676667966669 -0.5606550327542723; … ; -0.48317398412041274 -0.042116929882447376 … 0.18144936150785274 0.050742043686752336; 0.024931428831775168 -0.46775111586647716 … 0.2668382278052203 0.2525243677766588], bias = [0.26060237238458306; -0.27565684243240085; … ; -0.07631756833882439; -0.6037861016300924;;]), layer_3 = (weight = [-0.4992751570904659 0.0689665492911107 … -0.04455866166574168 0.015362561815004595; -0.11313879000677206 -0.49048915800403325 … 0.3977219305916919 -0.5281815029203625; … ; 0.800449943198105 0.04546923443836972 … 0.1908861729139943 -0.42766056205051256; -0.04573565534818073 -0.11413666903846718 … 0.753571675681566 -0.3440388816170933], bias = [-0.38558456966603166; -0.09938091814605979; … ; 0.06358101666706002; -0.08689937354767863;;]), layer_4 = (weight = [0.6767455270577739 0.07578400766614343 … -0.4639208465092932 0.4061940039408186; 0.054640772984281646 -0.29390589472452894 … 0.0777492631188192 1.284935769220664; … ; -0.3759500888391139 -0.36027237563972475 … 0.46307294932396076 -0.3194805530845767; -0.0680786655576011 -0.5431995014594851 … -0.35299114192471737 -0.49162018753661146], bias = [-0.6277653627406872; -0.782799111162752; … ; 0.010828258024623614; -0.134990330838224;;]), layer_5 = (weight = [1.570053490622228 0.3284453742387657 … 0.8266821083879121 -0.03766735955018353], bias = [0.0729473023884862;;])), v = (layer_1 = (weight = [-0.32245517778710386 -0.6137338231852837; -0.41063584852998636 -0.26135796881546236; … ; -0.06205113498636727 0.17538410028066986; 0.2755700444971295 0.2901909979184055], bias = [0.08567235404715683; -0.08037442930435096; … ; 0.02674857422205064; 0.10438470924609056;;]), layer_2 = (weight = [0.1901849439166189 0.5295852298954922 … -0.34084102116529935 0.2075236292568117; 0.5225485081766673 0.48222600983574115 … 0.10288120845435805 -0.22459794193322416; … ; -0.12159197122069453 -0.13592923557043518 … -0.2953788818251911 -0.14252057076269836; 0.32491543777517407 -0.23464763489207624 … -0.03059645863925049 0.5808178917337566], bias = [0.24501377930188173; 0.06878604519148206; … ; 0.28153974937078535; -0.025622122035669395;;]), layer_3 = (weight = [0.39465325930454437 -0.12366007623221265 … 0.7825743509810498 0.308675240828972; -0.5083027877085675 -0.21983767233979215 … 0.05913052383487444 0.056824533070850856; … ; -0.1710851671613303 -0.5501671386698295 … -0.1630297216682723 0.7318572207115712; 0.14430553086747497 -0.18996295776703487 … 0.5265198989206802 -0.010009761346211106], bias = [0.037649613677494115; 0.334636099644688; … ; 0.11802835039563137; 0.00044652741278332624;;]), layer_4 = (weight = [0.3874523253089414 -0.535739121242523 … 0.16622038046536342 0.47140362970221217; 0.05419368680188166 -0.4595634709459233 … 0.0829071194987611 0.21688575942731936; … ; 0.37256978022777293 0.35094471026745105 … 0.7093533588253128 0.00574574606812969; -0.029819469996465474 -0.16113853188598165 … -0.2767163857476622 -0.26345179533768665], bias = [-0.20640462854048588; -0.12141376879421245; … ; 0.28198755839543327; 0.08608078157918872;;]), layer_5 = (weight = [-0.46640629710548426 0.7467297659781043 … -0.8066746467046746 0.9812858040397514], bias = [0.12753108790449855;;])))</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../allen_cahn/">« Allen-Cahn Equation with Sequential Training</a><a class="docs-footer-nextpage" href="../L_shape/">Poisson equation over an L-shaped domain »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Tuesday 6 December 2022 04:37">Tuesday 6 December 2022</span>. Using Julia version 1.8.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
