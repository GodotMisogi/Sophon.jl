<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Schrödinger Equation: A PDE System with Resampling · Sophon.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://YichengDWu.github.io/Sophon.jl/tutorials/SchrödingerEquation/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/indigo.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Sophon.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../discontinuous/">Fitting a nonlinear discontinuous function</a></li><li><a class="tocitem" href="../poisson/">1D Multi-scale Poisson&#39;s Equation</a></li><li><a class="tocitem" href="../convection/">1D Convection Equation</a></li><li><a class="tocitem" href="../helmholtz/">2D Helmholtz Equation</a></li><li><a class="tocitem" href="../allen_cahn/">Allen-Cahn Equation with Sequential Training</a></li><li class="is-active"><a class="tocitem" href>Schrödinger Equation: A PDE System with Resampling</a><ul class="internal"><li><a class="tocitem" href="#Customize-Sampling"><span>Customize Sampling</span></a></li></ul></li><li><a class="tocitem" href="../L_shape/">Poisson equation over an L-shaped domain</a></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/YichengDWu/Sophon.jl/blob/main/docs/src/tutorials/SchrödingerEquation.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Schrödinger-equation"><a class="docs-heading-anchor" href="#Schrödinger-equation">Schrödinger equation</a><a id="Schrödinger-equation-1"></a><a class="docs-heading-anchor-permalink" href="#Schrödinger-equation" title="Permalink"></a></h1><p>The nonlinear Shrödinger equation is given by</p><p class="math-container">\[\mathrm{i} \partial_t \psi=-\frac{1}{2} \sigma \partial_{x x} \psi-\beta|\psi|^2 \psi\]</p><p>Let <span>$\sigma=\beta=1, \psi=u+v i$</span>, the equation can be transformed into a system of partial differential equations</p><pre><code class="language-julia hljs">using ModelingToolkit, IntervalSets, Sophon, CairoMakie
using Optimization, OptimizationOptimJL

@parameters x,t
@variables u(..), v(..)
Dₜ = Differential(t)
Dₓ² = Differential(x)^2

eqs=[Dₜ(u(x,t)) ~ -Dₓ²(v(x,t))/2 - (abs2(v(x,t)) + abs2(u(x,t))) * v(x,t),
     Dₜ(v(x,t)) ~  Dₓ²(u(x,t))/2 + (abs2(v(x,t)) + abs2(u(x,t))) * u(x,t)]

bcs = [u(x, 0.0) ~ 2sech(x),
       v(x, 0.0) ~ 0.0,
       u(-5.0, t) ~ u(5.0, t),
       v(-5.0, t) ~ v(5.0, t)]

domains = [x ∈ Interval(-5.0, 5.0),
           t ∈ Interval(0.0, π/2)]

@named pde_system = PDESystem(eqs, bcs, domains, [x,t], [u(x,t),v(x,t)])</code></pre><p class="math-container">\[ \begin{align}
\frac{\mathrm{d}}{\mathrm{d}t} u\left( x, t \right) =&amp;  - \frac{1}{2} \frac{\mathrm{d}^{2}}{\mathrm{d}x^{2}} v\left( x, t \right) - \left( \left|u\left( x, t \right)\right|^{2} + \left|v\left( x, t \right)\right|^{2} \right) v\left( x, t \right) \\
\frac{\mathrm{d}}{\mathrm{d}t} v\left( x, t \right) =&amp; \frac{1}{2} \frac{\mathrm{d}^{2}}{\mathrm{d}x^{2}} u\left( x, t \right) + \left( \left|u\left( x, t \right)\right|^{2} + \left|v\left( x, t \right)\right|^{2} \right) u\left( x, t \right)
\end{align}
 \]</p><pre><code class="language-julia hljs">pinn = PINN(u = Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0),
            v = Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0))

sampler = QuasiRandomSampler(500, (500,500,20,20))
strategy = NonAdaptiveTraining(1,(10,10,1,1))

prob = Sophon.discretize(pde_system, pinn, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [0.48324960470199585 0.3293730616569519; 0.09800362586975098 0.47342777252197266; … ; -0.11370205879211426 -0.23467493057250977; 0.0793951153755188 -0.22241359949111938], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [0.4367525279521942 0.0848071351647377 … -0.15172192454338074 -0.608517587184906; 0.11721591651439667 -0.10332998633384705 … -0.23130427300930023 0.07420352846384048; … ; -0.3121308386325836 0.48024994134902954 … -0.013952143490314484 -0.2969069480895996; -0.5701347589492798 0.506868839263916 … -0.02286236360669136 -0.5490886569023132], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [-0.03474355489015579 -0.0283760167658329 … -0.37979987263679504 0.08976299315690994; 0.17760542035102844 0.22135797142982483 … 0.14334148168563843 0.38462668657302856; … ; 0.3834020793437958 0.17531108856201172 … 0.5794045925140381 0.20678532123565674; 0.5965591669082642 0.1869945228099823 … 0.42460793256759644 -0.18822771310806274], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [-0.32592320442199707 -0.20135167241096497 … -0.13939572870731354 -0.061524804681539536; -0.48975640535354614 0.5407611727714539 … -0.0826011374592781 0.06694217026233673; … ; 0.1594148725271225 0.4089827835559845 … 0.43525317311286926 0.35268107056617737; 0.1875007003545761 -0.19726824760437012 … 0.3003292381763458 -0.23740968108177185], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [0.4582909345626831 0.4898620545864105 … -0.22095003724098206 -0.26291364431381226], bias = [0.0;;])), v = (layer_1 = (weight = [-0.31841039657592773 0.33503156900405884; -0.39103585481643677 0.03430980443954468; … ; -0.14442962408065796 0.19042354822158813; -0.07030594348907471 0.07696843147277832], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [-0.6086573600769043 0.48265770077705383 … 0.10122428834438324 0.32768476009368896; 0.1212686151266098 -0.4091876149177551 … 0.3546588122844696 -0.21800702810287476; … ; -0.003975167870521545 -0.5784777402877808 … -0.4943252205848694 0.5725789666175842; 0.1872233748435974 0.03979438543319702 … -0.3093705475330353 -0.2637730538845062], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [0.5672779083251953 -0.5814886093139648 … -0.5692711472511292 -0.1319037675857544; 0.057114988565444946 0.2222590148448944 … -0.07716318219900131 0.3987407386302948; … ; -0.25950685143470764 0.190582275390625 … 0.03377009555697441 0.5018557906150818; 0.13263508677482605 0.507950484752655 … -0.30575382709503174 0.5453324913978577], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [-0.5829080939292908 -0.30776336789131165 … 0.028757954016327858 0.11842575669288635; -0.1284157931804657 -0.021824149414896965 … -0.006781744305044413 0.06534141302108765; … ; -0.4513445794582367 0.04099370911717415 … -0.12721435725688934 -0.2072942703962326; 0.19122956693172455 0.5316192507743835 … 0.11087524145841599 -0.21926555037498474], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [0.4815531373023987 0.17742539942264557 … -0.4742662310600281 -0.17184531688690186], bias = [0.0;;])))</code></pre><p>Now we train the neural nets and resample data while training.</p><pre><code class="language-julia hljs">function train(pde_system, prob, sampler, strategy, resample_period = 500, n=10)
     bfgs = BFGS()
     res = Optimization.solve(prob, bfgs; maxiters=2000)

     for i in 1:n
         data = Sophon.sample(pde_system, sampler, strategy)
         prob = remake(prob; u0=res.u, p=data)
         res = Optimization.solve(prob, bfgs; maxiters=resample_period)
     end
     return res
end

res = train(pde_system, prob, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">u: ComponentVector{Float64}(u = (layer_1 = (weight = [1.4696471652539045 0.43831807254793964; 0.3686592112655711 0.14296427417025903; … ; -0.26768218493383356 -0.6202650911409623; 0.030867385459408044 -0.43181301257009586], bias = [-0.38047684379109303; 0.021772018435134197; … ; 0.09590324365737438; 0.35957091753064085;;]), layer_2 = (weight = [0.023433482161733847 -0.014115408088360802 … -0.1672416529560236 -0.8624836996825848; 0.47778878202869324 0.12097722081368048 … -0.2813470120815658 -0.09528061017081271; … ; 0.03837628499110997 0.49146032242341015 … 0.01269307339945468 -0.2571808997919437; -0.5731219749900707 0.17536537493055576 … 0.29027091132632915 -0.27452379343627786], bias = [-0.051231541496298605; -0.0016700523101037268; … ; -0.0037469133596476478; -0.1668808978373038;;]), layer_3 = (weight = [-0.18598768971697446 0.09585590639740715 … -0.506796288908079 0.23641530884519674; 0.6866782060541414 0.024970752153693914 … 0.0487397347468128 0.2045940712633239; … ; 0.023389077259595166 0.16818399045386156 … 0.47698058636091356 0.600747767881339; 0.4433078703042346 0.3976290853854423 … 0.4062224320798539 -0.07835283761783625], bias = [0.24715671407865486; -0.375982222860042; … ; 0.12028126873167043; 0.2033355067399047;;]), layer_4 = (weight = [-0.5108955635771764 0.1581830833979707 … 0.08192385051221489 -0.41172666937199165; -0.4148202770555739 0.2987768417211253 … -0.09442900023983089 0.08884102716182793; … ; -0.07051801787168846 0.09288004862602786 … -0.0013488441022377598 0.31326541389291024; 0.1898820153044248 0.05057690494210554 … 0.08433607343840104 0.09916232701196678], bias = [0.2868680621392326; -0.21937305960670733; … ; 0.2604687946835039; -0.05199928484438047;;]), layer_5 = (weight = [0.8817515531693536 -0.16149119104998422 … -1.3964924369335652 -0.574465988966055], bias = [0.1331359372208158;;])), v = (layer_1 = (weight = [-0.580469455304877 0.9839553880116451; -0.19897628312647742 -0.4286260523688201; … ; -0.3888566545656668 -0.010732488781931964; 0.08475318740155904 -0.3204517622330011], bias = [-0.3170428974491289; 0.2763534673728129; … ; -0.11652759525174862; -0.2743834909772749;;]), layer_2 = (weight = [-0.33259529041310715 0.4814613017278044 … 0.19499826301948137 0.3887679699990691; 0.26657691137169326 -0.5834299965016341 … 0.34900319410541036 -0.3221973426203627; … ; 0.1598488764835417 -0.6459321683281046 … -0.5774832804525297 0.6777366968400342; 0.017237374340160573 -0.10002691142143774 … -0.19851344697049264 -0.3562179873175164], bias = [-0.33319690775665; 0.5266916134094295; … ; 0.09765765914402727; 0.13978550562272105;;]), layer_3 = (weight = [0.5036221330073349 -0.9227885585400235 … -0.44244145073440366 -0.3239972303987777; -0.0810122128256444 0.23731758475040832 … -0.13796409175083255 0.4400889870137828; … ; -0.4473076751532011 0.12570915474470673 … -0.0013676613798242164 0.29266990342847093; -0.147911062088495 0.5139957244278899 … -0.28873520280140647 0.03920424626809963], bias = [-0.572900809992199; 0.23497267927606463; … ; 0.32448099316510237; -0.18033100239619262;;]), layer_4 = (weight = [-0.5700208182550628 0.098906843112439 … 0.13814882357263064 0.06884876483243173; 0.06496887728810866 -0.06299934578641284 … -0.10073795198735823 0.11137328461670089; … ; -0.8065544219120381 0.005792188035595539 … 0.12763822602518748 -0.10178230726673038; 0.1771291674070624 0.5431610541647937 … -0.001971717035577695 -0.3209402610313731], bias = [0.5196545055704679; -0.23335629068574665; … ; 0.1433646134934391; 0.3882624677986138;;]), layer_5 = (weight = [0.6962095732514184 -0.2572220864374269 … -0.3597521424124983 0.5217600719171627], bias = [0.07436600188791134;;])))</code></pre><pre><code class="language-julia hljs">phi = pinn.phi
ps = res.u

xs, ts= [infimum(d.domain):0.01:supremum(d.domain) for d in pde_system.domain]

u = [sum(phi.u(([x,t]), ps.u)) for x in xs, t in ts]
v = [sum(phi.v(([x,t]), ps.v)) for x in xs, t in ts]
ψ = @. sqrt(u^2+ v^2)

axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;u&quot;)
fig, ax1, hm1 = CairoMakie.heatmap(ts, xs, u&#39;, axis=axis)
ax2, hm2= CairoMakie.heatmap(fig[1, end+1], ts, xs, v&#39;, axis= merge(axis, (; title=&quot;v&quot;)))
display(fig)</code></pre><p><img src="../uv.png" alt/></p><pre><code class="language-julia hljs">axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;ψ&quot;)
fig, ax1, hm1 = CairoMakie.heatmap(ts, xs, ψ&#39;, axis=axis, colormap=:jet)
Colorbar(fig[:, end+1], hm1)
display(fig)</code></pre><p><img src="../phi.png" alt/></p><h2 id="Customize-Sampling"><a class="docs-heading-anchor" href="#Customize-Sampling">Customize Sampling</a><a id="Customize-Sampling-1"></a><a class="docs-heading-anchor-permalink" href="#Customize-Sampling" title="Permalink"></a></h2><p>Bascially any sampling method is supportted.</p><pre><code class="language-julia hljs">using StatsBase

data = vec([[x, t] for x in xs, t in ts])
wv = vec(ψ)
new_data = wsample(data, wv, 500)
new_data = reduce(hcat, new_data)
fig, ax = scatter(new_data[2,:], new_data[1,:])</code></pre><p><img src="../data.png" alt/></p><pre><code class="language-julia hljs">prob.p[1] = new_data
prob.p[2] = new_data
prob = remake(prob; u0 = res.u)
# res = Optimization.solve(prob, bfgs; maxiters=1000)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [1.4696471652539045 0.43831807254793964; 0.3686592112655711 0.14296427417025903; … ; -0.26768218493383356 -0.6202650911409623; 0.030867385459408044 -0.43181301257009586], bias = [-0.38047684379109303; 0.021772018435134197; … ; 0.09590324365737438; 0.35957091753064085;;]), layer_2 = (weight = [0.023433482161733847 -0.014115408088360802 … -0.1672416529560236 -0.8624836996825848; 0.47778878202869324 0.12097722081368048 … -0.2813470120815658 -0.09528061017081271; … ; 0.03837628499110997 0.49146032242341015 … 0.01269307339945468 -0.2571808997919437; -0.5731219749900707 0.17536537493055576 … 0.29027091132632915 -0.27452379343627786], bias = [-0.051231541496298605; -0.0016700523101037268; … ; -0.0037469133596476478; -0.1668808978373038;;]), layer_3 = (weight = [-0.18598768971697446 0.09585590639740715 … -0.506796288908079 0.23641530884519674; 0.6866782060541414 0.024970752153693914 … 0.0487397347468128 0.2045940712633239; … ; 0.023389077259595166 0.16818399045386156 … 0.47698058636091356 0.600747767881339; 0.4433078703042346 0.3976290853854423 … 0.4062224320798539 -0.07835283761783625], bias = [0.24715671407865486; -0.375982222860042; … ; 0.12028126873167043; 0.2033355067399047;;]), layer_4 = (weight = [-0.5108955635771764 0.1581830833979707 … 0.08192385051221489 -0.41172666937199165; -0.4148202770555739 0.2987768417211253 … -0.09442900023983089 0.08884102716182793; … ; -0.07051801787168846 0.09288004862602786 … -0.0013488441022377598 0.31326541389291024; 0.1898820153044248 0.05057690494210554 … 0.08433607343840104 0.09916232701196678], bias = [0.2868680621392326; -0.21937305960670733; … ; 0.2604687946835039; -0.05199928484438047;;]), layer_5 = (weight = [0.8817515531693536 -0.16149119104998422 … -1.3964924369335652 -0.574465988966055], bias = [0.1331359372208158;;])), v = (layer_1 = (weight = [-0.580469455304877 0.9839553880116451; -0.19897628312647742 -0.4286260523688201; … ; -0.3888566545656668 -0.010732488781931964; 0.08475318740155904 -0.3204517622330011], bias = [-0.3170428974491289; 0.2763534673728129; … ; -0.11652759525174862; -0.2743834909772749;;]), layer_2 = (weight = [-0.33259529041310715 0.4814613017278044 … 0.19499826301948137 0.3887679699990691; 0.26657691137169326 -0.5834299965016341 … 0.34900319410541036 -0.3221973426203627; … ; 0.1598488764835417 -0.6459321683281046 … -0.5774832804525297 0.6777366968400342; 0.017237374340160573 -0.10002691142143774 … -0.19851344697049264 -0.3562179873175164], bias = [-0.33319690775665; 0.5266916134094295; … ; 0.09765765914402727; 0.13978550562272105;;]), layer_3 = (weight = [0.5036221330073349 -0.9227885585400235 … -0.44244145073440366 -0.3239972303987777; -0.0810122128256444 0.23731758475040832 … -0.13796409175083255 0.4400889870137828; … ; -0.4473076751532011 0.12570915474470673 … -0.0013676613798242164 0.29266990342847093; -0.147911062088495 0.5139957244278899 … -0.28873520280140647 0.03920424626809963], bias = [-0.572900809992199; 0.23497267927606463; … ; 0.32448099316510237; -0.18033100239619262;;]), layer_4 = (weight = [-0.5700208182550628 0.098906843112439 … 0.13814882357263064 0.06884876483243173; 0.06496887728810866 -0.06299934578641284 … -0.10073795198735823 0.11137328461670089; … ; -0.8065544219120381 0.005792188035595539 … 0.12763822602518748 -0.10178230726673038; 0.1771291674070624 0.5431610541647937 … -0.001971717035577695 -0.3209402610313731], bias = [0.5196545055704679; -0.23335629068574665; … ; 0.1433646134934391; 0.3882624677986138;;]), layer_5 = (weight = [0.6962095732514184 -0.2572220864374269 … -0.3597521424124983 0.5217600719171627], bias = [0.07436600188791134;;])))</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../allen_cahn/">« Allen-Cahn Equation with Sequential Training</a><a class="docs-footer-nextpage" href="../L_shape/">Poisson equation over an L-shaped domain »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Saturday 15 October 2022 02:03">Saturday 15 October 2022</span>. Using Julia version 1.8.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
