<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Schrödinger Equation: A PDE System with Resampling · Sophon.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://YichengDWu.github.io/Sophon.jl/tutorials/SchrödingerEquation/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/indigo.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Sophon.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../discontinuous/">Fitting a nonlinear discontinuous function</a></li><li><a class="tocitem" href="../poisson/">1D Multi-scale Poisson&#39;s Equation</a></li><li><a class="tocitem" href="../convection/">1D Convection Equation</a></li><li><a class="tocitem" href="../helmholtz/">2D Helmholtz Equation</a></li><li><a class="tocitem" href="../allen_cahn/">Allen-Cahn Equation with Sequential Training</a></li><li class="is-active"><a class="tocitem" href>Schrödinger Equation: A PDE System with Resampling</a><ul class="internal"><li><a class="tocitem" href="#Customize-Sampling"><span>Customize Sampling</span></a></li></ul></li><li><a class="tocitem" href="../L_shape/">Poisson equation over an L-shaped domain</a></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/YichengDWu/Sophon.jl/blob/main/docs/src/tutorials/SchrödingerEquation.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Schrödinger-equation"><a class="docs-heading-anchor" href="#Schrödinger-equation">Schrödinger equation</a><a id="Schrödinger-equation-1"></a><a class="docs-heading-anchor-permalink" href="#Schrödinger-equation" title="Permalink"></a></h1><p>The nonlinear Shrödinger equation is given by</p><p class="math-container">\[\mathrm{i} \partial_t \psi=-\frac{1}{2} \sigma \partial_{x x} \psi-\beta|\psi|^2 \psi\]</p><p>Let <span>$\sigma=\beta=1, \psi=u+v i$</span>, the equation can be transformed into a system of partial differential equations</p><pre><code class="language-julia hljs">using ModelingToolkit, IntervalSets, Sophon, CairoMakie
using Optimization, OptimizationOptimJL

@parameters x,t
@variables u(..), v(..)
Dₜ = Differential(t)
Dₓ² = Differential(x)^2

eqs=[Dₜ(u(x,t)) ~ -Dₓ²(v(x,t))/2 - (abs2(v(x,t)) + abs2(u(x,t))) * v(x,t),
     Dₜ(v(x,t)) ~  Dₓ²(u(x,t))/2 + (abs2(v(x,t)) + abs2(u(x,t))) * u(x,t)]

bcs = [u(x, 0.0) ~ 2sech(x),
       v(x, 0.0) ~ 0.0,
       u(-5.0, t) ~ u(5.0, t),
       v(-5.0, t) ~ v(5.0, t)]

domains = [x ∈ Interval(-5.0, 5.0),
           t ∈ Interval(0.0, π/2)]

@named pde_system = PDESystem(eqs, bcs, domains, [x,t], [u(x,t),v(x,t)])</code></pre><p class="math-container">\[ \begin{align}
\frac{\mathrm{d}}{\mathrm{d}t} u\left( x, t \right) =&amp;  - \frac{1}{2} \frac{\mathrm{d}^{2}}{\mathrm{d}x^{2}} v\left( x, t \right) - \left( \left|u\left( x, t \right)\right|^{2} + \left|v\left( x, t \right)\right|^{2} \right) v\left( x, t \right) \\
\frac{\mathrm{d}}{\mathrm{d}t} v\left( x, t \right) =&amp; \frac{1}{2} \frac{\mathrm{d}^{2}}{\mathrm{d}x^{2}} u\left( x, t \right) + \left( \left|u\left( x, t \right)\right|^{2} + \left|v\left( x, t \right)\right|^{2} \right) u\left( x, t \right)
\end{align}
 \]</p><pre><code class="language-julia hljs">pinn = PINN(u = Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0),
            v = Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0))

sampler = QuasiRandomSampler(500, (200,200,20,20))
strategy = NonAdaptiveTraining(1,(10,10,1,1))

prob = Sophon.discretize(pde_system, pinn, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [0.20814985036849976 -0.3636099696159363; 0.4383719563484192 0.3537118434906006; … ; -0.33529722690582275 0.3682060241699219; 0.08656954765319824 0.00832974910736084], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [-0.21155261993408203 -0.21093925833702087 … -0.0021994314156472683 -0.5523838996887207; 0.505876898765564 -0.4881899058818817 … -0.39004623889923096 0.21157604455947876; … ; -0.2785719335079193 0.13900378346443176 … -0.281394362449646 -0.09430442750453949; -0.09903653711080551 0.09209046512842178 … 0.3029174506664276 0.16539637744426727], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [-0.3690018057823181 0.042344365268945694 … -0.6038793325424194 -0.05295710265636444; 0.3370477259159088 0.16879038512706757 … -0.174324631690979 0.4242602288722992; … ; 0.38445496559143066 -0.5223479270935059 … -0.4608589708805084 0.2481130063533783; -0.27374324202537537 0.5733588337898254 … 0.42906060814857483 0.4517916440963745], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [0.5388661623001099 0.1906995177268982 … 0.5006354451179504 -0.2868518829345703; -0.3839828073978424 -0.17470504343509674 … 0.5751430988311768 0.32881876826286316; … ; -0.3009118437767029 -0.044800613075494766 … 0.037481073290109634 -0.2552371919155121; -0.13604508340358734 -0.3825513422489166 … -0.03174871206283569 -0.1320042759180069], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [-0.20173682272434235 0.18337640166282654 … -0.33969730138778687 -0.4015069305896759], bias = [0.0;;])), v = (layer_1 = (weight = [-0.43968862295150757 0.06302618980407715; 0.29004085063934326 -0.03902214765548706; … ; -0.03926682472229004 -0.0898054838180542; 0.1104438304901123 -0.13836848735809326], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [-0.044863175600767136 0.2852460741996765 … 0.01333455927670002 -0.147721067070961; 0.41089677810668945 -0.524415135383606 … -0.09293647110462189 0.08317207545042038; … ; 0.28238409757614136 -0.15763956308364868 … 0.31539368629455566 0.414013534784317; 0.6098290085792542 -0.6031991839408875 … -0.15580317378044128 0.5346533060073853], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [0.019101889804005623 0.5660108923912048 … 0.3409178555011749 0.5083166360855103; -0.5617958903312683 -0.44783151149749756 … 0.13753509521484375 0.15797638893127441; … ; -0.13761532306671143 0.29711881279945374 … -0.14260417222976685 0.45646360516548157; 0.5263805389404297 -0.4382580816745758 … 0.38327646255493164 0.13207946717739105], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [0.1292838454246521 0.113775335252285 … -0.12605920433998108 0.057734835892915726; -0.13389615714550018 0.4616556763648987 … 0.18796353042125702 -0.1772727519273758; … ; 0.43744587898254395 0.32673341035842896 … 0.41566210985183716 -0.30669572949409485; 0.3900235891342163 -0.3299494683742523 … -0.4836650490760803 0.34428542852401733], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [0.035428956151008606 -0.21601265668869019 … -0.21272149682044983 -0.13091519474983215], bias = [0.0;;])))</code></pre><p>Now we train the neural nets and resample data while training.</p><pre><code class="language-julia hljs">function train(pde_system, prob, sampler, strategy, resample_period = 500, n=10)
     bfgs = BFGS()
     res = Optimization.solve(prob, bfgs; maxiters=2000)

     for i in 1:n
         data = Sophon.sample(pde_system, sampler, strategy)
         prob = remake(prob; u0=res.u, p=data)
         res = Optimization.solve(prob, bfgs; maxiters=resample_period)
     end
     return res
end

res = train(pde_system, prob, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">u: ComponentVector{Float64}(u = (layer_1 = (weight = [0.04319895178597413 -0.2722778538214218; 1.2665306925564632 0.15623651134160527; … ; -1.1861406358734858 0.722642910851043; 0.4764507981166367 0.4137258519219419], bias = [-0.4429992555828312; 0.032872344750400906; … ; -0.5349470583223047; -0.35629078224122085;;]), layer_2 = (weight = [-0.05646449741254322 -0.2448091711799576 … -0.06621231448293653 -0.7690350083280186; 0.4518805206130895 -0.20496146262610884 … -0.02121444596021329 0.13863335561457155; … ; -0.42796953687992584 0.1340620875611399 … 0.048653466133864856 -0.11158656176626763; 0.1685126660589631 -0.02710542507769064 … 0.019893152356061417 0.24166074436874257], bias = [0.05282823882535381; -0.18953010632820175; … ; 0.19815568543165568; -0.11241684187118435;;]), layer_3 = (weight = [-0.45851428506641584 0.11307493910554144 … -0.3359460242669215 0.26655485273957724; 0.248109132218832 0.360816163980521 … -0.13154365092645237 0.36503033455950673; … ; 0.4263545041006734 -0.5315982386942673 … -0.2540309676211236 0.15368331271210753; -0.44849367886257924 0.5613330850890752 … 0.4053508798863282 0.502077218707379], bias = [-0.5384220806179819; -0.19958365459908503; … ; -0.03553346807094657; 0.06414509295085823;;]), layer_4 = (weight = [0.690528405522928 -0.02405022442834273 … 0.475041422390902 -0.18335037298003892; -0.2740896328027027 -0.5459438311720238 … 0.8537003452949838 0.5595088195893292; … ; 0.019812166773349755 -0.4358086031914592 … 0.1332141620890712 -0.10000867458441852; -0.26815819598990726 0.026576532340555216 … -0.7982027708322464 -0.433884187365003], bias = [0.18891524262799614; -0.3818213538393306; … ; 0.1520765530668106; 0.28864266150502105;;]), layer_5 = (weight = [-0.3423112672944701 0.31975984024821724 … -0.9557626352992367 -0.3071705242487095], bias = [0.4310991505982176;;])), v = (layer_1 = (weight = [-0.4643795015901102 0.06266804744881423; 0.5329072823500185 0.42699939115675406; … ; -0.3305282408393707 -0.16200030627884474; -0.1543020048659747 -0.36296363912084284], bias = [0.10152852016349483; -0.25663632352271193; … ; 0.0720594563615432; 0.08082164154610305;;]), layer_2 = (weight = [0.011355845613261799 0.35054731328978467 … -0.10216680951616594 -0.27255839765917517; 0.4794944516270806 -0.5238946478027122 … -0.0583500763793729 0.20650835241325957; … ; 0.3126627905872844 -0.11982414648405333 … 0.34213162021441085 0.3997810609452727; 0.6075278079786129 -0.7353490675392563 … -0.03550486741272148 0.7408285744691443], bias = [0.0025757562306438346; -0.17001352390564164; … ; -0.15073408296918836; 0.10286289528228922;;]), layer_3 = (weight = [0.02965797371464256 0.43584171601240973 … 0.2599847686336007 0.2402906762155112; -0.5156734198500165 -0.15222698965221604 … 0.12119239956215812 0.3077169276813054; … ; -0.0937621834638075 0.259889482175264 … -0.32436419191659577 0.4960848258495951; 0.3149629832584542 -0.48516252654568975 … 0.3390420744744312 0.2607246153509916], bias = [-0.21945512323149624; -0.007412394214723184; … ; -0.3356169958746839; -0.008444139029574456;;]), layer_4 = (weight = [0.2428165132922405 -0.0427523191443664 … 0.05166312082751311 0.08981683315441959; -0.15445947440336422 0.08971936398606596 … 0.08328755454254287 -0.22994777578879072; … ; 0.47962125150369317 0.31603215905047355 … 0.35848065711744076 -0.29108754842540996; 0.6015776433258384 -0.07116361391378155 … -0.3141321481457265 0.2516320716479766], bias = [-0.19566910483662092; -0.06908375390897292; … ; 0.059151818620961374; 0.013482278213789337;;]), layer_5 = (weight = [0.23451565202604846 -0.38917899635412234 … 0.03999241905319297 -0.8705888686473653], bias = [-0.4006478332831508;;])))</code></pre><pre><code class="language-julia hljs">phi = pinn.phi
ps = res.u

xs, ts= [infimum(d.domain):0.01:supremum(d.domain) for d in pde_system.domain]

u = [sum(phi.u(([x,t]), ps.u)) for x in xs, t in ts]
v = [sum(phi.v(([x,t]), ps.v)) for x in xs, t in ts]
ψ = @. sqrt(u^2+ v^2)

axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;u&quot;)
fig, ax1, hm1 = heatmap(ts, xs, u&#39;, axis=axis)
ax2, hm2= heatmap(fig[1, end+1], ts, xs, v&#39;, axis= merge(axis, (; title=&quot;v&quot;)))
display(fig)</code></pre><p><img src="../uv.png" alt/></p><pre><code class="language-julia hljs">axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;ψ&quot;)
fig, ax1, hm1 = heatmap(ts, xs, ψ&#39;, axis=axis, colormap=:jet)
Colorbar(fig[:, end+1], hm1)
display(fig)</code></pre><p><img src="../phi.png" alt/></p><h2 id="Customize-Sampling"><a class="docs-heading-anchor" href="#Customize-Sampling">Customize Sampling</a><a id="Customize-Sampling-1"></a><a class="docs-heading-anchor-permalink" href="#Customize-Sampling" title="Permalink"></a></h2><p>Bascially any sampling method is supportted.</p><pre><code class="language-julia hljs">using StatsBase

data = vec([[x, t] for x in xs, t in ts])
wv = vec(ψ)
new_data = wsample(data, wv, 500)
new_data = reduce(hcat, new_data)
fig, ax = scatter(new_data[2,:], new_data[1,:])</code></pre><p><img src="../data.png" alt/></p><pre><code class="language-julia hljs">prob.p[1] = new_data
prob.p[2] = new_data
prob = remake(prob; u0 = res.u)
# res = Optimization.solve(prob, bfgs; maxiters=1000)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [0.04319895178597413 -0.2722778538214218; 1.2665306925564632 0.15623651134160527; … ; -1.1861406358734858 0.722642910851043; 0.4764507981166367 0.4137258519219419], bias = [-0.4429992555828312; 0.032872344750400906; … ; -0.5349470583223047; -0.35629078224122085;;]), layer_2 = (weight = [-0.05646449741254322 -0.2448091711799576 … -0.06621231448293653 -0.7690350083280186; 0.4518805206130895 -0.20496146262610884 … -0.02121444596021329 0.13863335561457155; … ; -0.42796953687992584 0.1340620875611399 … 0.048653466133864856 -0.11158656176626763; 0.1685126660589631 -0.02710542507769064 … 0.019893152356061417 0.24166074436874257], bias = [0.05282823882535381; -0.18953010632820175; … ; 0.19815568543165568; -0.11241684187118435;;]), layer_3 = (weight = [-0.45851428506641584 0.11307493910554144 … -0.3359460242669215 0.26655485273957724; 0.248109132218832 0.360816163980521 … -0.13154365092645237 0.36503033455950673; … ; 0.4263545041006734 -0.5315982386942673 … -0.2540309676211236 0.15368331271210753; -0.44849367886257924 0.5613330850890752 … 0.4053508798863282 0.502077218707379], bias = [-0.5384220806179819; -0.19958365459908503; … ; -0.03553346807094657; 0.06414509295085823;;]), layer_4 = (weight = [0.690528405522928 -0.02405022442834273 … 0.475041422390902 -0.18335037298003892; -0.2740896328027027 -0.5459438311720238 … 0.8537003452949838 0.5595088195893292; … ; 0.019812166773349755 -0.4358086031914592 … 0.1332141620890712 -0.10000867458441852; -0.26815819598990726 0.026576532340555216 … -0.7982027708322464 -0.433884187365003], bias = [0.18891524262799614; -0.3818213538393306; … ; 0.1520765530668106; 0.28864266150502105;;]), layer_5 = (weight = [-0.3423112672944701 0.31975984024821724 … -0.9557626352992367 -0.3071705242487095], bias = [0.4310991505982176;;])), v = (layer_1 = (weight = [-0.4643795015901102 0.06266804744881423; 0.5329072823500185 0.42699939115675406; … ; -0.3305282408393707 -0.16200030627884474; -0.1543020048659747 -0.36296363912084284], bias = [0.10152852016349483; -0.25663632352271193; … ; 0.0720594563615432; 0.08082164154610305;;]), layer_2 = (weight = [0.011355845613261799 0.35054731328978467 … -0.10216680951616594 -0.27255839765917517; 0.4794944516270806 -0.5238946478027122 … -0.0583500763793729 0.20650835241325957; … ; 0.3126627905872844 -0.11982414648405333 … 0.34213162021441085 0.3997810609452727; 0.6075278079786129 -0.7353490675392563 … -0.03550486741272148 0.7408285744691443], bias = [0.0025757562306438346; -0.17001352390564164; … ; -0.15073408296918836; 0.10286289528228922;;]), layer_3 = (weight = [0.02965797371464256 0.43584171601240973 … 0.2599847686336007 0.2402906762155112; -0.5156734198500165 -0.15222698965221604 … 0.12119239956215812 0.3077169276813054; … ; -0.0937621834638075 0.259889482175264 … -0.32436419191659577 0.4960848258495951; 0.3149629832584542 -0.48516252654568975 … 0.3390420744744312 0.2607246153509916], bias = [-0.21945512323149624; -0.007412394214723184; … ; -0.3356169958746839; -0.008444139029574456;;]), layer_4 = (weight = [0.2428165132922405 -0.0427523191443664 … 0.05166312082751311 0.08981683315441959; -0.15445947440336422 0.08971936398606596 … 0.08328755454254287 -0.22994777578879072; … ; 0.47962125150369317 0.31603215905047355 … 0.35848065711744076 -0.29108754842540996; 0.6015776433258384 -0.07116361391378155 … -0.3141321481457265 0.2516320716479766], bias = [-0.19566910483662092; -0.06908375390897292; … ; 0.059151818620961374; 0.013482278213789337;;]), layer_5 = (weight = [0.23451565202604846 -0.38917899635412234 … 0.03999241905319297 -0.8705888686473653], bias = [-0.4006478332831508;;])))</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../allen_cahn/">« Allen-Cahn Equation with Sequential Training</a><a class="docs-footer-nextpage" href="../L_shape/">Poisson equation over an L-shaped domain »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Monday 17 October 2022 01:47">Monday 17 October 2022</span>. Using Julia version 1.8.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
