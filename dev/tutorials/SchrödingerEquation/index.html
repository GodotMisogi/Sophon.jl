<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Schrödinger Equation: A PDE System with Resampling · Sophon.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://YichengDWu.github.io/Sophon.jl/tutorials/SchrödingerEquation/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/indigo.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Sophon.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../discontinuous/">Fitting a nonlinear discontinuous function</a></li><li><a class="tocitem" href="../poisson/">1D Multi-scale Poisson&#39;s Equation</a></li><li><a class="tocitem" href="../convection/">1D Convection Equation</a></li><li><a class="tocitem" href="../helmholtz/">2D Helmholtz Equation</a></li><li><a class="tocitem" href="../allen_cahn/">Allen-Cahn Equation with Sequential Training</a></li><li class="is-active"><a class="tocitem" href>Schrödinger Equation: A PDE System with Resampling</a><ul class="internal"><li><a class="tocitem" href="#Customize-Sampling"><span>Customize Sampling</span></a></li></ul></li><li><a class="tocitem" href="../L_shape/">Poisson equation over an L-shaped domain</a></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/YichengDWu/Sophon.jl/blob/main/docs/src/tutorials/SchrödingerEquation.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Schrödinger-equation"><a class="docs-heading-anchor" href="#Schrödinger-equation">Schrödinger equation</a><a id="Schrödinger-equation-1"></a><a class="docs-heading-anchor-permalink" href="#Schrödinger-equation" title="Permalink"></a></h1><p>The nonlinear Shrödinger equation is given by</p><p class="math-container">\[\mathrm{i} \partial_t \psi=-\frac{1}{2} \sigma \partial_{x x} \psi-\beta|\psi|^2 \psi\]</p><p>Let <span>$\sigma=\beta=1, \psi=u+v i$</span>, the equation can be transformed into a system of partial differential equations</p><pre><code class="language-julia hljs">using ModelingToolkit, IntervalSets, Sophon, CairoMakie
using Optimization, OptimizationOptimJL

@parameters x,t
@variables u(..), v(..)
Dₜ = Differential(t)
Dₓ² = Differential(x)^2

eqs=[Dₜ(u(x,t)) ~ -Dₓ²(v(x,t))/2 - (abs2(v(x,t)) + abs2(u(x,t))) * v(x,t),
     Dₜ(v(x,t)) ~  Dₓ²(u(x,t))/2 + (abs2(v(x,t)) + abs2(u(x,t))) * u(x,t)]

bcs = [u(x, 0.0) ~ 2sech(x),
       v(x, 0.0) ~ 0.0,
       u(-5.0, t) ~ u(5.0, t),
       v(-5.0, t) ~ v(5.0, t)]

domains = [x ∈ Interval(-5.0, 5.0),
           t ∈ Interval(0.0, π/2)]

@named pde_system = PDESystem(eqs, bcs, domains, [x,t], [u(x,t),v(x,t)])</code></pre><p class="math-container">\[ \begin{align}
\frac{\mathrm{d}}{\mathrm{d}t} u\left( x, t \right) =&amp;  - \frac{1}{2} \frac{\mathrm{d}^{2}}{\mathrm{d}x^{2}} v\left( x, t \right) - \left( \left|u\left( x, t \right)\right|^{2} + \left|v\left( x, t \right)\right|^{2} \right) v\left( x, t \right) \\
\frac{\mathrm{d}}{\mathrm{d}t} v\left( x, t \right) =&amp; \frac{1}{2} \frac{\mathrm{d}^{2}}{\mathrm{d}x^{2}} u\left( x, t \right) + \left( \left|u\left( x, t \right)\right|^{2} + \left|v\left( x, t \right)\right|^{2} \right) u\left( x, t \right)
\end{align}
 \]</p><pre><code class="language-julia hljs">pinn = PINN(u = Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0),
            v = Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0))

sampler = QuasiRandomSampler(500, (200,200,20,20))
strategy = NonAdaptiveTraining(1,(10,10,1,1))

prob = Sophon.discretize(pde_system, pinn, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [0.24815529584884644 -0.1973361372947693; -0.13231408596038818 -0.3674289584159851; … ; -0.4822831153869629 0.46319669485092163; 0.49760133028030396 -0.47561633586883545], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [0.32443106174468994 0.1664273738861084 … -0.13263486325740814 -0.1136929914355278; 0.06992270797491074 -0.5575175881385803 … 0.515619158744812 0.026167459785938263; … ; 0.05357176437973976 -0.43686267733573914 … -0.576438844203949 -0.08569613844156265; -0.14937767386436462 0.39083245396614075 … -0.5965797901153564 0.22044962644577026], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [-0.5561398267745972 0.3866146206855774 … -0.45756691694259644 0.4399610459804535; 0.5697760581970215 0.10630183666944504 … -0.4263022840023041 0.41300275921821594; … ; -0.3472374975681305 0.3493695557117462 … 0.5169680118560791 -0.4074755311012268; -0.4225037693977356 -0.1252269148826599 … -0.5766283273696899 0.08735981583595276], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [0.07225456088781357 -0.32238587737083435 … -0.4950820803642273 -0.08887311816215515; -0.3249509036540985 -0.08364307135343552 … 0.03678464889526367 0.4207902252674103; … ; -0.38790053129196167 -0.2995684742927551 … 0.3098945617675781 0.6093897223472595; 0.30254414677619934 0.14868533611297607 … 0.5781431794166565 -0.3059577941894531], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [0.49141791462898254 -0.11615456640720367 … 0.49717047810554504 -0.4061621129512787], bias = [0.0;;])), v = (layer_1 = (weight = [-0.40041160583496094 0.4035811424255371; -0.1168212890625 -0.06811445951461792; … ; -0.26544415950775146 0.4224061965942383; 0.1526505947113037 -0.1145477294921875], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [-0.5330926179885864 -0.3107915222644806 … -0.22244004905223846 -0.4167111814022064; 0.36107832193374634 0.29757148027420044 … 0.34829726815223694 0.12519261240959167; … ; -0.12474723160266876 0.2434484213590622 … -0.39334315061569214 -0.0786643698811531; -0.008075021207332611 0.3465883731842041 … 0.5926470160484314 -0.4072133004665375], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [0.5012375712394714 -0.3708612620830536 … 0.4701053500175476 0.0001816251897253096; 0.04531577602028847 0.4477923810482025 … -0.01916101947426796 -0.1838177591562271; … ; 0.4499792456626892 0.14745190739631653 … -0.23586761951446533 -0.23561334609985352; -0.4361169636249542 0.23181696236133575 … 0.49371662735939026 0.611370325088501], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [0.4677355885505676 0.39205798506736755 … 0.08574482798576355 -0.3387052118778229; -0.04425019025802612 -0.553818941116333 … 0.5978752970695496 -0.04248693585395813; … ; 0.31929993629455566 -0.46300384402275085 … -0.23169387876987457 -0.27652159333229065; -0.40660354495048523 -0.40717658400535583 … -0.008492729626595974 -0.13827064633369446], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [0.5477791428565979 0.38019275665283203 … -0.021215399727225304 -0.2907561659812927], bias = [0.0;;])))</code></pre><p>Now we train the neural nets and resample data while training.</p><pre><code class="language-julia hljs">function train(pde_system, prob, sampler, strategy, resample_period = 500, n=10)
     bfgs = BFGS()
     res = Optimization.solve(prob, bfgs; maxiters=2000)

     for i in 1:n
         data = Sophon.sample(pde_system, sampler, strategy)
         prob = remake(prob; u0=res.u, p=data)
         res = Optimization.solve(prob, bfgs; maxiters=resample_period)
     end
     return res
end

res = train(pde_system, prob, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">u: ComponentVector{Float64}(u = (layer_1 = (weight = [0.675857710464357 -0.0999909119588098; -0.42059285574844746 -0.20811584931314306; … ; -1.5563659580483509 0.23865970287278587; 0.39854895024267434 -0.0215545680743514], bias = [0.08790258134494747; -0.0723992186548157; … ; -0.102652063215361; 0.011520174123797099;;]), layer_2 = (weight = [0.26952958837633306 0.2785109334699592 … 0.02870817143657263 -0.5196796461494007; 0.21012215412629656 -0.6156946588414323 … 0.04265382397870308 0.3018069053237054; … ; 0.1884193154479864 -0.36947076683608304 … -0.16835750549397033 0.025874745068883286; -0.27970224891682943 0.41496443108881986 … -0.18488050621633306 0.1143408517671051], bias = [-0.03367520921518031; 0.08653626149534; … ; -0.13488212057426835; 0.08061812514490635;;]), layer_3 = (weight = [-0.7021783487088695 -0.025089855741226474 … -0.5260079901216823 0.33180980865397713; 0.8894443000829212 0.46701458648944133 … -0.17896636316930412 -0.23915346626796052; … ; -0.7916930946543055 0.3776308319752274 … 0.8206074986998814 -0.23170641342411594; -0.5642726724285017 -0.1012206216526723 … -0.8978949672552621 -0.03440880403731836], bias = [0.12590272727472507; 0.37137653380353586; … ; 0.030124047296297307; -0.6498770269038185;;]), layer_4 = (weight = [0.1961526292934865 -0.6730068628740135 … -0.7112941537492341 -0.12821988621291427; -0.07188163709652405 -0.14974847171488873 … -0.011204661715682128 0.6043490851090016; … ; -0.3874716003125025 -0.660736542564098 … 0.5800130276431904 0.10284097825860199; 0.5069360841969085 -0.17152117683307183 … 0.7182985809387032 0.3209993061197067], bias = [0.08576457839586484; 0.1743845982080948; … ; 0.24992782720937168; 0.40413755910505356;;]), layer_5 = (weight = [0.42779353769853806 0.20503698801226725 … 0.9533947673493731 -0.9758614938575405], bias = [0.32420112472596974;;])), v = (layer_1 = (weight = [-0.8606580529521938 0.1789830323462571; -0.45734034902976833 0.044460884187913115; … ; -0.22085784002893263 0.8821259717179454; 0.49314433520701845 -0.2816997664914831], bias = [0.2668420050050919; -0.1250138889446667; … ; -0.46443083091258747; 0.12374114257322606;;]), layer_2 = (weight = [-0.230935831757083 -0.3210639150786245 … -0.18931635047539216 -0.7050250017149606; 0.34494933846752274 0.6526320205622557 … 0.7601106701283133 -0.182062338901149; … ; -0.3891722406293601 0.17110602777202494 … -0.4591634613966633 0.036135264003464534; -0.0016952298978152283 0.3894577739349605 … 1.1357075266412495 -0.5785344888396572], bias = [0.17403763522977045; 0.20938326107039174; … ; -0.3688568906499567; -0.4389897882945693;;]), layer_3 = (weight = [0.6148958139416608 -0.3090040233314486 … 0.3943121034651902 -0.31089101372671235; -0.12411446651192798 0.38991108607640385 … -0.2688752051757913 0.5080914827261733; … ; 0.23893888619319517 0.31475105896990474 … -0.36009019171935863 -0.13389318146233958; -0.32044204681474503 0.12243633780306273 … 0.4910735137710635 0.6041343929829843], bias = [-0.060567656240183364; 0.14821536503440425; … ; 0.23910358575817955; 0.49770457071057816;;]), layer_4 = (weight = [0.4666121675069864 0.5108332840071751 … -0.5309800013696436 -0.751320016376021; -0.008121474688877577 -0.40507210234542085 … 0.6441176255060264 -0.11377669480124315; … ; 0.3132792550637108 -0.35548804908595943 … -0.35015564307773456 -0.35041727549081647; -0.4674985443469216 0.11023456335501626 … 0.4636251609264408 0.2561465258123404], bias = [-0.341992773175476; 0.0493523534635283; … ; -0.10111278930111223; 0.37237300607021273;;]), layer_5 = (weight = [1.251171831733028 -0.14837218222143286 … -0.10818684844683782 -0.41876418749959426], bias = [0.14640445829966334;;])))</code></pre><pre><code class="language-julia hljs">phi = pinn.phi
ps = res.u

xs, ts= [infimum(d.domain):0.01:supremum(d.domain) for d in pde_system.domain]

u = [sum(phi.u(([x,t]), ps.u)) for x in xs, t in ts]
v = [sum(phi.v(([x,t]), ps.v)) for x in xs, t in ts]
ψ = @. sqrt(u^2+ v^2)

axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;u&quot;)
fig, ax1, hm1 = heatmap(ts, xs, u&#39;, axis=axis)
ax2, hm2= heatmap(fig[1, end+1], ts, xs, v&#39;, axis= merge(axis, (; title=&quot;v&quot;)))
display(fig)</code></pre><p><img src="../uv.png" alt/></p><pre><code class="language-julia hljs">axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;ψ&quot;)
fig, ax1, hm1 = heatmap(ts, xs, ψ&#39;, axis=axis, colormap=:jet)
Colorbar(fig[:, end+1], hm1)
display(fig)</code></pre><p><img src="../phi.png" alt/></p><h2 id="Customize-Sampling"><a class="docs-heading-anchor" href="#Customize-Sampling">Customize Sampling</a><a id="Customize-Sampling-1"></a><a class="docs-heading-anchor-permalink" href="#Customize-Sampling" title="Permalink"></a></h2><p>Bascially any sampling method is supportted.</p><pre><code class="language-julia hljs">using StatsBase

data = vec([[x, t] for x in xs, t in ts])
wv = vec(ψ)
new_data = wsample(data, wv, 500)
new_data = reduce(hcat, new_data)
fig, ax = scatter(new_data[2,:], new_data[1,:])</code></pre><p><img src="../data.png" alt/></p><pre><code class="language-julia hljs">prob.p[1] = new_data
prob.p[2] = new_data
prob = remake(prob; u0 = res.u)
# res = Optimization.solve(prob, bfgs; maxiters=1000)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [0.675857710464357 -0.0999909119588098; -0.42059285574844746 -0.20811584931314306; … ; -1.5563659580483509 0.23865970287278587; 0.39854895024267434 -0.0215545680743514], bias = [0.08790258134494747; -0.0723992186548157; … ; -0.102652063215361; 0.011520174123797099;;]), layer_2 = (weight = [0.26952958837633306 0.2785109334699592 … 0.02870817143657263 -0.5196796461494007; 0.21012215412629656 -0.6156946588414323 … 0.04265382397870308 0.3018069053237054; … ; 0.1884193154479864 -0.36947076683608304 … -0.16835750549397033 0.025874745068883286; -0.27970224891682943 0.41496443108881986 … -0.18488050621633306 0.1143408517671051], bias = [-0.03367520921518031; 0.08653626149534; … ; -0.13488212057426835; 0.08061812514490635;;]), layer_3 = (weight = [-0.7021783487088695 -0.025089855741226474 … -0.5260079901216823 0.33180980865397713; 0.8894443000829212 0.46701458648944133 … -0.17896636316930412 -0.23915346626796052; … ; -0.7916930946543055 0.3776308319752274 … 0.8206074986998814 -0.23170641342411594; -0.5642726724285017 -0.1012206216526723 … -0.8978949672552621 -0.03440880403731836], bias = [0.12590272727472507; 0.37137653380353586; … ; 0.030124047296297307; -0.6498770269038185;;]), layer_4 = (weight = [0.1961526292934865 -0.6730068628740135 … -0.7112941537492341 -0.12821988621291427; -0.07188163709652405 -0.14974847171488873 … -0.011204661715682128 0.6043490851090016; … ; -0.3874716003125025 -0.660736542564098 … 0.5800130276431904 0.10284097825860199; 0.5069360841969085 -0.17152117683307183 … 0.7182985809387032 0.3209993061197067], bias = [0.08576457839586484; 0.1743845982080948; … ; 0.24992782720937168; 0.40413755910505356;;]), layer_5 = (weight = [0.42779353769853806 0.20503698801226725 … 0.9533947673493731 -0.9758614938575405], bias = [0.32420112472596974;;])), v = (layer_1 = (weight = [-0.8606580529521938 0.1789830323462571; -0.45734034902976833 0.044460884187913115; … ; -0.22085784002893263 0.8821259717179454; 0.49314433520701845 -0.2816997664914831], bias = [0.2668420050050919; -0.1250138889446667; … ; -0.46443083091258747; 0.12374114257322606;;]), layer_2 = (weight = [-0.230935831757083 -0.3210639150786245 … -0.18931635047539216 -0.7050250017149606; 0.34494933846752274 0.6526320205622557 … 0.7601106701283133 -0.182062338901149; … ; -0.3891722406293601 0.17110602777202494 … -0.4591634613966633 0.036135264003464534; -0.0016952298978152283 0.3894577739349605 … 1.1357075266412495 -0.5785344888396572], bias = [0.17403763522977045; 0.20938326107039174; … ; -0.3688568906499567; -0.4389897882945693;;]), layer_3 = (weight = [0.6148958139416608 -0.3090040233314486 … 0.3943121034651902 -0.31089101372671235; -0.12411446651192798 0.38991108607640385 … -0.2688752051757913 0.5080914827261733; … ; 0.23893888619319517 0.31475105896990474 … -0.36009019171935863 -0.13389318146233958; -0.32044204681474503 0.12243633780306273 … 0.4910735137710635 0.6041343929829843], bias = [-0.060567656240183364; 0.14821536503440425; … ; 0.23910358575817955; 0.49770457071057816;;]), layer_4 = (weight = [0.4666121675069864 0.5108332840071751 … -0.5309800013696436 -0.751320016376021; -0.008121474688877577 -0.40507210234542085 … 0.6441176255060264 -0.11377669480124315; … ; 0.3132792550637108 -0.35548804908595943 … -0.35015564307773456 -0.35041727549081647; -0.4674985443469216 0.11023456335501626 … 0.4636251609264408 0.2561465258123404], bias = [-0.341992773175476; 0.0493523534635283; … ; -0.10111278930111223; 0.37237300607021273;;]), layer_5 = (weight = [1.251171831733028 -0.14837218222143286 … -0.10818684844683782 -0.41876418749959426], bias = [0.14640445829966334;;])))</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../allen_cahn/">« Allen-Cahn Equation with Sequential Training</a><a class="docs-footer-nextpage" href="../L_shape/">Poisson equation over an L-shaped domain »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Tuesday 18 October 2022 19:26">Tuesday 18 October 2022</span>. Using Julia version 1.8.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
