<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Schrödinger Equation: A PDE System with Resampling · Sophon.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://YichengDWu.github.io/Sophon.jl/tutorials/SchrödingerEquation/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/indigo.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Sophon.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../discontinuous/">Fitting a nonlinear discontinuous function</a></li><li><a class="tocitem" href="../poisson/">1D Multi-scale Poisson&#39;s Equation</a></li><li><a class="tocitem" href="../convection/">1D Convection Equation</a></li><li><a class="tocitem" href="../helmholtz/">2D Helmholtz Equation</a></li><li><a class="tocitem" href="../allen_cahn/">Allen-Cahn Equation with Sequential Training</a></li><li class="is-active"><a class="tocitem" href>Schrödinger Equation: A PDE System with Resampling</a><ul class="internal"><li><a class="tocitem" href="#Customize-Sampling"><span>Customize Sampling</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/YichengDWu/Sophon.jl/blob/main/docs/src/tutorials/SchrödingerEquation.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Schrödinger-equation"><a class="docs-heading-anchor" href="#Schrödinger-equation">Schrödinger equation</a><a id="Schrödinger-equation-1"></a><a class="docs-heading-anchor-permalink" href="#Schrödinger-equation" title="Permalink"></a></h1><p>The nonlinear Shrödinger equation is given by</p><p class="math-container">\[\mathrm{i} \partial_t \psi=-\frac{1}{2} \sigma \partial_{x x} \psi-\beta|\psi|^2 \psi\]</p><p>Let <span>$\sigma=\beta=1, \psi=u+v i$</span>, the equation can be transformed into a system of partial differential equations</p><pre><code class="language-julia hljs">using ModelingToolkit, IntervalSets, Sophon, CairoMakie
using Optimization, OptimizationOptimJL

@parameters x,t
@variables u(..), v(..)
Dₜ = Differential(t)
Dₓ² = Differential(x)^2

eqs=[Dₜ(u(x,t)) ~ -Dₓ²(v(x,t))/2 - ((v(x,t))^2 + (u(x,t))^2) * v(x,t),
     Dₜ(v(x,t)) ~  Dₓ²(u(x,t))/2 + ((v(x,t))^2 + (u(x,t))^2) * u(x,t)]

bcs = [u(x, 0.0) ~ 2sech(x),
       v(x, 0.0) ~ 0.0,
       u(-5.0, t) ~ u(5.0, t),
       v(-5.0, t) ~ v(5.0, t)]

domains = [x ∈ Interval(-5.0, 5.0),
           t ∈ Interval(0.0, π/2)]

@named pde_system = PDESystem(eqs, bcs, domains, [x,t], [u(x,t),v(x,t)])</code></pre><p class="math-container">\[ \begin{align}
\mathrm{\frac{d}{d t}}\left( u\left( x, t \right) \right) =&amp;  - \frac{1}{2} \frac{d(d / (d * x))(v(x, t))}{dx} - \left( \left( u\left( x, t \right) \right)^{2} + \left( v\left( x, t \right) \right)^{2} \right) v\left( x, t \right) \\
\mathrm{\frac{d}{d t}}\left( v\left( x, t \right) \right) =&amp; \frac{1}{2} \frac{d(d / (d * x))(u(x, t))}{dx} + \left( \left( u\left( x, t \right) \right)^{2} + \left( v\left( x, t \right) \right)^{2} \right) u\left( x, t \right)
\end{align}
 \]</p><pre><code class="language-julia hljs">pinn = PINN(u= Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0),
            v= Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0))

sampler = QuasiRandomSampler(2000, (500,500,20,20))
strategy = NonAdaptiveTraining(1,(10,10,1,1))

prob = Sophon.discretize(pde_system, pinn, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [0.09850096702575684 -0.23513281345367432; -0.20728379487991333 -0.028844714164733887; … ; -0.021018922328948975 -0.2128291130065918; 0.26241815090179443 0.1668407917022705], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [0.31050658226013184 -0.3093385696411133 … -0.3932655453681946 -0.34775763750076294; 0.15363548696041107 0.04924984648823738 … -0.526023805141449 -0.5663459897041321; … ; -0.47746363282203674 0.05026484280824661 … -0.16715912520885468 -0.46240511536598206; -0.056604351848363876 -0.5784233808517456 … 0.4749259352684021 0.14026902616024017], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [-0.3057875335216522 0.5172999501228333 … -0.47260940074920654 0.2510811388492584; 0.4072389304637909 -0.2198375165462494 … 0.1320047229528427 0.22878612577915192; … ; 0.43079379200935364 0.028733644634485245 … -0.5707222819328308 -0.30343255400657654; 0.34755074977874756 -0.236495703458786 … 0.26914116740226746 -0.4680343270301819], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [0.47969308495521545 0.4735378921031952 … 0.39902228116989136 -0.39409366250038147; -0.4687938094139099 0.0176820307970047 … 0.1951749622821808 0.05751459673047066; … ; 0.3457239866256714 0.3075281083583832 … -0.5801405906677246 -0.03258770704269409; 0.0019302786095067859 -0.3609756827354431 … 0.05795004218816757 -0.270363986492157], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [0.5544390678405762 0.3073856830596924 … -0.5285791754722595 -0.20704782009124756], bias = [0.0;;])), v = (layer_1 = (weight = [0.10035669803619385 0.2833026647567749; 0.48000842332839966 -0.32916533946990967; … ; 0.012997627258300781 0.36342549324035645; 0.48190146684646606 -0.02373605966567993], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [-0.11870557069778442 0.45512688159942627 … -0.1991470605134964 -0.5167972445487976; -0.1507137268781662 0.14797291159629822 … 0.11680740863084793 -0.38912540674209595; … ; 0.017833871766924858 0.12064716219902039 … -0.4586837589740753 0.1630866527557373; 0.2636681795120239 0.07204519212245941 … -0.112775519490242 -0.26940104365348816], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [0.09961739927530289 0.383056640625 … 0.12132825702428818 0.28185638785362244; 0.03215627372264862 0.40266063809394836 … 0.3774336576461792 -0.038475487381219864; … ; 0.3077605366706848 -0.0777488648891449 … 0.04650101438164711 -0.03593747690320015; 0.48841050267219543 -0.22586683928966522 … -0.3545532524585724 0.1700742542743683], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [0.013369015417993069 -0.07963169366121292 … 0.4658537209033966 0.2900567352771759; -0.2844100892543793 -0.38183024525642395 … 0.16428159177303314 -0.048889078199863434; … ; -0.25984081625938416 0.14576618373394012 … 0.5432567596435547 0.08829809725284576; -0.6037062406539917 0.47784698009490967 … -0.35771965980529785 0.46826061606407166], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [0.4155028760433197 -0.1779758185148239 … 0.3941274583339691 0.21106475591659546], bias = [0.0;;])))</code></pre><p>Now we train the neural nets and resample data while training.</p><pre><code class="language-julia hljs">function train(pde_system, prob, sampler, strategy, resample_period = 500, n=10)
     bfgs = BFGS()
     res = Optimization.solve(prob, bfgs; maxiters=2000)

     for i in 1:n
         data = Sophon.sample(pde_system, sampler, strategy)
         prob = remake(prob; u0=res.u, p=data)
         res = Optimization.solve(prob, bfgs; maxiters=resample_period)
     end
     return res
end

res = train(pde_system, prob, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">u: ComponentVector{Float64}(u = (layer_1 = (weight = [0.2690634466540246 -0.3304270018604482; -0.29477205109855786 0.22923665341932714; … ; 0.35557745890316667 0.10599405867766744; 0.40565910817166645 0.17808683874646433], bias = [0.24378515554530386; 0.05931425372199573; … ; -0.26327458299919687; 0.4389892630967434;;]), layer_2 = (weight = [0.40685003579089474 -0.1173651383912047 … -0.5358474893340588 -0.6727649752058704; 0.19810518457531553 -0.07398864473822986 … -0.27613952888664717 -0.5318934866749359; … ; -0.465560540571659 -0.051516265776456266 … -0.09712919285883467 -0.49165241909623314; -0.4002470651797715 -0.3749819648647102 … 0.45983594281399026 0.11234370334238593], bias = [0.4092959393899078; -0.08864544601893844; … ; -0.2518056103935834; -0.25315774635176624;;]), layer_3 = (weight = [-0.7399146996352368 0.3380866781640199 … -0.6566538665884473 0.13606076733267414; 0.07512240117909612 -0.3866813152671451 … 0.47342174819598315 0.36310221323859476; … ; 0.7895016075193376 -0.19805234294446 … -0.4899355159374048 -0.2889105695933983; 0.4266149273576657 -0.4001453356028875 … 0.09375274072549902 -0.5874315777437301], bias = [0.26470230526329624; -0.009905689727608469; … ; -0.03220695923538297; -0.1592831099264988;;]), layer_4 = (weight = [0.552946977596437 0.5069363370865037 … -0.012982308401384698 -0.5317721372692027; -0.4013465052913493 0.18031300509333992 … 0.0591174761145797 0.19342185727750724; … ; 0.46342380227156077 0.5901724670774602 … -0.22391078901825195 -0.45324991595765884; -0.08349814071831381 -0.25998336421128954 … 0.10930242102972465 -0.5224148874444267], bias = [-0.2738361141830361; -0.0072320306303355324; … ; 0.4066719481182489; -0.23119366274893788;;]), layer_5 = (weight = [0.525856751624385 0.3245648289192688 … -0.19202293807676374 -0.21276343007358006], bias = [0.024966870778524303;;])), v = (layer_1 = (weight = [0.45625450504548914 0.6152107857885508; 0.8588806177133934 -0.06546577704961236; … ; -0.07014982104904727 0.045430741449786614; 0.8393042818496225 -0.07833886461905969], bias = [-0.3979046520868437; 0.10597204554125217; … ; 0.03737603940216509; 0.20289459549651395;;]), layer_2 = (weight = [0.13648138605306365 0.3112116483503221 … 0.23326631770477316 -0.5483227077719756; -0.2801207630449165 0.05676088833323552 … 0.07564145305549363 -0.35912673229418773; … ; -0.3928497830884067 0.32704859212864973 … -0.7270275503420717 0.21144937584145476; 0.44144991402265776 0.02320026659939088 … 0.0482605279183631 -0.23315574258219066], bias = [0.050101879916007896; -0.08789015103248052; … ; 0.24481849151728977; -0.40481338021861774;;]), layer_3 = (weight = [-0.3332630922406024 0.08475801751107337 … -0.12152274629260737 0.28084281048718895; -0.14893582301218503 0.6229885708252011 … 0.08007047720162498 -0.10437042879447801; … ; 0.39775287158752176 -0.13840591999138047 … -0.135260750573799 -0.0835540421973115; 0.3077096598547345 -0.4771511833978855 … -0.6199105599192195 0.35951687373340124], bias = [0.2690568534165687; 0.088357295852632; … ; 0.14091081534844252; 0.26683066419858803;;]), layer_4 = (weight = [-0.16011520754266595 -0.38537828082105463 … 0.8987219812971329 0.2523155841371435; -0.16443982771576246 -0.3652434505534761 … 0.22712305585016573 0.13772748627476006; … ; -0.26408840887827645 0.12887173972792357 … 0.5746229523350437 -0.21330855407779564; -0.5281860887258534 0.9392793100357587 … -0.29720826190888855 0.29291896914309196], bias = [-0.22906229167010514; -0.1803183460739366; … ; -0.023151091900756746; -0.17656679722936464;;]), layer_5 = (weight = [0.6540184813763026 0.4664680440669497 … 0.9613600984319567 0.3766084070854206], bias = [0.12323922544779875;;])))</code></pre><pre><code class="language-julia hljs">phi = pinn.phi
ps = res.u

xs, ts= [infimum(d.domain):0.01:supremum(d.domain) for d in pde_system.domain]

u = [sum(phi.u(([x,t]), ps.u)) for x in xs, t in ts]
v = [sum(phi.v(([x,t]), ps.v)) for x in xs, t in ts]
ψ = @. sqrt(u^2+ v^2)

axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;u&quot;)
fig, ax1, hm1 = CairoMakie.heatmap(ts, xs, u&#39;, axis=axis)
ax2, hm2= CairoMakie.heatmap(fig[1, end+1], ts, xs, v&#39;, axis= merge(axis, (; title=&quot;v&quot;)))
display(fig)</code></pre><p><img src="../uv.png" alt/></p><pre><code class="language-julia hljs">axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;ψ&quot;)
fig, ax1, hm1 = CairoMakie.heatmap(ts, xs, ψ&#39;, axis=axis)
Colorbar(fig[:, end+1], hm1)
display(fig)</code></pre><p><img src="../phi.png" alt/></p><h2 id="Customize-Sampling"><a class="docs-heading-anchor" href="#Customize-Sampling">Customize Sampling</a><a id="Customize-Sampling-1"></a><a class="docs-heading-anchor-permalink" href="#Customize-Sampling" title="Permalink"></a></h2><p>Bascially any sampling method is supportted.</p><pre><code class="language-julia hljs">using StatsBase

data = vec([[x, t] for x in xs, t in ts])
wv = vec(ψ)
new_data = wsample(data, wv, 2000)
new_data = reduce(hcat, new_data)
fig, ax = scatter(new_data[2,:], new_data[1,:])</code></pre><p><img src="../data.png" alt/></p><pre><code class="language-julia hljs">prob.p[1] = new_data
prob.p[2] = new_data
prob = remake(prob; u0 = res.u)
# res = Optimization.solve(prob, bfgs; maxiters=1000)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [0.2690634466540246 -0.3304270018604482; -0.29477205109855786 0.22923665341932714; … ; 0.35557745890316667 0.10599405867766744; 0.40565910817166645 0.17808683874646433], bias = [0.24378515554530386; 0.05931425372199573; … ; -0.26327458299919687; 0.4389892630967434;;]), layer_2 = (weight = [0.40685003579089474 -0.1173651383912047 … -0.5358474893340588 -0.6727649752058704; 0.19810518457531553 -0.07398864473822986 … -0.27613952888664717 -0.5318934866749359; … ; -0.465560540571659 -0.051516265776456266 … -0.09712919285883467 -0.49165241909623314; -0.4002470651797715 -0.3749819648647102 … 0.45983594281399026 0.11234370334238593], bias = [0.4092959393899078; -0.08864544601893844; … ; -0.2518056103935834; -0.25315774635176624;;]), layer_3 = (weight = [-0.7399146996352368 0.3380866781640199 … -0.6566538665884473 0.13606076733267414; 0.07512240117909612 -0.3866813152671451 … 0.47342174819598315 0.36310221323859476; … ; 0.7895016075193376 -0.19805234294446 … -0.4899355159374048 -0.2889105695933983; 0.4266149273576657 -0.4001453356028875 … 0.09375274072549902 -0.5874315777437301], bias = [0.26470230526329624; -0.009905689727608469; … ; -0.03220695923538297; -0.1592831099264988;;]), layer_4 = (weight = [0.552946977596437 0.5069363370865037 … -0.012982308401384698 -0.5317721372692027; -0.4013465052913493 0.18031300509333992 … 0.0591174761145797 0.19342185727750724; … ; 0.46342380227156077 0.5901724670774602 … -0.22391078901825195 -0.45324991595765884; -0.08349814071831381 -0.25998336421128954 … 0.10930242102972465 -0.5224148874444267], bias = [-0.2738361141830361; -0.0072320306303355324; … ; 0.4066719481182489; -0.23119366274893788;;]), layer_5 = (weight = [0.525856751624385 0.3245648289192688 … -0.19202293807676374 -0.21276343007358006], bias = [0.024966870778524303;;])), v = (layer_1 = (weight = [0.45625450504548914 0.6152107857885508; 0.8588806177133934 -0.06546577704961236; … ; -0.07014982104904727 0.045430741449786614; 0.8393042818496225 -0.07833886461905969], bias = [-0.3979046520868437; 0.10597204554125217; … ; 0.03737603940216509; 0.20289459549651395;;]), layer_2 = (weight = [0.13648138605306365 0.3112116483503221 … 0.23326631770477316 -0.5483227077719756; -0.2801207630449165 0.05676088833323552 … 0.07564145305549363 -0.35912673229418773; … ; -0.3928497830884067 0.32704859212864973 … -0.7270275503420717 0.21144937584145476; 0.44144991402265776 0.02320026659939088 … 0.0482605279183631 -0.23315574258219066], bias = [0.050101879916007896; -0.08789015103248052; … ; 0.24481849151728977; -0.40481338021861774;;]), layer_3 = (weight = [-0.3332630922406024 0.08475801751107337 … -0.12152274629260737 0.28084281048718895; -0.14893582301218503 0.6229885708252011 … 0.08007047720162498 -0.10437042879447801; … ; 0.39775287158752176 -0.13840591999138047 … -0.135260750573799 -0.0835540421973115; 0.3077096598547345 -0.4771511833978855 … -0.6199105599192195 0.35951687373340124], bias = [0.2690568534165687; 0.088357295852632; … ; 0.14091081534844252; 0.26683066419858803;;]), layer_4 = (weight = [-0.16011520754266595 -0.38537828082105463 … 0.8987219812971329 0.2523155841371435; -0.16443982771576246 -0.3652434505534761 … 0.22712305585016573 0.13772748627476006; … ; -0.26408840887827645 0.12887173972792357 … 0.5746229523350437 -0.21330855407779564; -0.5281860887258534 0.9392793100357587 … -0.29720826190888855 0.29291896914309196], bias = [-0.22906229167010514; -0.1803183460739366; … ; -0.023151091900756746; -0.17656679722936464;;]), layer_5 = (weight = [0.6540184813763026 0.4664680440669497 … 0.9613600984319567 0.3766084070854206], bias = [0.12323922544779875;;])))</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../allen_cahn/">« Allen-Cahn Equation with Sequential Training</a><a class="docs-footer-nextpage" href="../../references/">References »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Wednesday 5 October 2022 03:12">Wednesday 5 October 2022</span>. Using Julia version 1.8.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
