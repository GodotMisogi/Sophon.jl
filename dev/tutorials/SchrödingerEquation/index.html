<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Schrödinger Equation: A PDE System with Resampling · Sophon.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://YichengDWu.github.io/Sophon.jl/tutorials/SchrödingerEquation/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/indigo.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Sophon.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../discontinuous/">Fitting a nonlinear discontinuous function</a></li><li><a class="tocitem" href="../poisson/">1D Multi-scale Poisson&#39;s Equation</a></li><li><a class="tocitem" href="../convection/">1D Convection Equation</a></li><li><a class="tocitem" href="../helmholtz/">2D Helmholtz Equation</a></li><li><a class="tocitem" href="../allen_cahn/">Allen-Cahn Equation with Sequential Training</a></li><li class="is-active"><a class="tocitem" href>Schrödinger Equation: A PDE System with Resampling</a><ul class="internal"><li><a class="tocitem" href="#Customize-Sampling"><span>Customize Sampling</span></a></li></ul></li><li><a class="tocitem" href="../L_shape/">Poisson equation over an L-shaped domain</a></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Schrödinger Equation: A PDE System with Resampling</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/YichengDWu/Sophon.jl/blob/main/docs/src/tutorials/SchrödingerEquation.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Schrödinger-equation"><a class="docs-heading-anchor" href="#Schrödinger-equation">Schrödinger equation</a><a id="Schrödinger-equation-1"></a><a class="docs-heading-anchor-permalink" href="#Schrödinger-equation" title="Permalink"></a></h1><p>The nonlinear Shrödinger equation is given by</p><p class="math-container">\[\mathrm{i} \partial_t \psi=-\frac{1}{2} \sigma \partial_{x x} \psi-\beta|\psi|^2 \psi\]</p><p>Let <span>$\sigma=\beta=1, \psi=u+v i$</span>, the equation can be transformed into a system of partial differential equations</p><pre><code class="language-julia hljs">using ModelingToolkit, IntervalSets, Sophon, CairoMakie
using Optimization, OptimizationOptimJL

@parameters x,t
@variables u(..), v(..)
Dₜ = Differential(t)
Dₓ² = Differential(x)^2

eqs=[Dₜ(u(x,t)) ~ -Dₓ²(v(x,t))/2 - (abs2(v(x,t)) + abs2(u(x,t))) * v(x,t),
     Dₜ(v(x,t)) ~  Dₓ²(u(x,t))/2 + (abs2(v(x,t)) + abs2(u(x,t))) * u(x,t)]

bcs = [u(x, 0.0) ~ 2sech(x),
       v(x, 0.0) ~ 0.0,
       u(-5.0, t) ~ u(5.0, t),
       v(-5.0, t) ~ v(5.0, t)]

domains = [x ∈ Interval(-5.0, 5.0),
           t ∈ Interval(0.0, π/2)]

@named pde_system = PDESystem(eqs, bcs, domains, [x,t], [u(x,t),v(x,t)])</code></pre><p class="math-container">\[ \begin{align}
\frac{\mathrm{d}}{\mathrm{d}t} u\left( x, t \right) =&amp;  - \frac{1}{2} \frac{\mathrm{d}^{2}}{\mathrm{d}x^{2}} v\left( x, t \right) - \left( \left|u\left( x, t \right)\right|^{2} + \left|v\left( x, t \right)\right|^{2} \right) v\left( x, t \right) \\
\frac{\mathrm{d}}{\mathrm{d}t} v\left( x, t \right) =&amp; \frac{1}{2} \frac{\mathrm{d}^{2}}{\mathrm{d}x^{2}} u\left( x, t \right) + \left( \left|u\left( x, t \right)\right|^{2} + \left|v\left( x, t \right)\right|^{2} \right) u\left( x, t \right)
\end{align}
 \]</p><pre><code class="language-julia hljs">pinn = PINN(u = Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0),
            v = Siren(2,1; hidden_dims=16,num_layers=4, omega = 1.0))

sampler = QuasiRandomSampler(500, (200,200,20,20))
strategy = NonAdaptiveTraining(1,(10,10,1,1))

prob = Sophon.discretize(pde_system, pinn, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [-0.05925452709197998 -0.3129633069038391; 0.3728640675544739 -0.3176182508468628; … ; -0.34516382217407227 0.055818259716033936; 0.08327221870422363 -0.4797871708869934], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [0.42526984214782715 -0.2709416449069977 … 0.10285687446594238 -0.015731822699308395; -0.4161098897457123 -0.028362875804305077 … -0.23403164744377136 -0.32730481028556824; … ; 0.41880854964256287 0.34808650612831116 … -0.37275993824005127 -0.38039082288742065; 0.42374229431152344 0.4530029296875 … 0.5947044491767883 -0.359072208404541], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [-0.44660618901252747 -0.014858225360512733 … 0.03686969354748726 -0.5635388493537903; -0.5235857367515564 0.552227795124054 … 0.3506196141242981 -0.44553229212760925; … ; 0.15898233652114868 0.6108474135398865 … -0.11556734889745712 0.38545405864715576; -0.13823479413986206 0.5187307596206665 … 0.56680828332901 -0.3919576108455658], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [0.35380667448043823 -0.12193817645311356 … 0.5440338850021362 -0.2232964187860489; -0.418720006942749 0.4486258327960968 … -0.2248220592737198 0.06580963730812073; … ; 0.595949649810791 0.544879138469696 … -0.03072933293879032 -0.3547061085700989; 0.06440562009811401 -0.3172406554222107 … 0.06212092563509941 -0.009157763794064522], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [0.5229343175888062 -0.4877161979675293 … -0.39572814106941223 0.556144118309021], bias = [0.0;;])), v = (layer_1 = (weight = [-0.4379205107688904 0.08778548240661621; 0.42995506525039673 -0.08574765920639038; … ; 0.2492222785949707 -0.18198853731155396; -0.11787861585617065 0.04894113540649414], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = [0.549406886100769 -0.016586802899837494 … -0.227247416973114 0.24848969280719757; -0.3567965626716614 0.11879587173461914 … 0.10621080547571182 -0.029560375958681107; … ; 0.08053945749998093 0.5721805095672607 … -0.45290571451187134 0.3150448799133301; -0.43585512042045593 0.4006030559539795 … 0.05746743828058243 -0.37693876028060913], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = [0.09726649522781372 0.03590608760714531 … 0.35117530822753906 0.19234319031238556; 0.23092292249202728 -0.4751991033554077 … -0.15158279240131378 0.6103252172470093; … ; -0.16608279943466187 0.30544576048851013 … 0.0217895470559597 0.49477243423461914; 0.039262138307094574 -0.2153017669916153 … -0.23447272181510925 -0.5863338708877563], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = [0.13451440632343292 0.42996346950531006 … 0.13721118867397308 -0.5932943224906921; 0.348095566034317 0.48125946521759033 … -0.284633606672287 0.14804986119270325; … ; 0.1990334689617157 0.14291894435882568 … 0.504301130771637 -0.046957921236753464; 0.307599276304245 0.2269858568906784 … 0.5429824590682983 0.13973495364189148], bias = [0.0; 0.0; … ; 0.0; 0.0;;]), layer_5 = (weight = [-0.5188012719154358 -0.3397926986217499 … 0.4435628056526184 0.2615607976913452], bias = [0.0;;])))</code></pre><p>Now we train the neural nets and resample data while training.</p><pre><code class="language-julia hljs">function train(pde_system, prob, sampler, strategy, resample_period = 500, n=10)
     bfgs = BFGS()
     res = Optimization.solve(prob, bfgs; maxiters=2000)

     for i in 1:n
         data = Sophon.sample(pde_system, sampler, strategy)
         prob = remake(prob; u0=res.u, p=data)
         res = Optimization.solve(prob, bfgs; maxiters=resample_period)
     end
     return res
end

res = train(pde_system, prob, sampler, strategy)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">u: ComponentVector{Float64}(u = (layer_1 = (weight = [-0.03901686240293414 0.17542491428164664; 0.3796511862966699 -0.6149350216080387; … ; -0.9589708411015337 -0.198848493772692; 0.05864745596191071 -0.28227448527467397], bias = [0.11204329347436195; 0.37595586750167503; … ; 0.6748360360776166; -0.21903074213862758;;]), layer_2 = (weight = [0.3908219754831982 -0.18850169168219053 … -0.24245907977814896 -0.06070239542759359; -0.4297365426621828 -0.005223415152543492 … -0.1440840977788014 -0.1546246229231271; … ; 0.503089058168511 0.2831182281948872 … -0.2919939569429559 -0.05007681635560627; 0.5206278482907052 0.40682579697059174 … 0.4573794678214263 -0.3336595730491515], bias = [-0.1944678652038581; -0.037021473774619715; … ; -0.1686299645626508; 0.029143642933728686;;]), layer_3 = (weight = [-0.47788813960872395 0.15110991155793724 … 0.12380026801303104 -0.806222178450046; -0.6448772834999759 0.5747394767527082 … 0.27548093273190255 -0.5920336356942483; … ; 0.11688425748089547 0.6132366253837856 … -0.002967307016210057 0.5793728034605302; -0.12135061967291566 0.3719205854034034 … 0.591360899990382 -0.28473152307927013], bias = [-0.24827470428129575; 0.22312822763617468; … ; 0.03371075626272278; 0.08002062400189713;;]), layer_4 = (weight = [0.529336575449055 -0.16095227582591462 … 0.7571343289865943 -0.04964207065952692; -0.5637047559689546 0.1898915121914655 … -0.13755340024091398 -0.011800257399572966; … ; 0.524162496233427 0.5345994635853231 … -0.08865401660457208 -0.5310636330853223; -0.08452346467895488 -0.5486816468151934 … -0.002454639021096692 -0.18419744726514617], bias = [0.14168492434788435; -0.3406031832029808; … ; 0.38403188060679677; 0.008633677247673844;;]), layer_5 = (weight = [0.8544739844412867 -0.5624036317567026 … -0.8447196342218105 0.20268882099077068], bias = [-0.11179833204780422;;])), v = (layer_1 = (weight = [-0.9489212276726914 0.6407463505866665; -0.10001974045210997 0.032462304322894764; … ; 0.33186766521793504 0.21314840090945508; -0.37301686181597943 0.3517341976122266], bias = [-0.24301574186800545; -0.40560592962374614; … ; -0.25855435917528624; -0.13176083599714214;;]), layer_2 = (weight = [0.0706564178515539 0.10107429225968528 … 0.11640929832900596 -0.03481539264140056; -0.360364518386535 0.22450217766317887 … 0.1784371710363527 -0.17675376248608016; … ; 0.054587903007245336 0.5509263592403567 … -0.662437776829914 0.48311785322450457; -0.1303121343933041 0.20311189292916165 … 0.3455776979786699 -0.6888785002926116], bias = [0.05959368002491929; -0.16323300387131393; … ; 0.13611625334809357; 0.198185051337078;;]), layer_3 = (weight = [0.08085606918132172 0.07610073451171123 … 0.30276353609269846 0.496346501406913; 0.06197752206267026 -0.5628180008887831 … -0.4133870095366989 0.5163913109209436; … ; -0.23119825745213643 -0.12456138433262573 … 0.10922795492237299 0.32585147925571634; -0.2611295130722111 -0.008654821082893378 … 0.0057930157096469665 -0.8130047250571842], bias = [0.16657275561477308; -0.1050673570673982; … ; -0.1782638740912175; -0.220493856173654;;]), layer_4 = (weight = [0.06505541614483674 0.4737034127429859 … -0.13798104165794844 0.6175249608048008; 0.357314904720463 0.7743530460993507 … -0.2785728932822318 0.4990435274361197; … ; -0.06596058220156524 0.2183076265197269 … 0.25152830413071514 -0.07319214349995973; 0.3278583638601326 0.16081396777116985 … 0.36218162480778854 0.4075606894457796], bias = [0.10872366771414756; 0.048774274430441494; … ; 0.22133753192911748; 0.03931524386856686;;]), layer_5 = (weight = [-0.7339582925291668 -0.7617121102671357 … 0.9068643782450825 0.20665211743077147], bias = [0.07898283669823394;;])))</code></pre><pre><code class="language-julia hljs">phi = pinn.phi
ps = res.u

xs, ts= [infimum(d.domain):0.01:supremum(d.domain) for d in pde_system.domain]

u = [sum(phi.u(([x,t]), ps.u)) for x in xs, t in ts]
v = [sum(phi.v(([x,t]), ps.v)) for x in xs, t in ts]
ψ = @. sqrt(u^2+ v^2)

axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;u&quot;)
fig, ax1, hm1 = heatmap(ts, xs, u&#39;, axis=axis)
ax2, hm2= heatmap(fig[1, end+1], ts, xs, v&#39;, axis= merge(axis, (; title=&quot;v&quot;)))
display(fig)</code></pre><p><img src="../uv.png" alt/></p><pre><code class="language-julia hljs">axis = (xlabel=&quot;t&quot;, ylabel=&quot;x&quot;, title=&quot;ψ&quot;)
fig, ax1, hm1 = heatmap(ts, xs, ψ&#39;, axis=axis, colormap=:jet)
Colorbar(fig[:, end+1], hm1)
display(fig)</code></pre><p><img src="../phi.png" alt/></p><h2 id="Customize-Sampling"><a class="docs-heading-anchor" href="#Customize-Sampling">Customize Sampling</a><a id="Customize-Sampling-1"></a><a class="docs-heading-anchor-permalink" href="#Customize-Sampling" title="Permalink"></a></h2><p>Bascially any sampling method is supportted.</p><pre><code class="language-julia hljs">using StatsBase

data = vec([[x, t] for x in xs, t in ts])
wv = vec(ψ)
new_data = wsample(data, wv, 500)
new_data = reduce(hcat, new_data)
fig, ax = scatter(new_data[2,:], new_data[1,:])</code></pre><p><img src="../data.png" alt/></p><pre><code class="language-julia hljs">prob.p[1] = new_data
prob.p[2] = new_data
prob = remake(prob; u0 = res.u)
# res = Optimization.solve(prob, bfgs; maxiters=1000)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(u = (layer_1 = (weight = [-0.03901686240293414 0.17542491428164664; 0.3796511862966699 -0.6149350216080387; … ; -0.9589708411015337 -0.198848493772692; 0.05864745596191071 -0.28227448527467397], bias = [0.11204329347436195; 0.37595586750167503; … ; 0.6748360360776166; -0.21903074213862758;;]), layer_2 = (weight = [0.3908219754831982 -0.18850169168219053 … -0.24245907977814896 -0.06070239542759359; -0.4297365426621828 -0.005223415152543492 … -0.1440840977788014 -0.1546246229231271; … ; 0.503089058168511 0.2831182281948872 … -0.2919939569429559 -0.05007681635560627; 0.5206278482907052 0.40682579697059174 … 0.4573794678214263 -0.3336595730491515], bias = [-0.1944678652038581; -0.037021473774619715; … ; -0.1686299645626508; 0.029143642933728686;;]), layer_3 = (weight = [-0.47788813960872395 0.15110991155793724 … 0.12380026801303104 -0.806222178450046; -0.6448772834999759 0.5747394767527082 … 0.27548093273190255 -0.5920336356942483; … ; 0.11688425748089547 0.6132366253837856 … -0.002967307016210057 0.5793728034605302; -0.12135061967291566 0.3719205854034034 … 0.591360899990382 -0.28473152307927013], bias = [-0.24827470428129575; 0.22312822763617468; … ; 0.03371075626272278; 0.08002062400189713;;]), layer_4 = (weight = [0.529336575449055 -0.16095227582591462 … 0.7571343289865943 -0.04964207065952692; -0.5637047559689546 0.1898915121914655 … -0.13755340024091398 -0.011800257399572966; … ; 0.524162496233427 0.5345994635853231 … -0.08865401660457208 -0.5310636330853223; -0.08452346467895488 -0.5486816468151934 … -0.002454639021096692 -0.18419744726514617], bias = [0.14168492434788435; -0.3406031832029808; … ; 0.38403188060679677; 0.008633677247673844;;]), layer_5 = (weight = [0.8544739844412867 -0.5624036317567026 … -0.8447196342218105 0.20268882099077068], bias = [-0.11179833204780422;;])), v = (layer_1 = (weight = [-0.9489212276726914 0.6407463505866665; -0.10001974045210997 0.032462304322894764; … ; 0.33186766521793504 0.21314840090945508; -0.37301686181597943 0.3517341976122266], bias = [-0.24301574186800545; -0.40560592962374614; … ; -0.25855435917528624; -0.13176083599714214;;]), layer_2 = (weight = [0.0706564178515539 0.10107429225968528 … 0.11640929832900596 -0.03481539264140056; -0.360364518386535 0.22450217766317887 … 0.1784371710363527 -0.17675376248608016; … ; 0.054587903007245336 0.5509263592403567 … -0.662437776829914 0.48311785322450457; -0.1303121343933041 0.20311189292916165 … 0.3455776979786699 -0.6888785002926116], bias = [0.05959368002491929; -0.16323300387131393; … ; 0.13611625334809357; 0.198185051337078;;]), layer_3 = (weight = [0.08085606918132172 0.07610073451171123 … 0.30276353609269846 0.496346501406913; 0.06197752206267026 -0.5628180008887831 … -0.4133870095366989 0.5163913109209436; … ; -0.23119825745213643 -0.12456138433262573 … 0.10922795492237299 0.32585147925571634; -0.2611295130722111 -0.008654821082893378 … 0.0057930157096469665 -0.8130047250571842], bias = [0.16657275561477308; -0.1050673570673982; … ; -0.1782638740912175; -0.220493856173654;;]), layer_4 = (weight = [0.06505541614483674 0.4737034127429859 … -0.13798104165794844 0.6175249608048008; 0.357314904720463 0.7743530460993507 … -0.2785728932822318 0.4990435274361197; … ; -0.06596058220156524 0.2183076265197269 … 0.25152830413071514 -0.07319214349995973; 0.3278583638601326 0.16081396777116985 … 0.36218162480778854 0.4075606894457796], bias = [0.10872366771414756; 0.048774274430441494; … ; 0.22133753192911748; 0.03931524386856686;;]), layer_5 = (weight = [-0.7339582925291668 -0.7617121102671357 … 0.9068643782450825 0.20665211743077147], bias = [0.07898283669823394;;])))</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../allen_cahn/">« Allen-Cahn Equation with Sequential Training</a><a class="docs-footer-nextpage" href="../L_shape/">Poisson equation over an L-shaped domain »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Sunday 16 October 2022 03:53">Sunday 16 October 2022</span>. Using Julia version 1.8.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
